<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Benachrichtigung einrichten | Terminmarktplatz</title>
  <meta name="description" content="Richte deinen Termin-Alarm ein und erhalte Benachrichtigungen per E-Mail." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/" />

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: #e8ecff;
      --muted: rgba(232,236,255,0.70);
      --brand: #6f53ff;
      --brand2:#a78bfa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 26px;
      --max: 980px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(111,83,255,0.35), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,0.25), transparent 55%),
        radial-gradient(700px 420px at 40% 100%, rgba(111,83,255,0.18), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
      min-height:100vh;
    }

    a{ color: #b9adff; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 10px 4px 22px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:0.2px;
    }

    .logoImg{
      width:44px;
      height:44px;
      border-radius: 14px;
      object-fit: cover;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      display:block;
    }

    .pill{
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap: 18px;
      align-items:stretch;
      margin: 10px 0 18px;
    }

    @media (max-width: 860px){
      .hero{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--card2), var(--card));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card .inner{
      padding: 22px 22px;
    }

    h1{
      margin: 0 0 10px;
      font-size: clamp(22px, 3vw, 30px);
      letter-spacing: -0.2px;
    }

    .sub{
      color: var(--muted);
      margin: 0 0 14px;
      font-size: 14px;
    }

    .steps{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }
    @media (max-width: 640px){
      .steps{ grid-template-columns: 1fr; }
    }
    .step{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      padding: 12px 12px;
      min-height: 76px;
    }
    .step b{ display:block; margin-bottom: 4px; }
    .step span{ color: var(--muted); font-size: 13px; }

    .infoBox{
      border-radius: var(--radius);
      border: 1px solid rgba(245,158,11,0.25);
      background: rgba(245,158,11,0.10);
      padding: 14px;
      color: rgba(255,255,255,0.92);
    }
    .infoBox b{ color: #ffd699; }
    .infoBox small{ display:block; color: rgba(232,236,255,0.75); margin-top: 6px; }

    .statsBox{
      margin-top: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(111,83,255,0.35);
      background: rgba(111,83,255,0.10);
      padding: 12px 14px;
      display:none;
    }
    .statsBox .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin:0;
    }
    .statsBox b{ color: rgba(232,236,255,0.95); }
    .statsBox small{ color: rgba(232,236,255,0.72); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 13px;
      color: rgba(232,236,255,0.86);
      margin-bottom: 6px;
    }

    .field{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      outline: none;
    }
    .field:focus{
      border-color: rgba(167,139,250,0.65);
      box-shadow: 0 0 0 4px rgba(111,83,255,0.18);
    }
    .hint{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(232,236,255,0.60);
    }

    .cats{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .chip{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip input{ accent-color: var(--brand); }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 14px 35px rgba(111,83,255,0.25);
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:disabled{
      opacity:0.55;
      cursor:not-allowed;
      filter:none;
    }

    .btnGhost{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: rgba(232,236,255,0.92);
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 700;
    }

    .status{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      padding: 12px;
      display:none;
    }
    .status.ok{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.10); }
    .status.err{ border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.10); }
    .status b{ display:block; margin-bottom: 4px; }
    .status small{ color: rgba(232,236,255,0.72); }

    .footer{
      margin-top: 18px;
      color: rgba(232,236,255,0.60);
      font-size: 12px;
      text-align:center;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a href="/" class="brand" style="text-decoration:none; color:inherit;">
        <img class="logoImg" src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo" />
        <div>
          <div style="font-size:15px; line-height:1;">Terminmarktplatz</div>
          <div style="font-size:12px; color:rgba(232,236,255,0.65); font-weight:600;">Benachrichtigung einrichten</div>
        </div>
      </a>
      <div class="pill">üîî Limit: <b>10 Benachrichtigungen</b> (E-Mail)</div>
    </div>

    <div class="hero">
      <div class="card">
        <div class="inner">
          <h1>Fast geschafft.</h1>
          <p class="sub">
            Du hast das Benachrichtigungspaket gekauft. Damit du Termine bekommst, musst du jetzt deinen
            <b>Termin-Alarm</b> konfigurieren und anschlie√üend deine E-Mail best√§tigen (Double-Opt-In).
            <br><br>
            <a href="/" style="color:#b9adff; text-decoration:underline;">Zur√ºck zur Startseite</a>
          </p>

          <div class="infoBox">
            <b>Wichtig:</b> Du bekommst <b>max. 10 Benachrichtigungen</b> per E-Mail. Das Limit z√§hlt insgesamt.
            <small>Wenn du die Best√§tigungsmail nicht findest: bitte auch im Spam-Ordner schauen.</small>
          </div>

          <div id="alertStatsBox" class="statsBox" aria-live="polite">
            <div class="row">
              <div>
                <b>Dein Kontingent:</b>
                <span id="statUsed">0</span>/<span id="statLimit">10</span>
                ‚Äì <span id="statLeft">10</span> frei
              </div>
              <small id="statHint">Wird nach dem Anlegen aktualisiert.</small>
            </div>
          </div>

          <div class="steps">
            <div class="step">
              <b>1) Daten eintragen</b>
              <span>PLZ/Ort + Kategorie w√§hlen.</span>
            </div>
            <div class="step">
              <b>2) E-Mail best√§tigen</b>
              <span>Link in der Best√§tigungsmail klicken.</span>
            </div>
            <div class="step">
              <b>3) Benachrichtigungen erhalten</b>
              <span>Sobald passende Slots ver√∂ffentlicht werden.</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <div style="font-weight:800; margin-bottom:8px;">Was wird gesucht?</div>
          <div style="color:var(--muted); font-size:13px; line-height:1.5;">
            Gib die PLZ (Pflicht) und eine Kategorie (Pflicht) an. Je genauer du es einstellst, 
            desto relevanter sind die Benachrichtigungen.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="inner">
        <form id="alertForm">
          <div class="grid">
            <div>
              <label for="email">E-Mail (dorthin kommen die Benachrichtigungen)</label>
              <input class="field" id="email" name="email" type="email" placeholder="name@mail.de" required />
              <div class="hint">Diese E-Mail muss gleich per Link best√§tigt werden.</div>
            </div>

            <div>
              <label for="zip">PLZ (Pflicht)</label>
              <input class="field" id="zip" name="zip" inputmode="numeric" maxlength="5" placeholder="z.B. 96191" required />
              <div class="hint">Nur deutsche PLZ (5-stellig).</div>
            </div>

            <div>
              <label for="city">Ort (optional)</label>
              <input class="field" id="city" name="city" type="text" placeholder="z.B. Bamberg" />
              <div class="hint">Optional ‚Äì hilft, falls du sp√§ter Radius-Suche aktivierst.</div>
            </div>

            <div>
              <label for="radius">Radius (optional)</label>
              <input class="field" id="radius" name="radius_km" type="number" min="0" max="100" step="1" placeholder="z.B. 10" />
              <div class="hint">0 = nur PLZ. (Radius wird nur genutzt, wenn im Backend aktiv.)</div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <label>Kategorie (Pflicht)</label>
            <div class="cats" id="cats">
              <label class="chip"><input type="radio" name="category" value="Friseur" required>Friseur</label>
              <label class="chip"><input type="radio" name="category" value="Kosmetik" required>Kosmetik</label>
              <label class="chip"><input type="radio" name="category" value="Physiotherapie" required>Physiotherapie</label>
              <label class="chip"><input type="radio" name="category" value="Nagelstudio" required>Nagelstudio</label>
              <label class="chip"><input type="radio" name="category" value="Zahnarzt" required>Zahnarzt</label>
              <label class="chip"><input type="radio" name="category" value="Handwerk" required>Handwerk</label>
              <label class="chip"><input type="radio" name="category" value="KFZ-Service" required>KFZ-Service</label>
              <label class="chip"><input type="radio" name="category" value="Fitness" required>Fitness</label>
              <label class="chip"><input type="radio" name="category" value="Coaching" required>Coaching</label>
              <label class="chip"><input type="radio" name="category" value="Tierarzt" required>Tierarzt</label>
              <label class="chip"><input type="radio" name="category" value="Beh√∂rde" required>Beh√∂rde</label>
              <label class="chip"><input type="radio" name="category" value="Rechtsanwalt" required>Rechtsanwalt</label>
              <label class="chip"><input type="radio" name="category" value="Notar" required>Notar</label>
              <label class="chip"><input type="radio" name="category" value="T√§towierer" required>T√§towierer</label>
            </div>
            <div class="hint">Eine Kategorie muss ausgew√§hlt werden. Das <b>Limit (10)</b> z√§hlt unabh√§ngig von Kategorien.</div>
          </div>

          <input type="hidden" name="via_email" value="true" />
          <input type="hidden" name="via_sms" value="false" />
          <input type="hidden" id="package_name" name="package_name" value="alert_email" />

          <div class="row" style="margin-top:14px;">
            <label class="chip" style="border-radius:14px;">
              <input id="consent" type="checkbox" />
              <span>Ich willige ein, dass Terminmarktplatz mir E-Mails zu passenden Terminen sendet.</span>
            </label>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn" id="submitBtn" type="submit">Alarm erstellen & Best√§tigungsmail senden</button>
            <button class="btnGhost" type="button" id="resetBtn">Zur√ºcksetzen</button>
            <button class="btnGhost" type="button" id="myAlertsBtn" style="display:none;">Meine Benachrichtigungen</button>
          </div>

          <div id="statusBox" class="status">
            <b id="statusTitle">Status</b>
            <small id="statusText"></small>
          </div>

          <div class="footer">
            Hinweis: Nach dem Klick bekommst du eine Best√§tigungsmail. Erst nach Best√§tigung ist der Alarm aktiv.
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
  (function(){
    // ‚úÖ API_BASE robust (gleich wie die anderen Seiten)
    const API_BASE = (() => {
      const h = location.hostname;
      const proto = location.protocol;

      const isLocal =
        h === 'localhost' ||
        h === '127.0.0.1' ||
        /^192\.168\./.test(h) ||
        /^10\./.test(h) ||
        h.endsWith('.local');

      if (isLocal) return `${proto}//${h}:5000`;
      if (h === 'api.terminmarktplatz.de') return `${proto}//${h}`;
      return 'https://api.terminmarktplatz.de';
    })();

    const $ = (id) => document.getElementById(id);

    const emailEl = $("email");
    const zipEl = $("zip");
    const cityEl = $("city");
    const radiusEl = $("radius");
    const consentEl = $("consent");
    const pkgEl = $("package_name");

    const statusBox = $("statusBox");
    const statusTitle = $("statusTitle");
    const statusText = $("statusText");
    const submitBtn = $("submitBtn");
    const resetBtn = $("resetBtn");
    const myAlertsBtn = $("myAlertsBtn");

    const statsBox = $("alertStatsBox");
    const statUsed = $("statUsed");
    const statLimit = $("statLimit");
    const statLeft = $("statLeft");
    const statHint = $("statHint");

    function showStatus(kind, title, text){
      statusBox.classList.remove("ok","err");
      statusBox.style.display = "block";
      statusBox.classList.add(kind === "ok" ? "ok" : "err");
      statusTitle.textContent = title;
      statusText.textContent = text;
    }

    function qp(key){
      const u = new URL(window.location.href);
      return u.searchParams.get(key);
    }

    function validZip(z){
      return /^[0-9]{5}$/.test((z || "").trim());
    }

    function collectCategories(){
      const selected = document.querySelector("#cats input[name='category']:checked");
      if (!selected) return null;
      const value = (selected.value || "").trim();
      if (!value) return null; // Kategorie ist jetzt Pflicht
      return value;
    }

    // ‚úÖ manageKey aus URL: ?k= oder ?manage_key=
    let manageKey = (qp("k") || qp("manage_key") || "").trim();

    function updateUrlWithManageKey(k){
      k = (k || "").trim();
      if(!k) return;
      const u = new URL(window.location.href);
      if(u.searchParams.get("k") === k) return;
      u.searchParams.set("k", k);
      history.replaceState({}, "", u.toString());
      manageKey = k;
    }

    function showMyAlertsButton(){
      if(!manageKey) return;
      myAlertsBtn.style.display = "inline-block";
    }

    myAlertsBtn.addEventListener("click", () => {
      if(!manageKey){
        alert("Kein Magic-Link vorhanden.");
        return;
      }
      window.location.href = "/meine-benachrichtigungen.html?k=" + encodeURIComponent(manageKey);
    });

    function disableForm(){
      const form = $("alertForm");
      form.querySelectorAll("input, select, button, textarea").forEach(el => {
        if (el.id === "resetBtn") return;
        if (el.id === "myAlertsBtn") return;
        el.disabled = true;
      });
      submitBtn.disabled = true;
    }

    function setStats(stats){
      if (!stats || typeof stats !== "object") return;

      const used = Number.isFinite(+stats.used) ? +stats.used : null;
      const lim  = Number.isFinite(+stats.limit) ? +stats.limit : null;
      const left =
        Number.isFinite(+stats.left) ? +stats.left :
        (Number.isFinite(+stats.remaining) ? +stats.remaining : null);

      if (used === null || lim === null || left === null) return;

      statUsed.textContent = String(used);
      statLimit.textContent = String(lim);
      statLeft.textContent = String(left);

      statsBox.style.display = "block";

      if (left <= 0){
        statHint.textContent = "Kontingent voll. Du kannst aktuell keine weitere Benachrichtigung anlegen.";
        disableForm();
      } else {
        statHint.textContent = "Du kannst weitere Benachrichtigungen anlegen.";
      }
    }

    async function tryFetchStats(){
      if(!manageKey) return;

      const endpoints = [
        `${API_BASE}/api/alert-subscriptions/by-manage-key?k=${encodeURIComponent(manageKey)}`,
        `${API_BASE}/api/alerts/by-manage-key?k=${encodeURIComponent(manageKey)}`,
        `${API_BASE}/api/alerts/manage?k=${encodeURIComponent(manageKey)}`
      ];

      for (const url of endpoints){
        try{
          const r = await fetch(url, { method:"GET", headers:{ "Accept":"application/json" } });
          const js = await r.json().catch(()=>null);
          if(!r.ok || !js || js.ok === false) continue;

          // normalize
          const used = js.used ?? js.stats?.used;
          const limit = js.limit ?? js.stats?.limit ?? 10;
          const remaining = js.remaining ?? js.stats?.remaining ?? js.left ?? js.stats?.left;

          if (used !== undefined && (remaining !== undefined || limit !== undefined)){
            setStats({ used, limit, remaining, left: remaining });
            return;
          }
        }catch(e){
          // ignore
        }
      }
    }

    // Prefill: ?email=...&pkg=...
    const preEmail = qp("email");
    if (preEmail) emailEl.value = preEmail;

    const prePkg = qp("pkg");
    if (prePkg) pkgEl.value = prePkg;

    if(manageKey){
      showMyAlertsButton();
      // optional: Stats direkt holen wenn vorhanden
      tryFetchStats();
    }

    $("alertForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = (emailEl.value || "").trim().toLowerCase();
      const zip = (zipEl.value || "").trim();
      const city = (cityEl.value || "").trim();
      const radiusRaw = (radiusEl.value || "").trim();
      const pkg = (pkgEl.value || "alert_email").trim();

      if (!email || !email.includes("@")){
        showStatus("err","Fehler","Bitte eine g√ºltige E-Mail eingeben.");
        return;
      }
      if (!validZip(zip)){
        showStatus("err","Fehler","Bitte eine g√ºltige 5-stellige PLZ eingeben.");
        return;
      }
      const category = collectCategories();
      if (!category){
        showStatus("err","Fehler","Bitte eine Kategorie ausw√§hlen.");
        return;
      }
      if (!consentEl.checked){
        showStatus("err","Fehler","Bitte die Einwilligung best√§tigen, sonst d√ºrfen wir keine Mails senden.");
        return;
      }

      let radius_km = 0;
      if (radiusRaw){
        const n = parseInt(radiusRaw, 10);
        radius_km = Number.isFinite(n) ? Math.max(0, n) : 0;
      }

      const payload = {
        email,
        phone: "",
        zip,
        city,
        radius_km,
        categories: category,
        via_email: true,
        via_sms: false,
        package_name: pkg,
        manage_key: manageKey || null
      };

      submitBtn.disabled = true;
      showStatus("ok","Sende‚Ä¶","Wir erstellen deinen Alarm und schicken dir gleich die Best√§tigungsmail‚Ä¶");

      try{
        const res = await fetch(`${API_BASE}/api/alerts`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const js = await res.json().catch(() => ({}));

        if (!res.ok){
          const err = js && js.error ? js.error : ("HTTP " + res.status);

          if (err === "alert_limit_reached"){
            showStatus("err","Limit erreicht","Du hast bereits alle 10 Benachrichtigungen genutzt.");
            if (js.stats) setStats(js.stats);
            submitBtn.disabled = false;
            return;
          }

          // Debug: zeig wenigstens API_BASE im Fehlertext
          showStatus("err","Fehler",`Alarm konnte nicht angelegt werden: ${err} (API: ${API_BASE})`);
          submitBtn.disabled = false;
          return;
        }

        // ‚úÖ manage_key aus Response √ºbernehmen (tolerant bei Feldnamen)
        const returnedKey = (js.manage_key || js.manageKey || js.k || "").trim();
        if (!manageKey && returnedKey){
          updateUrlWithManageKey(returnedKey);
        }
        if(manageKey){
          showMyAlertsButton();
        }

        // ‚úÖ Stats aus Response oder per Nachladen
        if (js.stats){
          setStats(js.stats);
        } else {
          await tryFetchStats();
          if (statsBox.style.display !== "block"){
            statsBox.style.display = "block";
            statHint.textContent = "Kontingent wird nach dem n√§chsten Schritt aktualisiert (Backend liefert noch keine Stats).";
          }
        }

        showStatus(
          "ok",
          "Fast fertig ‚úÖ",
          "Wir haben dir eine Best√§tigungsmail gesendet. Bitte klicke den Link in der Mail, damit der Alarm aktiv wird."
        );

      }catch(err){
        showStatus("err","Fehler",`Netzwerkfehler. Bitte Seite neu laden und erneut versuchen. (API: ${API_BASE})`);
        submitBtn.disabled = false;
      }
    });

    resetBtn.addEventListener("click", () => {
      document.querySelectorAll("input").forEach(i => {
        if (i.type === "checkbox") i.checked = false;
        if (i.type === "radio") i.checked = false;
      });
      // Keine Kategorie mehr als Standard, da Kategorie jetzt Pflicht ist
      emailEl.value = preEmail || "";
      zipEl.value = "";
      cityEl.value = "";
      radiusEl.value = "";
      submitBtn.disabled = false;
      statusBox.style.display = "none";
      // Stats bewusst nicht resetten
    });

  })();
</script>

</body>
</html>
