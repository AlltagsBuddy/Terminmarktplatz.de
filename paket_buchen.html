<!-- FILE: templates/paket_buchen.html -->
<!doctype html>
<html lang="de">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-YNZ8GW523R');
  </script>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paket buchen – {{ plan.name }} | Terminmarktplatz</title>
  <meta name="description" content="Buche dein Paket für den Terminmarktplatz. Sofort online bezahlen, inklusive Slot-Kontingent pro Monat." />
  <meta name="theme-color" content="#6f53ff" />

  <!-- OG -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Paket buchen – {{ plan.name }} | Terminmarktplatz" />
  <meta property="og:description" content="Buche dein Paket für den Terminmarktplatz und sichere dir dein Slot-Kontingent." />
  <meta property="og:image" content="/static/og-cover.png" />

  <style>
    :root {
      --tm-primary: #6f53ff;
      --tm-primary-soft: #ece9ff;
      --tm-bg: #f3f4f6;
      --tm-border: #e5e7eb;
      --tm-text: #111827;
      --tm-muted: #6b7280;
      --tm-danger: #dc2626;
      --tm-success: #16a34a;
      --tm-radius-lg: 18px;
      --tm-shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #eef2ff 0, #f9fafb 45%, #f3f4f6 100%);
      color: var(--tm-text);
      -webkit-font-smoothing: antialiased;
    }

    header {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(10px);
      background: linear-gradient(90deg, rgba(111,83,255,0.05), rgba(37,99,235,0.03));
    }

    header .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 17px;
      letter-spacing: 0.03em;
      color: #111827;
    }

    header .brand span.logo-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, #a5b4fc, #6f53ff);
      color: white;
      font-size: 15px;
      font-weight: 700;
      box-shadow: 0 10px 25px rgba(79,70,229,0.35);
    }

    main {
      max-width: 960px;
      margin: 30px auto 40px;
      padding: 0 16px;
    }

    .card {
      background: #ffffff;
      border-radius: var(--tm-radius-lg);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: var(--tm-shadow-soft);
      padding: 22px 20px 20px;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .card {
        padding: 26px 26px 24px;
      }
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(111,83,255,0.08), transparent 55%);
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .headline-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 18px;
    }

    @media (min-width: 640px) {
      .headline-row {
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
      }
    }

    .title-block h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.01em;
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 14px;
      color: var(--tm-muted);
      max-width: 520px;
    }

    .plan-badge {
      align-self: flex-start;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: #eef2ff;
      border: 1px solid rgba(79,70,229,0.22);
      color: #4338ca;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .plan-badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4f46e5;
    }

    .plan-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 20px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .plan-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .plan-main, .plan-side {
      background: #f9fafb;
      border-radius: 14px;
      padding: 14px 14px 14px;
      border: 1px solid rgba(209,213,219,0.8);
    }

    @media (min-width: 768px) {
      .plan-main, .plan-side {
        padding: 16px 16px 16px;
      }
    }

    .plan-price {
      display: flex;
      align-items: baseline;
      gap: 4px;
      margin: 0 0 8px;
    }

    .plan-price span.amount {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .plan-price span.currency {
      font-size: 14px;
      color: var(--tm-muted);
    }

    .plan-price span.period {
      font-size: 13px;
      color: var(--tm-muted);
    }

    .plan-meta {
      font-size: 13px;
      color: var(--tm-muted);
      margin-bottom: 10px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .pill {
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      background: white;
      border: 1px solid rgba(209,213,219,0.9);
      color: #374151;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill strong {
      font-weight: 600;
    }

    .pill .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4f46e5;
    }

    .features {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      font-size: 13px;
      color: #374151;
    }

    .features li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 4px 0;
    }

    .features li span.bullet {
      width: 6px;
      height: 6px;
      margin-top: 6px;
      border-radius: 999px;
      background: #10b981;
      flex-shrink: 0;
    }

    .features li span.text {
      flex: 1;
    }

    .info-hint {
      font-size: 12px;
      color: var(--tm-muted);
      margin-top: 10px;
    }

    .info-hint strong {
      color: #111827;
      font-weight: 600;
    }

    .provider-box {
      font-size: 13px;
      color: #374151;
      margin-bottom: 12px;
    }

    .provider-box span.label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--tm-muted);
      margin-bottom: 2px;
    }

    .provider-box strong {
      font-weight: 600;
    }

    .side-section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--tm-muted);
      margin-bottom: 6px;
    }

    .billing-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 13px;
      color: #374151;
    }

    .billing-list li {
      display: flex;
      gap: 8px;
      padding: 4px 0;
    }

    .billing-list li span.marker {
      width: 12px;
      text-align: center;
      flex-shrink: 0;
      color: #9ca3af;
    }

    .billing-list li strong {
      font-weight: 600;
    }

    .separator {
      height: 1px;
      margin: 10px 0;
      background: linear-gradient(90deg, rgba(148,163,184,0.2), transparent);
    }

    .form-row {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #ffffff;
      box-shadow: 0 14px 30px rgba(79,70,229,0.45);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, filter 0.08s ease-out;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(79,70,229,0.55);
      filter: brightness(1.03);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 10px 24px rgba(79,70,229,0.45);
      filter: brightness(0.98);
    }

    .btn-primary span.icon {
      font-size: 15px;
    }

    .btn-secondary-link {
      border: none;
      background: transparent;
      color: var(--tm-muted);
      font-size: 12px;
      padding: 0;
      margin-top: 6px;
      text-decoration: underline;
      cursor: pointer;
      text-align: left;
    }

    .btn-secondary-link:hover {
      color: #4b5563;
    }

    .status-box {
      display: none;
      margin-top: 8px;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
    }

    .status-box.success {
      display: none;
      background: #ecfdf3;
      border-color: rgba(22,163,74,0.4);
      color: #166534;
    }

    .status-box.error {
      display: none;
      background: #fef2f2;
      border-color: rgba(220,38,38,0.4);
      color: #b91c1c;
    }

    .status-box span.label {
      font-weight: 600;
    }

    .footnote {
      font-size: 11px;
      color: var(--tm-muted);
      margin-top: 12px;
      line-height: 1.5;
    }

    a {
      color: #4f46e5;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="logo-pill">T</span>
      <span>Terminmarktplatz</span>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-inner">
        <div class="headline-row">
          <div class="title-block">
            <h1>Paket buchen: {{ plan.name }}</h1>
            <p>
              Sichere dir dein Kontingent an freien Slots und lasse gebuchte Termine wie vereinbart
              monatlich abrechnen. Die Zahlung des Pakets erfolgt direkt online.
            </p>
          </div>
          <div class="plan-badge">
            <span class="dot"></span>
            Paket: {{ plan.name }}
          </div>
        </div>

        <div class="plan-grid">
          <!-- Linke Seite: Paketdetails -->
          <div class="plan-main">
            <p class="side-section-title">Paket &amp; Kontingent</p>

            <p class="plan-price">
              <span class="amount">{{ '%.2f'|format(plan.price_eur|float) }}</span>
              <span class="currency">&euro;</span>
              <span class="period>/</span>
              <span class="period">30 Tage</span>
            </p>

            <p class="plan-meta">
              Enthalten: bis zu <strong>{{ plan.free_slots }}</strong> freie Slots im Monat, zzgl.
              <strong>2,00&nbsp;&euro;</strong> pro gebuchtem Slot (nachträgliche Monatsabrechnung).
            </p>

            <div class="pill-row">
              <div class="pill">
                <span class="dot"></span>
                <span><strong>{{ plan.free_slots }}</strong> Slots / Monat</span>
              </div>
              <div class="pill">
                <span class="dot"></span>
                <span><strong>2,00&nbsp;&euro;</strong> je gebuchtem Slot</span>
              </div>
              <div class="pill">
                <span class="dot"></span>
                <span>Monatliche Abrechnung der Buchungen</span>
              </div>
            </div>

            <ul class="features">
              <li>
                <span class="bullet"></span>
                <span class="text">
                  Die Paketgebühr wird direkt bei der Buchung des Pakets fällig (Stripe / Online-Zahlung).
                </span>
              </li>
              <li>
                <span class="bullet"></span>
                <span class="text">
                  Gebuchte Termine (<strong>status = bestätigt</strong>) werden einmal im Monat gesammelt
                  und mit <strong>2,00&nbsp;&euro;</strong> pro Buchung abgerechnet.
                </span>
              </li>
              <li>
                <span class="bullet"></span>
                <span class="text">
                  Nicht genutzte freie Slots verfallen am Ende des Abrechnungszeitraums.
                </span>
              </li>
            </ul>

            <p class="info-hint">
              <strong>Hinweis:</strong> Dieses Paket wirkt sich nur auf dein Slot-Kontingent aus.
              Bestehende Buchungen bleiben unverändert bestehen.
            </p>
          </div>

          <!-- Rechte Seite: Buchungs-/Abrechnungsinfos und Button -->
          <div class="plan-side">
            {% if provider %}
            <div class="provider-box">
              <span class="label">Dieses Paket wird gebucht für</span>
              <div>
                <strong>{{ provider.company_name or provider.email }}</strong><br />
                <span>{{ provider.email }}</span>
              </div>
            </div>
            <div class="separator"></div>
            {% endif %}

            <p class="side-section-title">Abrechnung der gebuchten Termine</p>
            <ul class="billing-list">
              <li>
                <span class="marker">1.</span>
                <span>
                  Du legst Slots an und Kund:innen buchen deine freien Termine über den Terminmarktplatz.
                </span>
              </li>
              <li>
                <span class="marker">2.</span>
                <span>
                  Für jede <strong>bestätigte Buchung</strong> wird intern eine Gebühr von
                  <strong>2,00&nbsp;&euro;</strong> gespeichert.
                </span>
              </li>
              <li>
                <span class="marker">3.</span>
                <span>
                  Einmal im Monat erzeugt das System eine Übersicht bzw. Sammelrechnung, in der alle
                  bestätigten Buchungen des Monats enthalten sind.
                </span>
              </li>
            </ul>

            <div class="separator"></div>

            <form id="book-plan-form" class="form-row">
              <input type="hidden" name="plan" value="{{ plan_key }}" />

              <button type="submit" class="btn-primary">
                <span class="icon">⚡</span>
                <span>Paket jetzt verbindlich buchen</span>
              </button>

              <button type="button" class="btn-secondary-link" onclick="history.back()">
                Abbrechen und zurück
              </button>

              <div id="status-success" class="status-box success">
                <span class="label">Gebucht.</span>
                &nbsp;Das Paket wurde aktiviert. Du kannst nun zusätzliche Slots im Anbieter-Portal anlegen.
              </div>

              <div id="status-error" class="status-box error">
                <span class="label">Fehler.</span>
                &nbsp;Die Buchung konnte nicht durchgeführt werden. Bitte versuche es später erneut.
              </div>
            </form>

            <p class="footnote">
              Durch Klick auf „Paket jetzt verbindlich buchen“ bestätigst du, dass du die
              <a href="/agb">AGB</a> und <a href="/datenschutz">Datenschutzerklärung</a> gelesen hast.
              Paketgebühren werden sofort fällig. Die Abrechnung der gebuchten Slots erfolgt nachträglich
              monatlich gemäß der vereinbarten Konditionen.
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const form = document.getElementById('book-plan-form');
      const successBox = document.getElementById('status-success');
      const errorBox = document.getElementById('status-error');

      function showStatus(kind, message) {
        if (successBox) {
          successBox.style.display = 'none';
        }
        if (errorBox) {
          errorBox.style.display = 'none';
        }

        if (kind === 'success' && successBox) {
          if (message) {
            successBox.innerHTML = '<span class="label">Gebucht.</span>&nbsp;' + message;
          }
          successBox.style.display = 'block';
        } else if (kind === 'error' && errorBox) {
          if (message) {
            errorBox.innerHTML = '<span class="label">Fehler.</span>&nbsp;' + message;
          }
          errorBox.style.display = 'block';
        }
      }

      if (form) {
        form.addEventListener('submit', async function (ev) {
          ev.preventDefault();
          showStatus(null);

          const plan = "{{ plan_key }}";

          try {
            const res = await fetch("/paket-buchen", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              credentials: "include",
              body: JSON.stringify({ plan })
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok || !data || data.error) {
              const msg = (data && (data.error || data.detail)) || "Die Buchung ist fehlgeschlagen.";
              showStatus("error", msg);
              return;
            }

            if (data.checkout_url) {
              // Stripe-Checkout
              window.location.href = data.checkout_url;
              return;
            }

            // Fallback: kein Stripe (z.B. Testmodus)
            showStatus(
              "success",
              "Das Paket wurde aktiviert. Du kannst sofort weitere Slots im Anbieter-Portal anlegen."
            );
          } catch (e) {
            console.error(e);
            showStatus("error", "Es ist ein technischer Fehler aufgetreten.");
          }
        });
      }
    })();
  </script>
</body>
</html>
