<!-- FILE: suche.html -->  
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suche ‚Äì Freie Termine | Terminmarktplatz</title>
  <meta name="description" content="Finde freie Termine nach Kategorie, Ort und Datum. Ohne Anmeldung direkt buchen ‚Äì mit E-Mail-Best√§tigung." />
  <meta name="theme-color" content="#6f53ff" />

  <!-- OG -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Suche ‚Äì Freie Termine | Terminmarktplatz" />
  <meta property="og:description" content="Freie Termine in deiner N√§he finden und direkt buchen. Filter nach Kategorie, Ort, Datum und Dauer." />
  <meta property="og:site_name" content="Terminmarktplatz" />
  <meta property="og:url" content="https://terminmarktplatz.de/suche.html" />
  <meta property="og:image" content="https://terminmarktplatz.de/static/og-cover.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="de_DE" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Suche ‚Äì Freie Termine | Terminmarktplatz" />
  <meta name="twitter:description" content="Freie Termine in deiner N√§he finden und direkt buchen." />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://terminmarktplatz.de/suche.html" />
  
  <!-- SEO Meta-Tags -->
  <meta name="keywords" content="Termine suchen, freie Termine finden, Terminbuchung, Friseur Termine, Kosmetik Termine, Physiotherapie Termine, Termine buchen, kurzfristige Termine" />
  <meta name="robots" content="index, follow" />

  <base href="/">
  <link rel="icon" href="/static/favicon.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css?v=20251010" />

  <!-- Page-spezifische Optimierung (v. a. mobil) -->
  <style>
    /* 1) Kein horizontales Scrollen */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Standard: auth-in zun√§chst ausblenden ‚Äì JS zeigt sie bei Login */
    .auth-in {
      display: none;
    }

    /* Wei√üer Men√º-Button wie auf agb/preise */
    .user-menu .btn {
      background:#ffffff;
      color:#0f172a;
      border:1px solid #cbd5e1;
      text-shadow:none;
      background-image:none;
    }

    /* HEADER + MEN√ú ‚Äì Men√º direkt hinter Brand, Nav rechts */
    header .nav{
      display:flex;
      align-items:center;
      gap:16px;
    }
    header .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    header .user-menu{
      display:block;          /* immer sichtbar */
      position:relative;
      z-index:60;
      margin-left:12px;       /* Abstand hinter ‚ÄûTerminmarktplatz‚Äú */
    }
    header .nav-links{
      display:flex;
      align-items:center;
      gap:16px;
      margin-left:auto;       /* schiebt Links nach rechts */
    }

    .cta-group {
      display:flex;
      gap:8px;
      margin-left:auto;
    }

    /* Nur dieser Abbrechen-Button im Buchungsdialog */
    .booking-cancel-btn {
      background: rgba(111, 83, 255, 0.08);
      border: 1px solid rgba(111, 83, 255, 0.35);
      color: #111827;
      box-shadow: none;
    }
    .booking-cancel-btn:hover {
      background: rgba(111, 83, 255, 0.16);
      border-color: rgba(111, 83, 255, 0.7);
    }

    /* Toolbar √ºber den Ergebnissen */
    .results-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* Ergebnis-Grid */
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      position: relative;
    }
    /* Stelle sicher, dass Buttons in Cards klickbar sind */
    .results-grid .card button[data-book],
    .card button[data-book],
    button[data-book] {
      pointer-events: auto !important;
      cursor: pointer !important;
      position: relative !important;
      z-index: 10 !important;
      touch-action: manipulation !important;
    }

    .provider-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:4px;
    }
    .provider-logo,
    .provider-logo-fallback{
      width:32px;
      height:32px;
      border-radius:50%;
      flex:0 0 32px;
      background:#e2e8f0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#0f172a;
      font-size:0.85rem;
      overflow:hidden;
    }
    .provider-logo{
      object-fit:cover;
      background:#ffffff;
      border:1px solid #e2e8f0;
    }

    /* Actions im Buchungsdialog */
    .book-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 6px;
    }

    /* HTML5 Dialog Element - Moderner Ansatz */
    #book-dialog {
      border: none;
      border-radius: 18px;
      padding: 0;
      max-width: 480px;
      width: calc(100% - 32px);
      max-height: calc(100vh - 32px);
      background: #fff;
      color: #111;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    #book-dialog::backdrop {
      background: rgba(20,16,40,.55);
      backdrop-filter: blur(4px) saturate(130%);
    }
    .book-dialog-content {
      padding: 28px 24px;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
    }

    /* Fallback Overlay - √úberschreibt style.css .loading-backdrop */
    /* H√∂chste Spezifit√§t um sicherzustellen, dass unsere Styles greifen */
    #book-backdrop.book-backdrop-fallback,
    div#book-backdrop.book-backdrop-fallback,
    #book-backdrop.book-backdrop-fallback.loading-backdrop,
    body #book-backdrop.book-backdrop-fallback {
      position: fixed !important;
      inset: 0 !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 99999 !important;
      display: flex !important;
      /* √úberschreibe display: grid aus style.css .loading-backdrop */
      grid: none !important;
      grid-template: none !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      place-items: unset !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 16px !important;
      margin: 0 !important;
      background: rgba(20,16,40,.75) !important;
      backdrop-filter: blur(4px) saturate(130%) !important;
      -webkit-backdrop-filter: blur(4px) saturate(130%) !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    #book-backdrop.book-backdrop-fallback[hidden],
    div#book-backdrop.book-backdrop-fallback[hidden],
    #book-backdrop.book-backdrop-fallback.loading-backdrop[hidden],
    body #book-backdrop.book-backdrop-fallback[hidden] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    #book-backdrop.book-backdrop-fallback .book-dialog-content,
    div#book-backdrop.book-backdrop-fallback .book-dialog-content,
    body #book-backdrop.book-backdrop-fallback .book-dialog-content {
      background: #fff !important;
      color: #111 !important;
      border-radius: 18px !important;
      padding: 28px 24px !important;
      box-shadow: 0 10px 40px rgba(0,0,0,.25) !important;
      max-width: 480px !important;
      width: 100% !important;
      max-height: calc(100vh - 32px) !important;
      overflow-y: auto !important;
      box-sizing: border-box !important;
      position: relative !important;
      margin: 0 !important;
    }

    /* Mobile Optimierungen */
    @media (max-width: 768px) {
      /* Header / Navigation ‚Äì wie agb/preise */
      header .nav{
        flex-wrap:wrap;
        align-items:flex-start;
        gap:8px;
        padding-inline:16px;
      }

      header .brand-title{
        font-size:1.05rem;
      }

      /* Brand links, Men√º rechts in der ersten Zeile */
      header .user-menu{
        margin-left:auto;
      }

      /* Links in Zeile 2, zentriert */
      header .nav-links{
        width:100%;
        justify-content:center;
        flex-wrap:wrap;
        gap:8px;
        text-align:center;
        margin-left:0;
        margin-top:4px;
      }

      header .nav-links a{
        font-size:0.9rem;
        padding:2px 6px;
      }

      /* CTA-Gruppe auf Mobile ausblenden (falls vorhanden) */
      .cta-group{
        display:none !important;
      }

      .hero {
        padding: 20px 0 12px;
      }
      .hero h1 {
        font-size: 1.6rem;
      }
      .hero .lead {
        font-size: 0.95rem;
      }

      .search-card {
        padding: 12px;
      }

      .searchbar {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .searchbar .input {
        width: 100%;
      }

      .searchbar .input input,
      .searchbar .input select {
        width: 100%;
      }

      .searchbar .btn.primary {
        width: 100%;
        justify-content: center;
        margin-top: 4px;
      }

      .results-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }
      
      /* Stelle sicher, dass Buttons in Cards auf Mobile klickbar sind */
      .card button[data-book],
      button[data-book] {
        pointer-events: auto !important;
        cursor: pointer !important;
        position: relative !important;
        z-index: 10 !important;
        touch-action: manipulation !important;
      }

      .card {
        padding: 12px;
        position: relative;
        pointer-events: auto; /* Stelle sicher, dass Cards klickbar sind */
      }
      .card button[data-book] {
        pointer-events: auto !important;
        cursor: pointer !important;
        position: relative !important;
        z-index: 10 !important;
      }

      /* Mobile: Bottom Sheet Style f√ºr Dialog */
      #book-dialog {
        width: 100%;
        max-width: 100%;
        margin: 0;
        border-radius: 18px 18px 0 0;
        max-height: 90vh;
        position: fixed;
        bottom: 0;
        top: auto;
        left: 0;
        right: 0;
      }
      #book-dialog::backdrop {
        background: rgba(20,16,40,.75);
      }
      .book-dialog-content {
        padding: 24px 20px;
        padding-bottom: max(24px, env(safe-area-inset-bottom));
      }
      
      /* Fallback Overlay Mobile - Bottom Sheet - H√∂chste Spezifit√§t */
      #book-backdrop.book-backdrop-fallback,
      div#book-backdrop.book-backdrop-fallback,
      #book-backdrop.book-backdrop-fallback.loading-backdrop,
      body #book-backdrop.book-backdrop-fallback {
        padding: 0 !important;
        align-items: flex-end !important;
        justify-content: center !important;
        /* √úberschreibe display: grid aus style.css .loading-backdrop */
        display: flex !important;
        grid: none !important;
        grid-template: none !important;
        place-items: unset !important;
      }
      #book-backdrop.book-backdrop-fallback .book-dialog-content,
      div#book-backdrop.book-backdrop-fallback .book-dialog-content,
      body #book-backdrop.book-backdrop-fallback .book-dialog-content {
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 18px 18px 0 0 !important;
        margin: 0 !important;
        padding: 24px 20px !important;
        padding-bottom: max(24px, env(safe-area-inset-bottom)) !important;
        max-height: 90vh !important;
        position: relative !important;
        animation: slideUp 0.3s ease-out;
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .book-actions {
        flex-direction: column-reverse;
        align-items: stretch;
      }
      .book-actions .btn {
        width: 100%;
        justify-content: center;
      }

      /* Footer untereinander */
      .foot-grid{
        display:grid;
        grid-template-columns:1fr;
        gap:16px;
      }
      .foot-col{
        margin-top:4px;
      }
    }

    @media (min-width: 769px){
      .cta-group {
        display:flex;
      }
    }
      /* Text im Google-Maps-Infofenster immer dunkel halten */
      #map .gm-style .tm-slot-iw {
        color: #111827 !important;       /* dunkles Grau */
        text-shadow: none !important;
      }

      #map .gm-style .tm-slot-iw a {
        color: #1d4ed8 !important;       /* Linkfarbe */
        text-decoration: underline;
      }

      #map .gm-style .tm-slot-iw strong {
        color: #111827 !important;
      }

  </style>
  <script>
  (function(){
    const API = (typeof window.API === 'string')
      ? window.API
      : ((h) => {
          if (h === 'localhost' || h === '127.0.0.1') {
            return 'http://127.0.0.1:5000';
          }
          if (h.includes('testsystem') || h.includes('onrender.com')) {
            return `${location.protocol}//${location.host}`;
          }
          return 'https://api.terminmarktplatz.de';
        })(location.hostname);

    const btn  = document.getElementById('userMenuBtn');
    const menu = document.getElementById('userMenu');
    if (!btn || !menu) return;

    function openMenu(open){
      menu.hidden = !open;
      btn.setAttribute('aria-expanded', String(open));
    }

    // Men√º ein-/ausklappen
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      openMenu(menu.hidden);
    });

    document.addEventListener('click', ()=> openMenu(false));
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') openMenu(false); });

    // Login-Status -> auth-in / auth-out steuern
    async function updateAuthUI(){
      let loggedIn = false;
      let isAdmin = false;
      try{
        const res = await fetch(`${API}/me`, { credentials:'include' });
        if (res.ok) {
          loggedIn = true;
          const data = await res.json().catch(()=> null);
          isAdmin = data?.is_admin === true;
        }
      }catch(e){
        loggedIn = false;
      }

      document.querySelectorAll('.auth-in').forEach(el => {
        el.style.display = loggedIn ? '' : 'none';
      });
      document.querySelectorAll('.auth-out').forEach(el => {
        el.style.display = loggedIn ? 'none' : '';
      });
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = (loggedIn && isAdmin) ? '' : 'none';
      });
    }

    updateAuthUI();
  })();
  </script>

</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav"
         role="navigation"
         aria-label="Hauptnavigation">
      <!-- Logo / Brand -->
      <a class="brand" href="index.html" aria-label="Startseite">
        <div class="brand-logo" aria-hidden="true">
          <img src="/static/terminmarktplatz-logo.png"
               alt="Terminmarktplatz Logo"
               width="50" height="50">
        </div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>

      <!-- User-Men√º direkt hinter ‚ÄûTerminmarktplatz‚Äú -->
      <div class="user-menu">
        <button id="userMenuBtn" class="btn" aria-haspopup="menu" aria-expanded="false">
          ‚ò∞ Men√º
        </button>
        <div id="userMenu" class="menu" role="menu" hidden>
          <!-- nur sichtbar, wenn NICHT eingeloggt -->
          <a href="login.html?tab=login" class="item auth-out" role="menuitem">Anmelden</a>

          <!-- nur sichtbar, wenn eingeloggt -->
          <button type="button" class="item auth-in" data-action="logout" role="menuitem">Abmelden</button>
          <a href="anbieter-portal.html" class="item auth-in" role="menuitem">Profil</a>
          <a href="anbieter-portal.html#step-3" class="item auth-in" role="menuitem">Slot anlegen</a>
          <a href="https://api.terminmarktplatz.de/admin-rechnungen.html" class="item auth-in admin-only" role="menuitem" style="display:none;">Rechnungen (Admin)</a>
          <button class="item danger auth-in" data-action="delete" role="menuitem">Konto l√∂schen</button>

          <!-- immer sichtbar -->
          <a href="kontakt.html" class="item" role="menuitem">Kontakt</a>
          <a href="hilfe.html" class="item" role="menuitem">Hilfe</a>
        </div>
      </div>

      <!-- Hauptnavigation rechts -->
      <nav class="nav-links">
        <a href="anbieter.html">F√ºr Anbieter</a>
        <a href="suchende.html">F√ºr Suchende</a>
        <a href="preise.html">Preise</a>
      </nav>
    </div>
  </header>


  <main>
    <!-- HERO: Filterbar (√ºbernimmt URL-Parameter) -->
    <section class="hero" style="padding:34px 0 16px">
      <div class="container">
        <span class="badge">Suche</span>
        <h1>Freie Termine in deiner N√§he</h1>
        <p class="lead">Filter anpassen und direkt buchen ‚Äì ohne Anmeldung, mit E-Mail-Best√§tigung.</p>

        <form class="search-card" id="filters" method="get" role="search" aria-label="Suche">
          <div class="searchbar">
            <label class="input" aria-label="Leistung">
              üîé <input type="text" name="q" id="f-q" placeholder="z. B. Friseur Damen, Physio R√ºcken">
            </label>
            <label class="input" aria-label="PLZ oder Ort">
              üìç <input type="text" name="ort" id="f-ort" placeholder="PLZ / Stadt">
            </label>
            <label class="input" aria-label="Umkreis">
              <select name="radius" id="f-radius" title="Umkreis um PLZ">
                <option value="">Umkreis (optional)</option>
                <option value="5">5 km</option>
                <option value="10">10 km</option>
                <option value="25">25 km</option>
                <option value="50">50 km</option>
                <option value="75">75 km</option>
                <option value="100">100 km</option>
              </select>
            </label>

            <label class="input" aria-label="Datum">
              üìÖ <input type="date" id="search-day" name="day">
            </label>
            <label class="input" aria-label="Zeitfenster">
              ‚è∞ 
              <select name="zeit" id="f-zeit">
                <option value="">Beliebig</option>
                <option value="vormittag">Vormittag (08‚Äì12)</option>
                <option value="nachmittag">Nachmittag (12‚Äì17)</option>
                <option value="abend">Abend (17‚Äì21)</option>
              </select>
            </label>
            <button class="btn primary" type="submit">Aktualisieren</button>
          </div>
          <div class="trust">Es werden nur <strong>freie</strong> Slots angezeigt.</div>
        </form>
      </div>
    </section>

    <!-- RESULTATE -->
    <section>
      <div class="container">
        <div class="results-toolbar">
          <div class="pill" id="summary">Suche wird geladen ‚Ä¶</div>
          <div class="input" style="max-width:320px">
            <select id="sort">
              <option value="soonest">Sortieren: demn√§chst</option>
              <option value="latest">Sortieren: zuletzt</option>
            </select>
          </div>
        </div>

        <div id="results" class="features results-grid"></div>

        <div id="empty" class="panel" style="display:none; margin-top:10px">
          <h3>Keine Treffer</h3>
          <p class="muted">Tipp: Datum lockern, Umkreis/PLZ pr√ºfen oder ohne Stichwort suchen. Neue Slots kommen laufend rein.</p>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            <a class="btn primary" href="index.html">Zur√ºck zur Startseite</a>
          </div>
        </div>

        <div id="pager" style="display:none; margin-top:12px; text-align:center">
          <button id="more" class="btn">Mehr laden</button>
        </div>
      </div>
    </section>

    <!-- Google Maps Ergebnis-Karte (wird erst nach Suche eingeblendet) -->
    <section id="map-section" style="display:none; padding:0 0 32px;">
      <div class="container">
        <h2 style="margin-bottom:4px;">Standorte der gefundenen Termine</h2>
        <p class="muted" style="margin-top:0; margin-bottom:12px;">
          Pins anklicken f√ºr Anbieter-Infos und direkten Link zur Routenplanung.
        </p>
      </div>
      <div class="container">
        <div id="map" style="width:100%; height:420px; border-radius:18px; overflow:hidden; border:1px solid #e5e7eb;"></div>
        <p id="map-hint" class="muted" style="font-size:0.9rem; margin-top:8px;">
          Hinweis: F√ºr die Routenplanung wird ein neuer Tab mit Google&nbsp;Maps ge√∂ffnet.
        </p>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein">
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte L√∂sungen f√ºr deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">F√ºr Anbieter</a>
        <a class="foot-link" href="suchende.html">F√ºr Suchende</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>        <a class="foot-link" href="cookie-einstellungen.html">Cookie-Einstellungen</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">¬© <span id="y"></span> Terminmarktplatz ¬∑ Alle Rechte vorbehalten.</div>
  </footer>

  <!-- Quick-Book Modal - HTML5 Dialog f√ºr moderne Browser -->
  <dialog id="book-dialog" aria-labelledby="book-title">
    <div class="book-dialog-content">
      <h3 id="book-title" style="margin-top:0">Termin buchen</h3>
      <p id="book-sub" class="subtext" style="margin-bottom:10px">Bitte Name & E-Mail eingeben. Du erh√§ltst einen Best√§tigungslink.</p>
      <form id="book-form" style="display:grid; gap:10px; text-align:left">
        <input type="hidden" id="book-slot-id" />
        <label>Dein Name
          <input id="book-name" type="text" required autocomplete="name" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:16px">
        </label>
        <label>E-Mail
          <input id="book-email" type="email" required autocomplete="email" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:16px">
        </label>
        <div class="book-actions">
          <button type="button" class="btn booking-cancel-btn" id="book-cancel">Abbrechen</button>
          <button type="submit" class="btn primary" id="book-submit">Buchung anfragen</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Einfaches Mobile-Overlay - Garantiert funktioniert -->
  <div id="book-modal-mobile" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:999999; background:rgba(0,0,0,0.7); overflow-y:auto; -webkit-overflow-scrolling:touch;">
    <div style="min-height:100%; display:flex; align-items:flex-end; justify-content:center; padding:0;">
      <div style="background:#fff; width:100%; max-width:100%; border-radius:18px 18px 0 0; padding:24px 20px; box-shadow:0 -4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0; margin-bottom:8px; color:#111; font-size:20px;">Termin buchen</h3>
        <p style="margin-bottom:16px; color:#666; font-size:14px;">Bitte Name & E-Mail eingeben. Du erh√§ltst einen Best√§tigungslink.</p>
        <form id="book-form-mobile" style="display:block;">
          <input type="hidden" id="book-slot-id-mobile" />
          <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:6px; color:#111; font-weight:700; font-size:14px;">Dein Name</label>
            <input id="book-name-mobile" type="text" required autocomplete="name" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; -webkit-appearance:none;" />
          </div>
          <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:6px; color:#111; font-weight:700; font-size:14px;">E-Mail</label>
            <input id="book-email-mobile" type="email" required autocomplete="email" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; -webkit-appearance:none;" />
          </div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <button type="submit" class="btn primary" style="width:100%; padding:14px; font-size:16px; border:none; border-radius:12px; background:linear-gradient(135deg, #6f53ff, #06b6d4); color:#fff; font-weight:800; cursor:pointer;">Buchung anfragen</button>
            <button type="button" id="book-cancel-mobile" style="width:100%; padding:12px; font-size:15px; border:1px solid #ddd; border-radius:12px; background:#f5f5f5; color:#333; font-weight:700; cursor:pointer;">Abbrechen</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Jahr im Footer
    document.getElementById('y').textContent = new Date().getFullYear();

    // API-Basis
    const API = (()=> {
      const h = location.hostname;
      const proto = location.protocol;
      if (h === 'localhost' || h === '127.0.0.1') return 'http://127.0.0.1:5000';
      if (h.includes('testsystem') || h.includes('onrender.com')) {
        return `${proto}//${location.host}`;
      }
      return 'https://api.terminmarktplatz.de';
    })();

    // Utilities
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const fmtDateTime = (iso) => {
      const d = new Date(iso);
      return d.toLocaleString('de-DE', { weekday:'short', day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
    };
    const inZeitfenster = (iso, zeit) => {
      if (!zeit) return true;
      const h = new Date(iso).getHours();
      if (zeit === 'vormittag') return h >= 8 && h < 12;
      if (zeit === 'nachmittag') return h >= 12 && h < 17;
      if (zeit === 'abend') return h >= 17 && h < 21;
      return true;
    };
    const KATS = new Set(['Friseur','Kosmetik','Physiotherapie','Nagelstudio','Zahnarzt','Handwerk','KFZ-Service','Fitness','Coaching','Tierarzt','Beh√∂rde','Sonstiges']);

    // ---- Google Maps Integration ----
    let map = null;
    let geocoder = null;
    let infoWindow = null;
    let markers = [];
    let pendingMapItems = null;

    function clearMarkers(){
      if (!markers) return;
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    function updateMapForItems(mapItems){
      const section = document.getElementById('map-section');

      if (!mapItems || !mapItems.length){
        if (section) section.style.display = 'none';
        clearMarkers();
        return;
      }

      // Maps-Script noch nicht geladen -> Items zwischenspeichern
      if (typeof window.google === 'undefined' || !map || !geocoder){
        pendingMapItems = mapItems.slice();
        return;
      }

      if (section) section.style.display = 'block';

      clearMarkers();
      const bounds = new google.maps.LatLngBounds();

      mapItems.forEach(item => {
        if (!item.address) return;
        geocoder.geocode({ address: item.address }, (results, status) => {
          if (status !== 'OK' || !results || !results[0]) return;
          const loc = results[0].geometry.location;

          const marker = new google.maps.Marker({
            map,
            position: loc,
            title: item.providerName || item.slotTitle || 'Termin'
          });
          markers.push(marker);
          bounds.extend(loc);

        const content = `
          <div class="tm-slot-iw" style="font-size:13px; line-height:1.5;">
            <strong>${item.slotTitle || 'Termin'}</strong><br>
            ${item.startAt ? `${fmtDateTime(item.startAt)}<br>` : ''}
            <strong>Anbieter:</strong> ${item.providerName || 'Anbieter'}<br>
            ${item.category ? `<strong>Kategorie:</strong> ${item.category}<br>` : ''}
            ${item.address ? `<strong>Adresse:</strong> ${item.address}<br>` : ''}
            <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.address)}"
              target="_blank" rel="noopener">
              Route mit Google Maps planen
            </a>
          </div>
        `;




          marker.addListener('click', () => {
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
          });

          map.fitBounds(bounds);
        });
      });
    }

    // Wird von Google Maps Script als Callback aufgerufen
    function initMap(){
      const mapEl = document.getElementById('map');
      if (!mapEl || typeof window.google === 'undefined' || !google.maps) return;

      map = new google.maps.Map(mapEl, {
        center: { lat: 51.1657, lng: 10.4515 }, // Deutschland Mitte
        zoom: 6
      });
      geocoder = new google.maps.Geocoder();
      infoWindow = new google.maps.InfoWindow();

      if (pendingMapItems && pendingMapItems.length){
        const items = pendingMapItems;
        pendingMapItems = null;
        updateMapForItems(items);
      }
    }

    // URL-Parameter ‚Üí Filter √ºbernehmen
    const sp     = new URLSearchParams(location.search);
    const q      = (sp.get('q')||'').trim();
    const ort    = (sp.get('ort')||'').trim();
    const dayUrl = (sp.get('day')||'').trim();
    const zeit   = (sp.get('zeit')||'').trim().toLowerCase();
    const radius = (sp.get('radius')||'').trim();

    // Felder f√ºllen (damit Auswahl stehen bleibt)
    $('#f-q').value      = q;
    $('#f-ort').value    = ort;
    $('#f-zeit').value   = zeit;
    $('#f-radius').value = radius;
    const dayInput = document.getElementById('search-day');
    if (dayInput) dayInput.value = dayUrl;   // keine Auto-Setzung auf heute

    // Filterformular: GET-Reload ist ok
    $('#filters').addEventListener('submit', ()=>{ /* Standard-Submit gen√ºgt */ });

    // Fetch + Render
    async function load() {
      const summary = $('#summary');
      const results = $('#results');
      const empty   = $('#empty');
      const sortSel = $('#sort');

      results.innerHTML = '';
      empty.style.display = 'none';
      summary.textContent = 'Suche wird geladen ‚Ä¶';

      // URL-Parameter nach m√∂glichem Reload erneut lesen
      const s2    = new URLSearchParams(location.search);
      const q2    = (s2.get('q')||'').trim();
      const ort2  = (s2.get('ort')||'').trim();
      const day2  = (s2.get('day')||'').trim();
      const zeit2 = (s2.get('zeit')||'').trim().toLowerCase();
      const rad2  = (s2.get('radius')||'').trim();

      const hasSearch = !!(q2 || ort2 || day2 || zeit2 || rad2);

      // ---- API-Parameter (day optional + SLOT-LOCATION + radius)
      const params = new URLSearchParams();

      // Nur setzen, wenn der Nutzer ein Datum gew√§hlt hat
      if (day2) {
        params.set('day', day2);
      }

      const isExactCategory = q2 && KATS.has(q2);
      if (isExactCategory) {
        params.set('category', q2);
      } else if (q2) {
        // Wenn q2 kein exakte Kategorie ist, als Freitext-Suche senden
        params.set('q', q2);
      }

      // WICHTIG: Suche √ºber den Ort aus dem SLOT: ?location=
      if (ort2) {
        params.set('location', ort2);
      }

      if (rad2 && /^\d+$/.test(rad2)) params.set('radius', rad2);

      let data = [];
      try {
        const url = `${API}/public/slots` + (params.toString() ? `?${params.toString()}` : '');
        // credentials nicht n√∂tig f√ºr public API (besser f√ºr Facebook in-app Browser Kompatibilit√§t)
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API ${res.status}`);
        data = await res.json();
      } catch (e) {
        console.error(e);
        summary.textContent = 'Fehler beim Laden der Slots.';
        // Karte verstecken / Marker leeren
        const mapSection = document.getElementById('map-section');
        if (mapSection) mapSection.style.display = 'none';
        clearMarkers();
        return;
      }

      // Clientseitig nur noch Zeitfenster + Freitext (wenn keine exakte Kategorie)
      const kw = (q2 || '').toLowerCase();
      let items = data.filter(x => {
        const okZeit = inZeitfenster(x.start_at, zeit2);
        const okKW   = (isExactCategory || !kw)
          ? true
          : ((x.title||'').toLowerCase().includes(kw) || (x.category||'').toLowerCase().includes(kw));
        return okZeit && okKW;
      });

      // Sortierung
      items.sort((a,b) => {
        const da = new Date(a.start_at).getTime();
        const db = new Date(b.start_at).getTime();
        return (sortSel.value === 'latest') ? (db - da) : (da - db);
      });

      // Render
      if (items.length === 0) {
        summary.textContent = '0 Treffer';
        empty.style.display = 'block';
        const mapSection = document.getElementById('map-section');
        if (mapSection) mapSection.style.display = 'none';
        clearMarkers();
        return;
      }

      let datePart = '';
      if (day2) {
        datePart = `am ${ new Date(day2).toLocaleDateString('de-DE') }`;
      } else {
        datePart = 'in n√§chster Zeit';
      }

      summary.innerHTML = `${items.length} Treffer <span class="muted">
        ${ort2 ? `f√ºr ${ort2}` : 'f√ºr alle Orte'}
        ${rad2 ? ` (¬±${rad2} km)` : ''}
        ${datePart ? ` ${datePart}` : ''}
      </span>`;

      const frag = document.createDocumentFragment();
      const mapItems = [];

      items.forEach((x) => {
        // Provider-Infos aus Backend
        const p = x.provider || {};
        const providerName = p.name || p.company_name || p.email || 'Anbieter';
        const providerLogo = (p.logo_url || '').toString().trim();
        const providerInitial = (providerName || 'A').toString().trim().charAt(0).toUpperCase() || 'A';
        const providerBadge = providerLogo
          ? `<img class="provider-logo" src="${providerLogo}" alt="${providerName}">`
          : `<div class="provider-logo-fallback">${providerInitial}</div>`;
        const providerAddress =
          p.address
          || [p.street, [p.zip, p.city].filter(Boolean).join(' ')].filter(Boolean).join(', ')
          || '';

        const slotLine1 = [x.street, x.house_number].filter(Boolean).join(' ').trim();
        const slotLine2 = [x.zip, x.city].filter(Boolean).join(' ').trim();
        const slotAddress = [slotLine1, slotLine2].filter(Boolean).join(', ');

        // Adresse, wo der Termin stattfindet:
        // 1. strukturierte Slot-Adresse (street/house_number/zip/city)
        // 2. Slot.location (Termin-Ort)
        // KEIN Fallback auf Provider-Adresse, um Verwechslungen zu vermeiden
        let terminAddress = slotAddress || (x.location || '').trim() || '';
        const cityShow = x.provider_city || (p.city || '');

        const availableBadge = (typeof x.available === 'number')
          ? `<span class="pill" style="margin-left:8px">${x.available} frei</span>`
          : '';

       if (terminAddress) {
          mapItems.push({
            address: terminAddress,
            providerName,
            slotTitle: x.title || 'Termin',
            startAt: x.start_at,
            category: x.category || '',
            city: cityShow || ''
          });
        }


        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div>
              <h3>${x.title || 'Termin'} ${availableBadge}</h3>
              <p class="muted">
                <b>${fmtDateTime(x.start_at)}</b>
                ¬∑ Kategorie: ${x.category || '‚Äî'}
                ${cityShow ? ` ¬∑ Ort: ${cityShow}` : ''}
              </p>
              <div class="provider-row">
                ${providerBadge}
                <div class="muted"><strong>Anbieter:</strong> ${providerName}</div>
              </div>
              ${terminAddress ? `
                <p class="muted" style="margin:2px 0 0;">
                  <strong>Adresse:</strong> ${terminAddress}
                </p>` : ''}
              ${x.description ? `
                <p style="margin:8px 0 0; color:#475569; line-height:1.5;">
                  ${x.description}
                </p>` : ''}
            </div>
            <div>
              <button class="btn primary" data-book="${x.id}" type="button" style="touch-action: manipulation; -webkit-tap-highlight-color: transparent; cursor: pointer; pointer-events: auto; position: relative; z-index: 10;">Buchen</button>
            </div>
          </div>
        `;
        frag.appendChild(el);
      });
      results.appendChild(frag);

      // Karte nur anzeigen, wenn wirklich "gesucht" wurde (irgendein Filter gesetzt)
      // und es mindestens eine Adresse gibt.
      const mapSection = document.getElementById('map-section');
      if (hasSearch && mapItems.length > 0) {
        if (mapSection) mapSection.style.display = 'block';
        updateMapForItems(mapItems);
      } else {
        if (mapSection) mapSection.style.display = 'none';
        clearMarkers();
      }

      // Resort on change
      sortSel.onchange = () => load();
    }

    // Einfaches Buchungsmodal - Funktioniert garantiert auf Mobile
    const bookDialog = document.getElementById('book-dialog');
    const bookModalMobile = document.getElementById('book-modal-mobile');
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Formulare und Buttons f√ºr beide Systeme
    const bookForm = document.getElementById('book-form') || document.getElementById('book-form-fallback');
    const bookFormFallback = document.getElementById('book-form-fallback');
    
    // openBook Funktion - vor Event-Listenern definieren
    function openBook(slotId){
      if (!slotId) {
        alert('Fehler: Keine Slot-ID gefunden.');
        return;
      }
      
      // Mobile: Verwende einfaches Overlay (garantiert funktioniert)
      if (isMobile && bookModalMobile) {
        document.getElementById('book-slot-id-mobile').value = slotId;
        document.getElementById('book-name-mobile').value = '';
        document.getElementById('book-email-mobile').value = '';
        bookModalMobile.style.display = 'block';
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        window.scrollTo(0, 0);
        setTimeout(() => {
          const nameInput = document.getElementById('book-name-mobile');
          if (nameInput) nameInput.focus();
        }, 300);
        return;
      }
      
      // Desktop: Verwende HTML5 Dialog
      if (bookDialog && typeof bookDialog.showModal === 'function') {
        document.getElementById('book-slot-id').value = slotId;
        document.getElementById('book-name').value = '';
        document.getElementById('book-email').value = '';
        try {
          bookDialog.showModal();
          setTimeout(() => {
            const nameInput = document.getElementById('book-name');
            if (nameInput) nameInput.focus();
          }, 200);
        } catch (err) {
          if (bookModalMobile) openBook(slotId); // Fallback zu Mobile-Modal
        }
      } else if (bookModalMobile) {
        openBook(slotId); // Fallback zu Mobile-Modal
      }
    }
    
    function closeBook(){ 
      if (bookDialog) {
        try {
          bookDialog.close();
        } catch (err) {
          console.warn('Error closing dialog:', err);
        }
      }
      if (bookModalMobile) {
        bookModalMobile.style.display = 'none';
        bookModalMobile.style.visibility = 'hidden';
      }
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
    }
    
    // Event Listener f√ºr Mobile-Modal - Event-Delegation verwenden
    if (bookModalMobile) {
      // Event-Delegation: H√∂re auf alle Clicks im Modal-Container
      bookModalMobile.addEventListener('click', function(e) {
        // Pr√ºfe ob Abbrechen-Button geklickt wurde
        const cancelBtn = e.target.closest('#book-cancel-mobile');
        if (cancelBtn || e.target.id === 'book-cancel-mobile') {
          e.preventDefault();
          e.stopPropagation();
          closeBook();
          return false;
        }
        
        // Schlie√üen bei Klick auf Hintergrund (au√üerhalb des wei√üen Dialogs)
        if (e.target === bookModalMobile) {
          e.preventDefault();
          closeBook();
          return false;
        }
      });
      
      const bookFormMobile = document.getElementById('book-form-mobile');
      if (bookFormMobile) {
        bookFormMobile.addEventListener('submit', async (e) => {
          e.preventDefault();
          const slot_id = document.getElementById('book-slot-id-mobile').value;
          const name = document.getElementById('book-name-mobile').value.trim();
          const email = document.getElementById('book-email-mobile').value.trim();
          if (!slot_id || !name || !email) return;

          const btn = bookFormMobile.querySelector('button[type="submit"]');
          if (btn) {
            btn.disabled = true;
            btn.textContent = 'Wird gesendet...';
          }

          try{
            const r = await fetch(`${API}/public/book`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ slot_id, name, email })
            });
            const data = await r.json().catch(()=>({}));
            if (!r.ok || data.error){
              alert('Buchung leider nicht m√∂glich: ' + (data.error || 'Fehler'));
            } else {
              alert('Fast geschafft! Bitte best√§tige die Buchung √ºber den Link in deiner E-Mail.');
              closeBook();
            }
          } catch (err){
            alert('Netzwerkfehler ‚Äì bitte sp√§ter erneut versuchen.');
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Buchung anfragen';
            }
          }
        });
      }
    }
    
    // Event Listener f√ºr Desktop-Dialog - Event-Delegation verwenden
    if (bookDialog) {
      // Event-Delegation f√ºr Abbrechen-Button und Hintergrund-Klick
      bookDialog.addEventListener('click', function(e) {
        // Pr√ºfe ob Abbrechen-Button geklickt wurde
        if (e.target.id === 'book-cancel' || e.target.closest('#book-cancel')) {
          e.preventDefault();
          e.stopPropagation();
          closeBook();
          return false;
        }
        
        // Schlie√üen bei Klick auf Hintergrund
        if (e.target === bookDialog) {
          closeBook();
        }
      });
      
      // ESC-Taste
      bookDialog.addEventListener('cancel', function(e) {
        closeBook();
      });
      
      const bookForm = document.getElementById('book-form');
      if (bookForm) {
        bookForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const slot_id = document.getElementById('book-slot-id').value;
          const name = document.getElementById('book-name').value.trim();
          const email = document.getElementById('book-email').value.trim();
          if (!slot_id || !name || !email) return;

          const btn = document.getElementById('book-submit');
          if (btn) {
            btn.classList.add('loading');
            btn.disabled = true;
          }

          try{
            const r = await fetch(`${API}/public/book`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ slot_id, name, email })
            });
            const data = await r.json().catch(()=>({}));
            if (!r.ok || data.error){
              alert('Buchung leider nicht m√∂glich: ' + (data.error || 'Fehler'));
            } else {
              alert('Fast geschafft! Bitte best√§tige die Buchung √ºber den Link in deiner E-Mail.');
              closeBook();
            }
          } catch (err){
            alert('Netzwerkfehler ‚Äì bitte sp√§ter erneut versuchen.');
          } finally {
            if (btn) {
              btn.classList.remove('loading');
              btn.disabled = false;
            }
          }
        });
      }
    }

    // Event-Listener f√ºr Buchen-Buttons - NUR EINMAL registrieren (au√üerhalb von load())
    const resultsContainer = document.getElementById('results');
    if (resultsContainer) {
      resultsContainer.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-book]');
        if (btn) {
          e.preventDefault();
          e.stopPropagation();
          const slotId = btn.getAttribute('data-book');
          if (slotId && typeof openBook === 'function') {
            openBook(slotId);
          }
          return false;
        }
      }, true);
    }

    // Start
    load();

    // User-Men√º Logik (mobil) inkl. Auth-Status
    (function(){
      const APIforMenu = (typeof window.API === 'string')
        ? window.API
        : API;

      const btn  = document.getElementById('userMenuBtn');
      const menu = document.getElementById('userMenu');
      if(!btn || !menu) return;

      const authOutEls = menu.querySelectorAll('.auth-out');
      const authInEls  = menu.querySelectorAll('.auth-in');
      const adminOnlyEls = menu.querySelectorAll('.admin-only');

      function setAuthVisible(isLoggedIn, isAdmin){
        authOutEls.forEach(el => { el.style.display = isLoggedIn ? 'none' : ''; });
        authInEls.forEach(el  => { el.style.display  = isLoggedIn ? '' : 'none'; });
        adminOnlyEls.forEach(el => { el.style.display = (isLoggedIn && isAdmin) ? '' : 'none'; });
      }

      async function checkAuth(){
        try{
          const res = await fetch(`${APIforMenu}/me`, { credentials:'include' });
          if (res.ok) {
            const data = await res.json().catch(()=> null);
            setAuthVisible(true, data?.is_admin === true);
          } else {
            setAuthVisible(false, false);
          }
        }catch(e){
          setAuthVisible(false, false);
        }
      }

      function openMenu(open){
        menu.hidden = !open;
        btn.setAttribute('aria-expanded', String(open));
      }

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        openMenu(menu.hidden);
      });

      document.addEventListener('click', ()=> openMenu(false));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') openMenu(false); });

      menu.addEventListener('click', async (e)=>{
        const el = e.target.closest('.item');
        if(!el) return;
        const action = el.dataset.action;

        if(action === 'logout'){
          try{
            await fetch(`${APIforMenu}/auth/logout`, { method:'POST', credentials:'include' });
          }catch(_){}
          location.href = '/login.html';
        }

        if(action === 'delete'){
          const ok = confirm('Wirklich den gesamten Account mit allen Slots und Buchungen l√∂schen? Dieser Schritt ist endg√ºltig.');
          if(!ok) return;
          try{
            const res = await fetch(`${APIforMenu}/me`, { method:'DELETE', credentials:'include' });
            if(res.ok){
              location.href = '/login.html?deleted=1';
            }else{
              const data = await res.json().catch(()=>({}));
              alert(data?.error ? `L√∂schen fehlgeschlagen: ${data.error}` : 'L√∂schen fehlgeschlagen.');
            }
          }catch(err){
            alert('Netzwerkfehler ‚Äì bitte sp√§ter erneut versuchen.');
          }
        }
      });

      checkAuth();
    })();

  
      // Google Maps Script dynamisch laden ‚Äì Key direkt eingetragen
      (function () {
        const gmKey = "AIzaSyAYaQ0WOx05nwuCF5-JTc8CK0mc_XUjBvs";

        if (!gmKey) {
          console.warn('Kein GOOGLE_MAPS_API_KEY gesetzt ‚Äì Google Maps wird nicht geladen.');
          return;
        }

        const s = document.createElement('script');
        s.src =
          'https://maps.googleapis.com/maps/api/js?key=' +
          encodeURIComponent(gmKey) +
          '&callback=initMap&libraries=places';
        s.async = true;
        s.defer = true;
        document.body.appendChild(s);
      })();
    </script>

  <!-- Google Analytics - nur nach Consent laden -->
  <script>
    (function(){
      const cookieKey = 'tm_cookie_consent_v8';
      if (localStorage.getItem(cookieKey) === 'accepted') {
        const script1 = document.createElement('script');
        script1.async = true;
        script1.src = 'https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R';
        document.head.appendChild(script1);
        
        const script2 = document.createElement('script');
        script2.innerHTML = `
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YNZ8GW523R');
        `;
        document.head.appendChild(script2);
      }
    })();
  </script>
  </body>
</html>



