<!-- FILE: suche.html -->  
<!doctype html>
<html lang="de">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-YNZ8GW523R');
  </script>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suche ‚Äì Freie Termine | Terminmarktplatz</title>
  <meta name="description" content="Finde freie Termine nach Kategorie, Ort und Datum. Ohne Anmeldung direkt buchen ‚Äì mit E-Mail-Best√§tigung." />
  <meta name="theme-color" content="#6f53ff" />

  <!-- OG -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Suche ‚Äì Freie Termine" />
  <meta property="og:description" content="Freie Termine in deiner N√§he finden und direkt buchen." />
  <meta property="og:site_name" content="Terminmarktplatz" />
  <meta property="og:image" content="/static/og-cover.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <base href="/">
  <link rel="icon" href="/static/favicon.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css?v=20251010" />

  <!-- Page-spezifische Optimierung (v. a. mobil) -->
  <style>
    /* 1) Kein horizontales Scrollen */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Standard: auth-in zun√§chst ausblenden ‚Äì JS zeigt sie bei Login */
    .auth-in {
      display: none;
    }

    /* Wei√üer Men√º-Button wie auf agb/preise */
    .user-menu .btn {
      background:#ffffff;
      color:#0f172a;
      border:1px solid #cbd5e1;
      text-shadow:none;
      background-image:none;
    }

    /* HEADER + MEN√ú ‚Äì Men√º direkt hinter Brand, Nav rechts */
    header .nav{
      display:flex;
      align-items:center;
      gap:16px;
    }
    header .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    header .user-menu{
      display:block;          /* immer sichtbar */
      position:relative;
      z-index:60;
      margin-left:12px;       /* Abstand hinter ‚ÄûTerminmarktplatz‚Äú */
    }
    header .nav-links{
      display:flex;
      align-items:center;
      gap:16px;
      margin-left:auto;       /* schiebt Links nach rechts */
    }

    .cta-group {
      display:flex;
      gap:8px;
      margin-left:auto;
    }

    /* Nur dieser Abbrechen-Button im Buchungsdialog */
    .booking-cancel-btn {
      background: rgba(111, 83, 255, 0.08);
      border: 1px solid rgba(111, 83, 255, 0.35);
      color: #111827;
      box-shadow: none;
    }
    .booking-cancel-btn:hover {
      background: rgba(111, 83, 255, 0.16);
      border-color: rgba(111, 83, 255, 0.7);
    }

    /* Toolbar √ºber den Ergebnissen */
    .results-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* Ergebnis-Grid */
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Actions im Buchungsdialog */
    .book-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 6px;
    }

    /* Popup-Dialog zentrieren und begrenzen */
    .loading-backdrop {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .loading-dialog {
      max-width: 480px;
      width: 100%;
      box-sizing: border-box;
    }

    /* Mobile Optimierungen */
    @media (max-width: 768px) {
      /* Header / Navigation ‚Äì wie agb/preise */
      header .nav{
        flex-wrap:wrap;
        align-items:flex-start;
        gap:8px;
        padding-inline:16px;
      }

      header .brand-title{
        font-size:1.05rem;
      }

      /* Brand links, Men√º rechts in der ersten Zeile */
      header .user-menu{
        margin-left:auto;
      }

      /* Links in Zeile 2, zentriert */
      header .nav-links{
        width:100%;
        justify-content:center;
        flex-wrap:wrap;
        gap:8px;
        text-align:center;
        margin-left:0;
        margin-top:4px;
      }

      header .nav-links a{
        font-size:0.9rem;
        padding:2px 6px;
      }

      /* CTA-Gruppe auf Mobile ausblenden (falls vorhanden) */
      .cta-group{
        display:none !important;
      }

      .hero {
        padding: 20px 0 12px;
      }
      .hero h1 {
        font-size: 1.6rem;
      }
      .hero .lead {
        font-size: 0.95rem;
      }

      .search-card {
        padding: 12px;
      }

      .searchbar {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .searchbar .input {
        width: 100%;
      }

      .searchbar .input input,
      .searchbar .input select {
        width: 100%;
      }

      .searchbar .btn.primary {
        width: 100%;
        justify-content: center;
        margin-top: 4px;
      }

      .results-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 12px;
      }

      /* Popup auf Mobil full-width und Buttons untereinander */
      .loading-dialog {
        max-width: 420px;
        width: 100%;
        margin: 0;
        padding: 16px 14px;
        border-radius: 18px;
      }

      .book-actions {
        flex-direction: column-reverse;
        align-items: stretch;
      }
      .book-actions .btn {
        width: 100%;
        justify-content: center;
      }

      /* Footer untereinander */
      .foot-grid{
        display:grid;
        grid-template-columns:1fr;
        gap:16px;
      }
      .foot-col{
        margin-top:4px;
      }
    }

    @media (min-width: 769px){
      .cta-group {
        display:flex;
      }
    }
      /* Text im Google-Maps-Infofenster immer dunkel halten */
      #map .gm-style .tm-slot-iw {
        color: #111827 !important;       /* dunkles Grau */
        text-shadow: none !important;
      }

      #map .gm-style .tm-slot-iw a {
        color: #1d4ed8 !important;       /* Linkfarbe */
        text-decoration: underline;
      }

      #map .gm-style .tm-slot-iw strong {
        color: #111827 !important;
      }

  </style>
  <script>
  (function(){
    const API = (typeof window.API === 'string')
      ? window.API
      : ((h) => (h === 'localhost' || h === '127.0.0.1')
            ? 'http://127.0.0.1:5000'
            : 'https://api.terminmarktplatz.de')(location.hostname);

    const btn  = document.getElementById('userMenuBtn');
    const menu = document.getElementById('userMenu');
    if (!btn || !menu) return;

    function openMenu(open){
      menu.hidden = !open;
      btn.setAttribute('aria-expanded', String(open));
    }

    // Men√º ein-/ausklappen
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      openMenu(menu.hidden);
    });

    document.addEventListener('click', ()=> openMenu(false));
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') openMenu(false); });

    // Login-Status -> auth-in / auth-out steuern
    async function updateAuthUI(){
      let loggedIn = false;
      try{
        const res = await fetch(`${API}/me`, { credentials:'include' });
        loggedIn = res.ok;
      }catch(e){
        loggedIn = false;
      }

      document.querySelectorAll('.auth-in').forEach(el => {
        el.style.display = loggedIn ? '' : 'none';
      });
      document.querySelectorAll('.auth-out').forEach(el => {
        el.style.display = loggedIn ? 'none' : '';
      });
    }

    updateAuthUI();
  })();
  </script>

</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav"
         role="navigation"
         aria-label="Hauptnavigation">
      <!-- Logo / Brand -->
      <a class="brand" href="index.html" aria-label="Startseite">
        <div class="brand-logo" aria-hidden="true">
          <img src="/static/terminmarktplatz-logo.png"
               alt="Terminmarktplatz Logo"
               width="50" height="50">
        </div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>

      <!-- User-Men√º direkt hinter ‚ÄûTerminmarktplatz‚Äú -->
      <div class="user-menu">
        <button id="userMenuBtn" class="btn" aria-haspopup="menu" aria-expanded="false">
          ‚ò∞ Men√º
        </button>
        <div id="userMenu" class="menu" role="menu" hidden>
          <!-- nur sichtbar, wenn NICHT eingeloggt -->
          <a href="login.html?tab=login" class="item auth-out" role="menuitem">Anmelden</a>

          <!-- nur sichtbar, wenn eingeloggt -->
          <button type="button" class="item auth-in" data-action="logout" role="menuitem">Abmelden</button>
          <a href="anbieter-portal.html" class="item auth-in" role="menuitem">Profil</a>
          <a href="anbieter-portal.html#step-3" class="item auth-in" role="menuitem">Slot anlegen</a>
          <button class="item danger auth-in" data-action="delete" role="menuitem">Konto l√∂schen</button>

          <!-- immer sichtbar -->
          <a href="kontakt.html" class="item" role="menuitem">Kontakt</a>
        </div>
      </div>

      <!-- Hauptnavigation rechts -->
      <nav class="nav-links">
        <a href="anbieter.html">F√ºr Anbieter</a>
        <a href="suchende.html">F√ºr Suchende</a>
        <a href="preise.html">Preise</a>
      </nav>
    </div>
  </header>


  <main>
    <!-- HERO: Filterbar (√ºbernimmt URL-Parameter) -->
    <section class="hero" style="padding:34px 0 16px">
      <div class="container">
        <span class="badge">Suche</span>
        <h1>Freie Termine in deiner N√§he</h1>
        <p class="lead">Filter anpassen und direkt buchen ‚Äì ohne Anmeldung, mit E-Mail-Best√§tigung.</p>

        <form class="search-card" id="filters" method="get" role="search" aria-label="Suche">
          <div class="searchbar">
            <label class="input" aria-label="Leistung">
              üîé <input type="text" name="q" id="f-q" placeholder="z. B. Friseur Damen, Physio R√ºcken">
            </label>
            <label class="input" aria-label="PLZ oder Ort">
              üìç <input type="text" name="ort" id="f-ort" placeholder="PLZ / Stadt">
            </label>
            <label class="input" aria-label="Umkreis">
              <select name="radius" id="f-radius" title="Umkreis um PLZ">
                <option value="">Umkreis (optional)</option>
                <option value="5">5 km</option>
                <option value="10">10 km</option>
                <option value="25">25 km</option>
                <option value="50">50 km</option>
                <option value="75">75 km</option>
                <option value="100">100 km</option>
              </select>
            </label>

            <label class="input" aria-label="Datum">
              üìÖ <input type="date" id="search-day" name="day">
            </label>
            <label class="input" aria-label="Zeitfenster">
              ‚è∞ 
              <select name="zeit" id="f-zeit">
                <option value="">Beliebig</option>
                <option value="vormittag">Vormittag (08‚Äì12)</option>
                <option value="nachmittag">Nachmittag (12‚Äì17)</option>
                <option value="abend">Abend (17‚Äì21)</option>
              </select>
            </label>
            <button class="btn primary" type="submit">Aktualisieren</button>
          </div>
          <div class="trust">Es werden nur <strong>freie</strong> Slots angezeigt.</div>
        </form>
      </div>
    </section>

    <!-- RESULTATE -->
    <section>
      <div class="container">
        <div class="results-toolbar">
          <div class="pill" id="summary">Suche wird geladen ‚Ä¶</div>
          <div class="input" style="max-width:320px">
            <select id="sort">
              <option value="soonest">Sortieren: demn√§chst</option>
              <option value="latest">Sortieren: zuletzt</option>
            </select>
          </div>
        </div>

        <div id="results" class="features results-grid"></div>

        <div id="empty" class="panel" style="display:none; margin-top:10px">
          <h3>Keine Treffer</h3>
          <p class="muted">Tipp: Datum lockern, Umkreis/PLZ pr√ºfen oder ohne Stichwort suchen. Neue Slots kommen laufend rein.</p>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            <a class="btn primary" href="index.html">Zur√ºck zur Startseite</a>
          </div>
        </div>

        <div id="pager" style="display:none; margin-top:12px; text-align:center">
          <button id="more" class="btn">Mehr laden</button>
        </div>
      </div>
    </section>

    <!-- Google Maps Ergebnis-Karte (wird erst nach Suche eingeblendet) -->
    <section id="map-section" style="display:none; padding:0 0 32px;">
      <div class="container">
        <h2 style="margin-bottom:4px;">Standorte der gefundenen Termine</h2>
        <p class="muted" style="margin-top:0; margin-bottom:12px;">
          Pins anklicken f√ºr Anbieter-Infos und direkten Link zur Routenplanung.
        </p>
      </div>
      <div class="container">
        <div id="map" style="width:100%; height:420px; border-radius:18px; overflow:hidden; border:1px solid #e5e7eb;"></div>
        <p id="map-hint" class="muted" style="font-size:0.9rem; margin-top:8px;">
          Hinweis: F√ºr die Routenplanung wird ein neuer Tab mit Google&nbsp;Maps ge√∂ffnet.
        </p>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein">
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte L√∂sungen f√ºr deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">F√ºr Anbieter</a>
        <a class="foot-link" href="suchende.html">F√ºr Suchende</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">¬© <span id="y"></span> Terminmarktplatz ¬∑ Alle Rechte vorbehalten.</div>
  </footer>

  <!-- Quick-Book Modal -->
  <div id="book-backdrop" class="loading-backdrop" hidden aria-live="polite" aria-atomic="true">
    <div class="loading-dialog" role="dialog" aria-modal="true" aria-labelledby="book-title">
      <h3 id="book-title" style="margin-top:0">Termin buchen</h3>
      <p id="book-sub" class="subtext" style="margin-bottom:10px">Bitte Name & E-Mail eingeben. Du erh√§ltst einen Best√§tigungslink.</p>
      <form id="book-form" style="display:grid; gap:10px; text-align:left">
        <input type="hidden" id="book-slot-id" />
        <label>Dein Name
          <input id="book-name" type="text" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px">
        </label>
        <label>E-Mail
          <input id="book-email" type="email" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px">
        </label>
        <div class="book-actions">
          <button type="button" class="btn booking-cancel-btn" id="book-cancel">Abbrechen</button>
          <button type="submit" class="btn primary" id="book-submit">Buchung anfragen</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Jahr im Footer
    document.getElementById('y').textContent = new Date().getFullYear();

    // API-Basis
    const API = (()=> {
      const h = location.hostname;
      if (h === 'localhost' || h === '127.0.0.1') return 'http://127.0.0.1:5000';
      return 'https://api.terminmarktplatz.de';
    })();

    // Utilities
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const fmtDateTime = (iso) => {
      const d = new Date(iso);
      return d.toLocaleString('de-DE', { weekday:'short', day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
    };
    const inZeitfenster = (iso, zeit) => {
      if (!zeit) return true;
      const h = new Date(iso).getHours();
      if (zeit === 'vormittag') return h >= 8 && h < 12;
      if (zeit === 'nachmittag') return h >= 12 && h < 17;
      if (zeit === 'abend') return h >= 17 && h < 21;
      return true;
    };
    const KATS = new Set(['Friseur','Kosmetik','Physiotherapie','Nagelstudio','Zahnarzt','Handwerk','KFZ-Service','Fitness','Coaching','Tierarzt','Beh√∂rde','Sonstiges']);

    // ---- Google Maps Integration ----
    let map = null;
    let geocoder = null;
    let infoWindow = null;
    let markers = [];
    let pendingMapItems = null;

    function clearMarkers(){
      if (!markers) return;
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    function updateMapForItems(mapItems){
      const section = document.getElementById('map-section');

      if (!mapItems || !mapItems.length){
        if (section) section.style.display = 'none';
        clearMarkers();
        return;
      }

      // Maps-Script noch nicht geladen -> Items zwischenspeichern
      if (typeof window.google === 'undefined' || !map || !geocoder){
        pendingMapItems = mapItems.slice();
        return;
      }

      if (section) section.style.display = 'block';

      clearMarkers();
      const bounds = new google.maps.LatLngBounds();

      mapItems.forEach(item => {
        if (!item.address) return;
        geocoder.geocode({ address: item.address }, (results, status) => {
          if (status !== 'OK' || !results || !results[0]) return;
          const loc = results[0].geometry.location;

          const marker = new google.maps.Marker({
            map,
            position: loc,
            title: item.providerName || item.slotTitle || 'Termin'
          });
          markers.push(marker);
          bounds.extend(loc);

        const content = `
          <div class="tm-slot-iw" style="font-size:13px; line-height:1.5;">
            <strong>${item.slotTitle || 'Termin'}</strong><br>
            ${item.startAt ? `${fmtDateTime(item.startAt)}<br>` : ''}
            <strong>Anbieter:</strong> ${item.providerName || 'Anbieter'}<br>
            ${item.category ? `<strong>Kategorie:</strong> ${item.category}<br>` : ''}
            ${item.address ? `<strong>Adresse:</strong> ${item.address}<br>` : ''}
            <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.address)}"
              target="_blank" rel="noopener">
              Route mit Google Maps planen
            </a>
          </div>
        `;




          marker.addListener('click', () => {
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
          });

          map.fitBounds(bounds);
        });
      });
    }

    // Wird von Google Maps Script als Callback aufgerufen
    function initMap(){
      const mapEl = document.getElementById('map');
      if (!mapEl || typeof window.google === 'undefined' || !google.maps) return;

      map = new google.maps.Map(mapEl, {
        center: { lat: 51.1657, lng: 10.4515 }, // Deutschland Mitte
        zoom: 6
      });
      geocoder = new google.maps.Geocoder();
      infoWindow = new google.maps.InfoWindow();

      if (pendingMapItems && pendingMapItems.length){
        const items = pendingMapItems;
        pendingMapItems = null;
        updateMapForItems(items);
      }
    }

    // URL-Parameter ‚Üí Filter √ºbernehmen
    const sp     = new URLSearchParams(location.search);
    const q      = (sp.get('q')||'').trim();
    const ort    = (sp.get('ort')||'').trim();
    const dayUrl = (sp.get('day')||'').trim();
    const zeit   = (sp.get('zeit')||'').trim().toLowerCase();
    const radius = (sp.get('radius')||'').trim();

    // Felder f√ºllen (damit Auswahl stehen bleibt)
    $('#f-q').value      = q;
    $('#f-ort').value    = ort;
    $('#f-zeit').value   = zeit;
    $('#f-radius').value = radius;
    const dayInput = document.getElementById('search-day');
    if (dayInput) dayInput.value = dayUrl;   // keine Auto-Setzung auf heute

    // Filterformular: GET-Reload ist ok
    $('#filters').addEventListener('submit', ()=>{ /* Standard-Submit gen√ºgt */ });

    // Fetch + Render
    async function load() {
      const summary = $('#summary');
      const results = $('#results');
      const empty   = $('#empty');
      const sortSel = $('#sort');

      results.innerHTML = '';
      empty.style.display = 'none';
      summary.textContent = 'Suche wird geladen ‚Ä¶';

      // URL-Parameter nach m√∂glichem Reload erneut lesen
      const s2    = new URLSearchParams(location.search);
      const q2    = (s2.get('q')||'').trim();
      const ort2  = (s2.get('ort')||'').trim();
      const day2  = (s2.get('day')||'').trim();
      const zeit2 = (s2.get('zeit')||'').trim().toLowerCase();
      const rad2  = (s2.get('radius')||'').trim();

      const hasSearch = !!(q2 || ort2 || day2 || zeit2 || rad2);

      // ---- API-Parameter (day optional + SLOT-LOCATION + radius)
      const params = new URLSearchParams();

      // Nur setzen, wenn der Nutzer ein Datum gew√§hlt hat
      if (day2) {
        params.set('day', day2);
      }

      const isExactCategory = q2 && KATS.has(q2);
      if (isExactCategory) {
        params.set('category', q2);
      } else if (q2) {
        // Wenn q2 kein exakte Kategorie ist, als Freitext-Suche senden
        params.set('q', q2);
      }

      // WICHTIG: Suche √ºber den Ort aus dem SLOT: ?location=
      if (ort2) {
        params.set('location', ort2);
      }

      if (rad2 && /^\d+$/.test(rad2)) params.set('radius', rad2);

      let data = [];
      try {
        const url = `${API}/public/slots` + (params.toString() ? `?${params.toString()}` : '');
        const res = await fetch(url, { credentials:'include' });
        if (!res.ok) throw new Error(`API ${res.status}`);
        data = await res.json();
      } catch (e) {
        console.error(e);
        summary.textContent = 'Fehler beim Laden der Slots.';
        // Karte verstecken / Marker leeren
        const mapSection = document.getElementById('map-section');
        if (mapSection) mapSection.style.display = 'none';
        clearMarkers();
        return;
      }

      // Clientseitig nur noch Zeitfenster + Freitext (wenn keine exakte Kategorie)
      const kw = (q2 || '').toLowerCase();
      let items = data.filter(x => {
        const okZeit = inZeitfenster(x.start_at, zeit2);
        const okKW   = (isExactCategory || !kw)
          ? true
          : ((x.title||'').toLowerCase().includes(kw) || (x.category||'').toLowerCase().includes(kw));
        return okZeit && okKW;
      });

      // Sortierung
      items.sort((a,b) => {
        const da = new Date(a.start_at).getTime();
        const db = new Date(b.start_at).getTime();
        return (sortSel.value === 'latest') ? (db - da) : (da - db);
      });

      // Render
      if (items.length === 0) {
        summary.textContent = '0 Treffer';
        empty.style.display = 'block';
        const mapSection = document.getElementById('map-section');
        if (mapSection) mapSection.style.display = 'none';
        clearMarkers();
        return;
      }

      let datePart = '';
      if (day2) {
        datePart = `am ${ new Date(day2).toLocaleDateString('de-DE') }`;
      } else {
        datePart = 'in n√§chster Zeit';
      }

      summary.innerHTML = `${items.length} Treffer <span class="muted">
        ${ort2 ? `f√ºr ${ort2}` : 'f√ºr alle Orte'}
        ${rad2 ? ` (¬±${rad2} km)` : ''}
        ${datePart ? ` ${datePart}` : ''}
      </span>`;

      const frag = document.createDocumentFragment();
      const mapItems = [];

      items.forEach((x) => {
        // Provider-Infos aus Backend
        const p = x.provider || {};
        const providerName = p.name || p.company_name || p.email || 'Anbieter';
        const providerAddress =
          p.address
          || [p.street, [p.zip, p.city].filter(Boolean).join(' ')].filter(Boolean).join(', ')
          || '';

        // Adresse, wo der Termin stattfindet:
        // 1. Slot.location (Termin-Ort)
        // 2. Fallback: Provider-Adresse
        const terminAddress = x.location || providerAddress || '';
        const cityShow = x.provider_city || (p.city || '');

        const availableBadge = (typeof x.available === 'number')
          ? `<span class="pill" style="margin-left:8px">${x.available} frei</span>`
          : '';

       if (terminAddress) {
          mapItems.push({
            address: terminAddress,
            providerName,
            slotTitle: x.title || 'Termin',
            startAt: x.start_at,
            category: x.category || '',
            city: cityShow || ''
          });
        }


        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div>
              <h3>${x.title || 'Termin'} ${availableBadge}</h3>
              <p class="muted">
                <b>${fmtDateTime(x.start_at)}</b>
                ¬∑ Kategorie: ${x.category || '‚Äî'}
                ${cityShow ? ` ¬∑ Ort: ${cityShow}` : ''}
              </p>
              <p class="muted" style="margin:4px 0 0;">
                <strong>Anbieter:</strong> ${providerName}
              </p>
              ${terminAddress ? `
                <p class="muted" style="margin:2px 0 0;">
                  <strong>Adresse:</strong> ${terminAddress}
                </p>` : ''}
            </div>
            <div>
              <button class="btn primary" data-book="${x.id}">Buchen</button>
            </div>
          </div>
        `;
        frag.appendChild(el);
      });
      results.appendChild(frag);

      // Karte nur anzeigen, wenn wirklich "gesucht" wurde (irgendein Filter gesetzt)
      // und es mindestens eine Adresse gibt.
      const mapSection = document.getElementById('map-section');
      if (hasSearch && mapItems.length > 0) {
        if (mapSection) mapSection.style.display = 'block';
        updateMapForItems(mapItems);
      } else {
        if (mapSection) mapSection.style.display = 'none';
        clearMarkers();
      }

      // Buchen-Buttons
      $$('#results [data-book]').forEach(btn => {
        btn.addEventListener('click', () => openBook(btn.dataset.book));
      });

      // Resort on change
      sortSel.onchange = () => load();
    }

    // Quick-Book Modal
    const bookBackdrop = document.getElementById('book-backdrop');
    const bookForm     = document.getElementById('book-form');
    const bookCancel   = document.getElementById('book-cancel');
    function openBook(slotId){
      document.getElementById('book-slot-id').value = slotId;
      document.getElementById('book-name').value = '';
      document.getElementById('book-email').value = '';
      bookBackdrop.hidden = false;
    }
    function closeBook(){ bookBackdrop.hidden = true; }
    bookCancel.addEventListener('click', closeBook);
    bookBackdrop.addEventListener('click', (e)=>{ if (e.target === bookBackdrop) closeBook(); });

    bookForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const slot_id = document.getElementById('book-slot-id').value;
      const name = document.getElementById('book-name').value.trim();
      const email = document.getElementById('book-email').value.trim();
      if (!slot_id || !name || !email) return;

      const btn = document.getElementById('book-submit');
      btn.classList.add('loading'); btn.disabled = true;

      try{
        const r = await fetch(`${API}/public/book`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ slot_id, name, email })
        });
        const data = await r.json().catch(()=>({}));
        if (!r.ok || data.error){
          alert('Buchung leider nicht m√∂glich: ' + (data.error || 'Fehler'));
        } else {
          alert('Fast geschafft! Bitte best√§tige die Buchung √ºber den Link in deiner E-Mail.');
          closeBook();
        }
      } catch (err){
        alert('Netzwerkfehler ‚Äì bitte sp√§ter erneut versuchen.');
      } finally {
        btn.classList.remove('loading'); btn.disabled = false;
      }
    });

    // Start
    load();

    // User-Men√º Logik (mobil) inkl. Auth-Status
    (function(){
      const APIforMenu = (typeof window.API === 'string')
        ? window.API
        : API;

      const btn  = document.getElementById('userMenuBtn');
      const menu = document.getElementById('userMenu');
      if(!btn || !menu) return;

      const authOutEls = menu.querySelectorAll('.auth-out');
      const authInEls  = menu.querySelectorAll('.auth-in');

      function setAuthVisible(isLoggedIn){
        authOutEls.forEach(el => { el.style.display = isLoggedIn ? 'none' : ''; });
        authInEls.forEach(el  => { el.style.display  = isLoggedIn ? '' : 'none'; });
      }

      async function checkAuth(){
        try{
          const res = await fetch(`${APIforMenu}/me`, { credentials:'include' });
          setAuthVisible(res.ok);
        }catch(e){
          setAuthVisible(false);
        }
      }

      function openMenu(open){
        menu.hidden = !open;
        btn.setAttribute('aria-expanded', String(open));
      }

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        openMenu(menu.hidden);
      });

      document.addEventListener('click', ()=> openMenu(false));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') openMenu(false); });

      menu.addEventListener('click', async (e)=>{
        const el = e.target.closest('.item');
        if(!el) return;
        const action = el.dataset.action;

        if(action === 'logout'){
          try{
            await fetch(`${APIforMenu}/auth/logout`, { method:'POST', credentials:'include' });
          }catch(_){}
          location.href = '/login.html';
        }

        if(action === 'delete'){
          const ok = confirm('Wirklich den gesamten Account mit allen Slots und Buchungen l√∂schen? Dieser Schritt ist endg√ºltig.');
          if(!ok) return;
          try{
            const res = await fetch(`${APIforMenu}/me`, { method:'DELETE', credentials:'include' });
            if(res.ok){
              location.href = '/login.html?deleted=1';
            }else{
              const data = await res.json().catch(()=>({}));
              alert(data?.error ? `L√∂schen fehlgeschlagen: ${data.error}` : 'L√∂schen fehlgeschlagen.');
            }
          }catch(err){
            alert('Netzwerkfehler ‚Äì bitte sp√§ter erneut versuchen.');
          }
        }
      });

      checkAuth();
    })();

  
      // Google Maps Script dynamisch laden ‚Äì Key direkt eingetragen
      (function () {
        const gmKey = "AIzaSyAYaQ0WOx05nwuCF5-JTc8CK0mc_XUjBvs";

        if (!gmKey) {
          console.warn('Kein GOOGLE_MAPS_API_KEY gesetzt ‚Äì Google Maps wird nicht geladen.');
          return;
        }

        const s = document.createElement('script');
        s.src =
          'https://maps.googleapis.com/maps/api/js?key=' +
          encodeURIComponent(gmKey) +
          '&callback=initMap&libraries=places';
        s.async = true;
        s.defer = true;
        document.body.appendChild(s);
      })();
    </script>
  </body>
</html>

