<!-- FILE: login.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anbieter – Anmelden & Registrieren | Terminmarktplatz</title>
  <meta name="description" content="Anbieter-Login und Registrierung für Terminmarktplatz. Erstelle dein Konto, melde dich an und vervollständige dein Profil (Branche, Kontaktdaten, Ort)." />
  <meta name="theme-color" content="#6f53ff" />

  <!-- OG -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Anbieter – Anmelden & Registrieren" />
  <meta property="og:description" content="Jetzt Anbieter werden, freie Slots veröffentlichen und No-Shows reduzieren." />
  <meta property="og:site_name" content="Terminmarktplatz" />
  <meta property="og:image" content="static/og-cover.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Root-relative Pfade -->
  <base href="/" />

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-YNZ8GW523R');
  </script>

  <!-- Assets -->
  <link rel="icon" href="static/favicon.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="static/style.css?v=20251107" />

  <!-- Seitenstil: Panels dunkel, Eingabefelder hell + Menü wie index/kontakt -->
  <style>
    /* Weißer Menü-Button wie auf index/kategorie/impressum/kontakt */
    .user-menu .btn {
      background:#ffffff;
      color:#0f172a;
      border:1px solid #cbd5e1;
      text-shadow:none;
      background-image:none;
    }

    /* Standard: Desktop-Nav sichtbar, Burger aus */
    .user-menu {
      display:none;
    }

    .nav-links {
      display:flex;
      gap:12px;
      align-items:center;
      margin-left:auto;
    }

    .cta-group {
      display:flex;
      gap:8px;
      margin-left:auto;
    }

    @media (min-width: 769px){
      .user-menu {
        display:none;
      }
      .nav-links {
        display:flex;
      }
      .cta-group {
        display:flex;
      }
    }

    /* Tabs */
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 0; justify-content:center}
    .tab-btn{
      padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:700;
      border:1px solid var(--border); color:#fff; background:rgba(255,255,255,.06);
      box-shadow:var(--shadow-1); transition:.15s
    }
    .tab-btn:hover{transform:translateY(-2px)}
    .tab-btn.active{background:linear-gradient(135deg, var(--c-purple), var(--c-cyan)); border:none}

    /* Panels hier bewusst dunkel */
    .page-login .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)) !important;
      border: 1px solid var(--border) !important;
      color: var(--ink) !important;
      border-radius: var(--r-3xl);
      box-shadow: var(--shadow-2);
      padding: 18px;
    }
    .page-login .panel h1,
    .page-login .panel h2,
    .page-login .panel h3,
    .page-login .panel p,
    .page-login .panel li{ color: var(--ink) }
    .page-login .panel .muted{ color: var(--ink-dim) }

    /* Form-Gitter & Felder */
    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .form-grid .col-1{grid-column:span 1} .form-grid .col-2{grid-column:span 2}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-weight:700}
    .field input,.field select,.field textarea{
      border:1px solid var(--border); border-radius:12px; padding:12px;
      background:#fff; color:#0f172a
    }
    .form-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .form-note{color:var(--ink-dim); font-size:13px}
    .form-alert{display:none; border:1px solid #ef4444; color:#7f1d1d; background:#fee2e2; padding:10px; border-radius:12px}
    .form-success{display:none; border:1px solid #16a34a; color:#065f46; background:#dcfce7; padding:10px; border-radius:12px}
    .hint{font-size:13px; color:#64748b}
    .divider{height:1px; background:var(--border); margin:14px 0}

    /* Info-Banner über Tabs */
    #form-info{display:none; margin:0 auto 16px; max-width:980px; padding:12px 14px; border-radius:12px; font-weight:700}
    #form-info.success{background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.35); color:#bbf7d0}
    #form-info.error{background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); color:#fecaca}
    #form-info.warn{background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.35); color:#fde68a}

    @media (max-width: 880px){
      .form-grid{grid-template-columns:1fr}
      .form-grid .col-2{grid-column:span 1}
    }

    /* Mobile-Optimierung Login-Seite + Menü-Verhalten wie index/kontakt */
    @media (max-width: 768px) {
      /* Header / Navigation */
      .container.nav {
        flex-wrap: wrap;
        gap: 8px;
        align-items: flex-start;
        padding-inline: 16px;
      }

      .brand-title {
        font-size: 1.05rem;
      }

      /* Drei Links auch auf Mobile sichtbar, unter dem Logo */
      .nav-links {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
        text-align: center;
        margin-top: 4px;
      }

      .nav-links a {
        font-size: 0.9rem;
        padding: 2px 6px;
      }

      /* CTA-Gruppe (falls vorhanden) auf Mobile ausblenden */
      .cta-group {
        display: none !important;
      }

      /* Burger-Menü rechts neben dem Logo */
      .user-menu {
        display:block;
        margin-left:auto;
      }

      /* Hero-Bereich kompakter */
      .page-login .hero {
        padding: 28px 0 14px !important;
      }

      .page-login .hero h1 {
        font-size: 1.7rem;
        line-height: 1.25;
      }

      .page-login .hero .lead {
        font-size: 0.96rem;
      }

      /* Tabs: untereinander auf kleinen Screens */
      .page-login .tabs {
        justify-content: center;
      }

      .page-login .tab-btn {
        flex: 1 1 100%;
        text-align: center;
      }

      /* Panels / Formulare */
      .page-login .panel {
        padding: 16px;
        margin-bottom: 14px;
      }

      .page-login .form-actions {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .page-login .form-actions .btn {
        width: 100%;
        justify-content: center;
      }

      .page-login .form-note {
        font-size: 0.9rem;
      }

      /* Footer-Spalten stapeln */
      .foot-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .foot-col {
        margin-top: 4px;
      }
    }
  </style>
</head>

<body class="page-login">
  <!-- Vollbild-Ladeoverlay -->
  <div id="loading-backdrop" class="loading-backdrop" hidden aria-live="polite" aria-atomic="true">
    <div class="loading-dialog" role="alert" aria-busy="true">
      <div class="spinner" aria-hidden="true"></div>
      <p id="loading-text">Einen Moment …</p>
      <p id="loading-subtext" class="subtext" hidden>Das kann – je nach Provider – bis zu 30 Sek. dauern.</p>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="container nav" role="navigation" aria-label="Hauptnavigation">
      <a class="brand" href="index.html" aria-label="Startseite">
        <div class="brand-logo" aria-hidden="true">
          <img src="static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo" width="50" height="50">
        </div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>

      <!-- Mobile User-Dropdown (gleiches Menü wie auf den anderen Seiten) -->
      <div class="user-menu">
        <button id="userMenuBtn" class="btn" aria-haspopup="menu" aria-expanded="false">
          ☰ Menü
        </button>
        <div id="userMenu" class="menu" role="menu" hidden>
          <!-- Nur sichtbar, wenn NICHT eingeloggt -->
          <a href="login.html?tab=login" class="item auth-out" role="menuitem">Anmelden</a>

          <!-- Nur sichtbar, wenn eingeloggt -->
          <button type="button" class="item auth-in" data-action="logout" role="menuitem">Abmelden</button>
          <a href="anbieter-portal.html" class="item auth-in" role="menuitem">Profil</a>
          <a href="anbieter-portal.html#step-3" class="item auth-in" role="menuitem">Slot anlegen</a>
          <button class="item danger auth-in" data-action="delete" role="menuitem">Konto löschen</button>

          <!-- Immer sichtbar -->
          <a href="kontakt.html" class="item" role="menuitem">Kontakt</a>
        </div>
      </div>

      <nav class="nav-links">
        <a href="anbieter.html">Für Anbieter</a>
        <a href="suchende.html">Für Suchende</a>
        <a href="preise.html">Preise</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero" style="padding:40px 0 16px">
      <div class="container">
        <span class="badge">Für Anbieter</span>
        <h1>Anmelden & registrieren</h1>
        <br>
        <p class="lead">Erstelle dein Konto, melde dich an und vervollständige dein Profil (Branche, Kontaktdaten, Ort). Slots/Zeitfenster legst du bequem nach dem Login im Portal an.</p>
        <br>
        <div class="tabs" role="tablist" aria-label="Anbieter-Aktionen">
          <button class="tab-btn active" data-tab="login" role="tab" aria-selected="true">Anmelden</button>
          <button class="tab-btn" data-tab="register" role="tab" aria-selected="false">Registrieren</button>
        </div>
      </div>
    </section>

    <!-- Status/Info-Banner -->
    <div id="form-info" role="status" aria-live="polite"></div>

    <!-- FORMS -->
    <section>
      <div class="container" id="tab-content">
        <!-- LOGIN -->
        <div class="panel" id="tab-login" role="tabpanel">
          <h2>Anmelden</h2>
          <p class="hint">Mit deiner E-Mail und deinem Passwort einloggen. Bei Erfolg geht es ins <strong>Portal</strong>.</p>
          <div class="form-alert" id="login-alert"></div>
          <form id="login-form" class="form-grid" novalidate>
            <div class="field col-2">
              <label for="login-email">E-Mail</label>
              <input id="login-email" name="email" type="email" placeholder="dein@beispiel.de" required autocomplete="email">
            </div>
            <div class="field col-2">
              <label for="login-password">Passwort</label>
              <input id="login-password" name="password" type="password" placeholder="••••••••" required minlength="8" autocomplete="current-password">
            </div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Anmelden</button>
              <span class="form-note">Noch kein Konto? → <a href="#" data-switch="register">Jetzt registrieren</a></span>
            </div>
          </form>
        </div>

        <!-- REGISTER -->
        <div class="panel" id="tab-register" role="tabpanel" hidden>
          <h2>Registrieren (Anbieter)</h2>
          <p class="hint">Konto anlegen. Du erhältst anschließend eine E-Mail mit Bestätigungslink (Double-Opt-In).</p>
          <div class="form-alert" id="register-alert"></div>
          <div class="form-success" id="register-success">Danke! Bitte prüfe dein Postfach und bestätige deine E-Mail. Danach kannst du dich anmelden.</div>
          <form id="register-form" class="form-grid" novalidate>
            <div class="field col-2">
              <label for="reg-email">E-Mail</label>
              <input id="reg-email" name="email" type="email" placeholder="studio@beispiel.de" required autocomplete="email">
            </div>
            <div class="field">
              <label for="reg-password">Passwort</label>
              <input id="reg-password" name="password" type="password" placeholder="Mind. 8 Zeichen" required minlength="8" autocomplete="new-password">
              <span class="hint">Tipp: Mind. 8 Zeichen, besser mit Zahl & Sonderzeichen.</span>
            </div>
            <div class="field">
              <label for="reg-password2">Passwort wiederholen</label>
              <input id="reg-password2" type="password" placeholder="Passwort bestätigen" required minlength="8" autocomplete="new-password">
            </div>
            <div class="field col-2">
              <label><input type="checkbox" id="reg-terms" required> Ich akzeptiere das <a href="impressum.html" target="_blank" rel="noopener">Impressum</a> und die <a href="datenschutz.html" target="_blank" rel="noopener">Datenschutzerklärung</a>.</label>
            </div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Kostenlos registrieren</button>
              <span class="form-note">Schon Konto? → <a href="#" data-switch="login">Anmelden</a></span>
            </div>
          </form>

          <div class="divider"></div>
          <p class="hint">Nach der Anmeldung vervollständigst du dein Profil (Branche, Kontaktdaten, Ort). Zeitfenster/Slots legst du danach im Portal an.</p>
        </div>

        <!-- PROFILE (optional, nach Login) -->
        <div class="panel" id="tab-profile" role="tabpanel" hidden>
          <h2>Profil vervollständigen</h2>
          <p class="hint">Diese Angaben erscheinen in deinen Angeboten und beschleunigen die Freischaltung.</p>
          <div class="form-alert" id="profile-alert"></div>
          <div class="form-success" id="profile-success">Profil gespeichert!</div>
          <form id="profile-form" class="form-grid" novalidate>
            <div class="field col-2">
              <label for="pf-company">Firmenname / Praxis / Studio</label>
              <input id="pf-company" name="company_name" type="text" placeholder="z. B. Salon Mira" required>
            </div>
            <div class="field col-2">
              <label for="pf-branch">Branche / Kategorie</label>
              <input id="pf-branch" name="branch" list="branch-list" type="text" placeholder="z. B. Friseur" required>
              <datalist id="branch-list">
                <option>Friseur</option><option>Kosmetik</option><option>Physiotherapie</option>
                <option>Nagelstudio</option><option>Zahnarzt</option><option>Handwerk</option>
                <option>KFZ-Service</option><option>Fitness</option><option>Coaching</option>
                <option>Tierarzt</option><option>Behörde</option><option>Sonstiges</option>
              </datalist>
            </div>
            <div class="field">
              <label for="pf-street">Straße & Nr.</label>
              <input id="pf-street" name="street" type="text" placeholder="Musterstraße 1">
            </div>
            <div class="field">
              <label for="pf-zip">PLZ</label>
              <input id="pf-zip" name="zip" type="text" placeholder="12345" pattern="\d{5}" inputmode="numeric">
            </div>
            <div class="field col-2">
              <label for="pf-city">Ort</label>
              <input id="pf-city" name="city" type="text" placeholder="Musterstadt">
            </div>
            <div class="field">
              <label for="pf-phone">Telefon</label>
              <input id="pf-phone" name="phone" type="tel" placeholder="+49 …" pattern="^\+?[0-9\s\-\/]{6,}$">
            </div>
            <div class="field">
              <label for="pf-whatsapp">WhatsApp (optional)</label>
              <input id="pf-whatsapp" name="whatsapp" type="tel" placeholder="+49 …" pattern="^\+?[0-9\s\-\/]{6,}$">
            </div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Profil speichern</button>
              <a class="btn" href="anbieter-portal.html">Weiter ins Portal</a>
              <span class="form-note">Slots/Zeitfenster legst du im Portal an.</span>
            </div>
          </form>
          <div class="divider"></div>
          <p class="hint">Tipp: Für die Freischaltung solltest du <strong>Firma, Branche, PLZ & Ort</strong> angeben.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein" width="40" height="40">
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte Lösungen für deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">Für Anbieter</a>
        <a class="foot-link" href="suchende.html">Für Suchende</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">© <span id="y"></span> Terminmarktplatz · Alle Rechte vorbehalten.</div>
  </footer>

  <!-- Konsolidierter JS-Block -->
  <script>
    // Hinweis nach Account-Löschung
    (() => {
      const p = new URLSearchParams(location.search);
      if (p.get('deleted') === '1') {
        const box = document.getElementById('form-info');
        if (box){ box.className='success'; box.style.display='block'; box.textContent='Konto wurde gelöscht.'; }
        p.delete('deleted');
        history.replaceState({},'', location.pathname + (p.toString()?('?'+p.toString()):'')); 
      }
    })();

    // ---------- API-Basis ----------
    const API = (() => {
      const h = location.hostname, proto = location.protocol;
      const isLocal = (h === 'localhost' || h === '127.0.0.1');
      return isLocal ? `${proto}//127.0.0.1:5000` : 'https://api.terminmarktplatz.de';
    })();

    // Footer-Jahr
    document.getElementById('y').textContent = new Date().getFullYear();

    // Tabs
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = {
      login: document.getElementById('tab-login'),
      register: document.getElementById('tab-register'),
      profile: document.getElementById('tab-profile'),
    };
    function switchTab(name){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
      Object.entries(panels).forEach(([k, el]) => { el.hidden = (k !== name); });
      window.scrollTo({ top: 0, behavior: 'smooth' });
      if (name === 'profile') loadProfileIfAuthed();
    }
    tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
    document.querySelectorAll('[data-switch]').forEach(a => {
      a.addEventListener('click', (e) => { e.preventDefault(); switchTab(a.dataset.switch); });
    });

    // Overlay + Button-Loading
    const backdrop    = document.getElementById('loading-backdrop');
    const loadingText = document.getElementById('loading-text');
    const loadingSub  = document.getElementById('loading-subtext');
    function lockForm(form, lock = true){
      if (!form) return;
      [...form.elements].forEach(el => el.disabled = lock);
      form.setAttribute('aria-busy', lock ? 'true' : 'false');
      const btn = form.querySelector('button[type="submit"]');
      if (btn) btn.classList.toggle('loading', lock);
    }
    function showLoading(msg = 'Einen Moment …'){
      if (loadingText) loadingText.textContent = msg;
      if (loadingSub)  loadingSub.hidden = true;
      if (backdrop)    backdrop.hidden  = false;
      showLoading._t && clearTimeout(showLoading._t);
      showLoading._t = setTimeout(() => { if (loadingSub) loadingSub.hidden = false; }, 5000);
    }
    function hideLoading(){ if (backdrop) backdrop.hidden = true; showLoading._t && clearTimeout(showLoading._t); }

    // Helpers Meldungen
    function showAlert(id, msg){ const el = document.getElementById(id); el.textContent = msg; el.style.display='block'; }
    function hideAlert(id){ const el = document.getElementById(id); el.style.display='none'; el.textContent=''; }
    function showSuccess(id, msg){ const el = document.getElementById(id); if(msg) el.textContent = msg; el.style.display='block'; }
    function hideSuccess(id){ const el = document.getElementById(id); el.style.display='none'; }
    function showInfo(kind, text){
      const box = document.getElementById('form-info'); if(!box) return;
      box.className = ''; box.style.display = 'block';
      if(kind === 'success') box.classList.add('success');
      if(kind === 'error')   box.classList.add('error');
      if(kind === 'warn')    box.classList.add('warn');
      box.textContent = text;
    }

    // ---------- LOGIN ----------
    (function(){
      const form = document.getElementById('login-form');
      if(!form) return;
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        hideAlert('login-alert');
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        if(!email || !password){ return showAlert('login-alert','Bitte E-Mail und Passwort eingeben.'); }

        showLoading('Anmeldung …'); lockForm(form, true);
        try{
          const res = await fetch(`${API}/auth/login`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify({email, password})
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok){
            const msg = data.error === 'email_not_verified'
              ? 'Bitte bestätige zuerst deine E-Mail über den Link in unserer Nachricht.'
              : 'Anmeldung fehlgeschlagen. Bitte E-Mail/Passwort prüfen.';
            hideLoading(); lockForm(form, false);
            return showAlert('login-alert', msg);
          }
          // Erfolg → Portal
          window.location.href = 'anbieter-portal.html';
        }catch(err){
          hideLoading(); lockForm(form, false);
          showAlert('login-alert','Netzwerkfehler – bitte später erneut versuchen.');
        }
      });
    })();

    // ---------- REGISTER ----------
    (function(){
      const form = document.getElementById('register-form');
      if(!form) return;

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        hideAlert('register-alert'); hideSuccess('register-success');

        const email = document.getElementById('reg-email').value.trim();
        const pw1 = document.getElementById('reg-password').value;
        const pw2 = document.getElementById('reg-password2').value;
        const terms = document.getElementById('reg-terms').checked;

        if(!email || !pw1 || !pw2){ return showAlert('register-alert','Bitte alle Pflichtfelder ausfüllen.'); }
        if(pw1.length < 8){ return showAlert('register-alert','Passwort muss mindestens 8 Zeichen haben.'); }
        if(pw1 !== pw2){ return showAlert('register-alert','Passwörter stimmen nicht überein.'); }
        if(!terms){ return showAlert('register-alert','Bitte stimme Impressum & Datenschutz zu.'); }

        const payload = { email, password: pw1 };

        showLoading('Registrierung wird erstellt …'); lockForm(form, true);
        try{
          const r = await fetch(`${API}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'omit',            // keine Cookies beim Register
            body: JSON.stringify(payload)
          });

          const data = await r.json().catch(()=> ({}));

          if (r.ok) {
            showSuccess('register-success', 'Fast geschafft! Bitte E-Mails prüfen und Anmeldung bestätigen.');
            showInfo('success', 'Wir haben dir eine Bestätigungs-E-Mail gesendet.');
            form.reset();
            switchTab('login');
          } else {
            const msg = ({
              email_exists: 'Diese E-Mail ist bereits registriert.',
              invalid_email: 'E-Mail ist ungültig.',
              password_too_short: 'Passwort ist zu kurz.'
            })[data.error] || 'Registrierung fehlgeschlagen. Bitte erneut versuchen.';
            showAlert('register-alert', msg);
          }
        }catch(err){
          showAlert('register-alert','Netzwerkfehler – bitte später erneut versuchen.');
        }finally{
          hideLoading(); lockForm(form, false);
        }
      });
    })();

    // ---------- PROFILE (requires auth) ----------
    async function loadProfileIfAuthed(){
      hideAlert('profile-alert'); hideSuccess('profile-success');
      try{
        const res = await fetch(`${API}/me`, {credentials:'include'});
        if(!res.ok){ showAlert('profile-alert','Bitte zuerst anmelden, dann kannst du dein Profil bearbeiten.'); return; }
        const me = await res.json();
        const set = (id,val)=>{ const el = document.getElementById(id); if(el && (el.value==='' || el.value==null) && val) el.value = val; };
        set('pf-company', me.company_name);
        set('pf-branch', me.branch);
        set('pf-street', me.street);
        set('pf-zip', me.zip);
        set('pf-city', me.city);
        set('pf-phone', me.phone);
        set('pf-whatsapp', me.whatsapp);
      }catch(e){
        showAlert('profile-alert','Konnte Profil nicht laden.');
      }
    }

    // URL-Tab voreinstellen: /login.html?tab=register
    const url = new URL(window.location.href);
    const want = url.searchParams.get('tab');
    if (want && ['login','register','profile'].includes(want)) switchTab(want);

    // Verifizierungsbanner (?verified=1|0)
    (function onLoadVerifyBanner(){
      const params = new URLSearchParams(location.search);
      if (params.get('verified') === '1') {
        showInfo('success', 'E-Mail bestätigt. Du kannst dich jetzt anmelden.');
        params.delete('verified');
        const clean = location.pathname + (params.toString() ? '?' + params.toString() : '');
        history.replaceState({}, '', clean);
      } else if (params.get('verified') === '0') {
        showInfo('warn', 'Verifizierung nicht möglich oder abgelaufen. Bitte neuen Link anfordern.');
        params.delete('verified');
        const clean = location.pathname + (params.toString() ? '?' + params.toString() : '');
        history.replaceState({}, '', clean);
      }
    })();

    // ---------- User-Menü (mobil, Auth-abhängig) ----------
    (function(){
      const APIforMenu = API;

      const btn  = document.getElementById('userMenuBtn');
      const menu = document.getElementById('userMenu');
      if(!btn || !menu) return;

      const authOutEls = menu.querySelectorAll('.auth-out');
      const authInEls  = menu.querySelectorAll('.auth-in');

      function setAuthVisible(isLoggedIn){
        authOutEls.forEach(el => { el.style.display = isLoggedIn ? 'none' : ''; });
        authInEls.forEach(el  => { el.style.display  = isLoggedIn ? '' : 'none'; });
      }

      async function checkAuth(){
        try{
          const res = await fetch(`${APIforMenu}/me`, { credentials:'include' });
          setAuthVisible(res.ok);
        }catch(e){
          setAuthVisible(false);
        }
      }

      function openMenu(open){
        menu.hidden = !open;
        btn.setAttribute('aria-expanded', String(open));
      }

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        openMenu(menu.hidden);
      });

      document.addEventListener('click', ()=> openMenu(false));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') openMenu(false); });

      menu.addEventListener('click', async (e)=>{
        const el = e.target.closest('.item');
        if(!el) return;
        const action = el.dataset.action;

        if(action === 'logout'){
          try{
            await fetch(`${APIforMenu}/auth/logout`, { method:'POST', credentials:'include' });
          }catch(_){}
          location.href = '/login.html';
        }

        if(action === 'delete'){
          const ok = confirm('Wirklich den gesamten Account mit allen Slots und Buchungen löschen? Dieser Schritt ist endgültig.');
          if(!ok) return;
          try{
            const res = await fetch(`${APIforMenu}/me`, { method:'DELETE', credentials:'include' });
            if(res.ok){
              location.href = '/login.html?deleted=1';
            }else{
              const data = await res.json().catch(()=>({}));
              alert(data?.error ? `Löschen fehlgeschlagen: ${data.error}` : 'Löschen fehlgeschlagen.');
            }
          }catch(err){
            alert('Netzwerkfehler – bitte später erneut versuchen.');
          }
        }
      });

      checkAuth();
    })();
  </script>
</body>
</html>
