<!-- FILE: login.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anbieter – Anmelden & Registrieren | Terminmarktplatz</title>
  <meta name="description" content="Anbieter-Login und Registrierung für Terminmarktplatz. Erstelle dein Konto, melde dich an und vervollständige dein Profil (Branche, Kontaktdaten, Ort)." />
  <meta name="theme-color" content="#6f53ff" />

  <!-- OG -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Anbieter – Anmelden & Registrieren" />
  <meta property="og:description" content="Jetzt Anbieter werden, freie Slots veröffentlichen und No-Shows reduzieren." />
  <meta property="og:site_name" content="Terminmarktplatz" />
  <meta property="og:image" content="static/og-cover.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Root-relative Pfade -->
  <base href="/">

  <!-- Assets -->
  <link rel="icon" href="static/favicon.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="static/style.css?v=20251010" />

  <!-- Seitenstil: Panels dunkel, Eingabefelder hell -->
  <style>
    /* Tabs */
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 0; justify-content:center}
    .tab-btn{
      padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:700;
      border:1px solid var(--border); color:#fff; background:rgba(255,255,255,.06);
      box-shadow:var(--shadow-1); transition:.15s
    }
    .tab-btn:hover{transform:translateY(-2px)}
    .tab-btn.active{background:linear-gradient(135deg, var(--c-purple), var(--c-cyan)); border:none}

    /* Panels auf dieser Seite wieder dunkel (überschreibt helle Default-Panels) */
    .page-login .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)) !important;
      border: 1px solid var(--border) !important;
      color: var(--ink) !important;
      border-radius: var(--r-3xl);
      box-shadow: var(--shadow-2);
      padding: 18px;
    }
    .page-login .panel h1,
    .page-login .panel h2,
    .page-login .panel h3,
    .page-login .panel p,
    .page-login .panel li{ color: var(--ink) }
    .page-login .panel .muted{ color: var(--ink-dim) }

    /* Form-Gitter & Felder */
    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .form-grid .col-1{grid-column:span 1} .form-grid .col-2{grid-column:span 2}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-weight:700}
    .field input,.field select, .field textarea{
      border:1px solid var(--border); border-radius:12px; padding:12px;
      background:#fff; color:#0f172a
    }
    .form-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .form-note{color:var(--ink-dim); font-size:13px}
    .form-alert{display:none; border:1px solid #ef4444; color:#7f1d1d; background:#fee2e2; padding:10px; border-radius:12px}
    .form-success{display:none; border:1px solid #16a34a; color:#065f46; background:#dcfce7; padding:10px; border-radius:12px}
    .hint{font-size:13px; color:#64748b}
    .divider{height:1px; background:var(--border); margin:14px 0}

    @media (max-width: 880px){
      .form-grid{grid-template-columns:1fr}
      .form-grid .col-2{grid-column:span 1}
    }
  </style>
</head>

<body class="page-login">
  <!-- Header -->
  <header>
    <div class="container nav" role="navigation" aria-label="Hauptnavigation">
      <a class="brand" href="index.html" aria-label="Startseite">
        <div class="brand-logo" aria-hidden="true">
          <img src="static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo" width="50" height="50">
        </div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>
      <nav class="nav-links" id="nav-links">
        <a href="anbieter.html"  aria-label="Für Anbieter">Für Anbieter</a>
        <a href="suchende.html" aria-label="Für Suchende">Für Suchende</a>
        <a href="preise.html"    aria-label="Preise">Preise</a>
      </nav>
      <div class="cta-group">
        <a class="btn"         href="login.html?tab=login"    aria-label="Anmelden">Anmelden</a>
        <a class="btn primary" href="login.html?tab=register" aria-label="Konto erstellen">Registrieren</a>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero" style="padding:40px 0 16px">
      <div class="container">
        <span class="badge">Für Anbieter</span>
        <h1>Anmelden & registrieren</h1>
        <p class="lead">Erstelle dein Konto, melde dich an und vervollständige dein Profil (Branche, Kontaktdaten, Ort). Slots/Zeitfenster legst du bequem nach dem Login im Portal an.</p>
        <br>
        <div class="tabs" role="tablist" aria-label="Anbieter-Aktionen">
          <button class="tab-btn active" data-tab="login" role="tab" aria-selected="true">Anmelden</button>
          <button class="tab-btn" data-tab="register" role="tab" aria-selected="false">Registrieren</button>
        </div>
      </div>
    </section>

    <!-- FORMS -->
    <section>
      <div class="container" id="tab-content">
        <!-- LOGIN -->
        <div class="panel" id="tab-login" role="tabpanel" aria-labelledby="tab-login-btn">
          <h2>Anmelden</h2>
          <p class="hint">Mit deiner E-Mail und deinem Passwort einloggen. Bei Erfolg geht es ins <strong>Portal</strong>.</p>
          <div class="form-alert" id="login-alert"></div>
          <form id="login-form" class="form-grid" novalidate>
            <div class="field col-2">
              <label for="login-email">E-Mail</label>
              <input id="login-email" name="email" type="email" placeholder="dein@beispiel.de" required autocomplete="email">
            </div>
            <div class="field col-2">
              <label for="login-password">Passwort</label>
              <input id="login-password" name="password" type="password" placeholder="••••••••" required minlength="8" autocomplete="current-password">
            </div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Anmelden</button>
              <span class="form-note">Noch kein Konto? → <a href="#" data-switch="register">Jetzt registrieren</a></span>
            </div>
          </form>
        </div>

        <!-- REGISTER -->
        <div class="panel" id="tab-register" role="tabpanel" hidden>
          <h2>Registrieren (Anbieter)</h2>
          <p class="hint">Konto anlegen. Du erhältst anschließend eine E-Mail mit Bestätigungslink (Double-Opt-In).</p>
          <div class="form-alert" id="register-alert"></div>
          <div class="form-success" id="register-success">Danke! Bitte prüfe dein Postfach und bestätige deine E-Mail. Danach kannst du dich anmelden.</div>
          <form id="register-form" class="form-grid" novalidate>
            <div class="field col-2">
              <label for="reg-email">E-Mail</label>
              <input id="reg-email" name="email" type="email" placeholder="studio@beispiel.de" required autocomplete="email">
            </div>
            <div class="field">
              <label for="reg-password">Passwort</label>
              <input id="reg-password" name="password" type="password" placeholder="Mind. 8 Zeichen" required minlength="8" autocomplete="new-password">
              <span class="hint">Tipp: Mind. 8 Zeichen, besser mit Zahl & Sonderzeichen.</span>
            </div>
            <div class="field">
              <label for="reg-password2">Passwort wiederholen</label>
              <input id="reg-password2" type="password" placeholder="Passwort bestätigen" required minlength="8" autocomplete="new-password">
            </div>
            <div class="field col-2">
              <label><input type="checkbox" id="reg-terms" required> Ich akzeptiere das <a href="impressum.html" target="_blank" rel="noopener">Impressum</a> und die <a href="datenschutz.html" target="_blank" rel="noopener">Datenschutzerklärung</a>.</label>
            </div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Kostenlos registrieren</button>
              <span class="form-note">Schon Konto? → <a href="#" data-switch="login">Anmelden</a></span>
            </div>
          </form>
          <form id="register-form" class="stack">
              <label>
                E-Mail
                <input type="email" name="email" required autocomplete="email"
                      placeholder="z. B. info@terminmarktplatz.de">
              </label>

              <label>
                Passwort
                <input type="password" name="password" required minlength="8"
                      autocomplete="new-password" placeholder="mind. 8 Zeichen">
              </label>

              <button class="btn primary" id="register-submit" type="submit">Registrieren</button>

              <div id="register-msg" class="form-msg" aria-live="polite"></div>
            </form>

          <div class="divider"></div>
          <p class="hint">Nach der Anmeldung vervollständigst du dein Profil (Branche, Kontaktdaten, Ort). Zeitfenster/Slots legst du danach im Portal an.</p>
        </div>

        <!-- PROFILE (optional, nach Login) -->
        <div class="panel" id="tab-profile" role="tabpanel" hidden>
          <h2>Profil vervollständigen</h2>
          <p class="hint">Diese Angaben erscheinen in deinen Angeboten und beschleunigen die Freischaltung.</p>
          <div class="form-alert" id="profile-alert"></div>
          <div class="form-success" id="profile-success">Profil gespeichert!</div>
          <form id="profile-form" class="form-grid" novalidate>
            <div class="field col-2">
              <label for="pf-company">Firmenname / Praxis / Studio</label>
              <input id="pf-company" name="company_name" type="text" placeholder="z. B. Salon Mira" required>
            </div>
            <div class="field col-2">
              <label for="pf-branch">Branche / Kategorie</label>
              <input id="pf-branch" name="branch" list="branch-list" type="text" placeholder="z. B. Friseur" required>
              <datalist id="branch-list">
                <option>Friseur</option><option>Kosmetik</option><option>Physiotherapie</option>
                <option>Nagelstudio</option><option>Zahnarzt</option><option>Handwerk</option>
                <option>KFZ-Service</option><option>Fitness</option><option>Coaching</option>
                <option>Tierarzt</option><option>Behörde</option><option>Sonstiges</option>
              </datalist>
            </div>
            <div class="field">
              <label for="pf-street">Straße & Nr.</label>
              <input id="pf-street" name="street" type="text" placeholder="Musterstraße 1">
            </div>
            <div class="field">
              <label for="pf-zip">PLZ</label>
              <input id="pf-zip" name="zip" type="text" placeholder="12345" pattern="\d{5}" inputmode="numeric">
            </div>
            <div class="field col-2">
              <label for="pf-city">Ort</label>
              <input id="pf-city" name="city" type="text" placeholder="Musterstadt">
            </div>
            <div class="field">
              <label for="pf-phone">Telefon</label>
              <input id="pf-phone" name="phone" type="tel" placeholder="+49 …" pattern="^\+?[0-9\s\-\/]{6,}$">
            </div>
            <div class="field">
              <label for="pf-whatsapp">WhatsApp (optional)</label>
              <input id="pf-whatsapp" name="whatsapp" type="tel" placeholder="+49 …" pattern="^\+?[0-9\s\-\/]{6,}$">
            </div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Profil speichern</button>
              <a class="btn" href="portal.html">Weiter ins Portal</a>
              <span class="form-note">Slots/Zeitfenster legst du im Portal an.</span>
            </div>
          </form>
          <div class="divider"></div>
          <p class="hint">Tipp: Für die Freischaltung solltest du <strong>Firma, Branche, PLZ & Ort</strong> angeben.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein"/>
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte Lösungen für deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="wie-es-funktioniert.html">Wie es funktioniert</a>
        <a class="foot-link" href="kategorien.html">Kategorien</a>
        <a class="foot-link" href="preise.html">Preise</a>
        <a class="foot-link" href="anbieter.html">Für Anbieter</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:hello@terminmarktplatz.de">hello@terminmarktplatz.de</a>
        <a class="foot-link" href="blog.html">Blog</a>
      </div>
    </div>
    <div class="container copyright">© <span id="y"></span> Terminmarktplatz · Alle Rechte vorbehalten.</div>
  </footer>

  <script>
    // ---------- API-Basis: lokal vs. Produktion ----------
    const API = (()=> {
      const h = location.hostname;
      if (h === 'localhost' || h === '127.0.0.1') return 'http://127.0.0.1:5000';
      return 'https://api.terminmarktplatz.de';
    })();

    // ---------- Klartext-Meldungen für API-Fehler ----------
    const REG_MESSAGES = {
      email_exists: 'Diese E-Mail ist bereits registriert.',
      invalid_email: 'Bitte gib eine gültige E-Mail an.',
      password_too_short: 'Passwort muss mindestens 8 Zeichen haben.',
      verification_sent: 'Bitte prüfe dein Postfach und bestätige deine E-Mail.'
    };

    // Footer-Jahr
    document.getElementById('y').textContent = new Date().getFullYear();

    // Tabs
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = {
      login: document.getElementById('tab-login'),
      register: document.getElementById('tab-register'),
      profile: document.getElementById('tab-profile'),
    };
    function switchTab(name){
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      Object.entries(panels).forEach(([k,el])=>{ el.hidden = (k!==name); });
      window.scrollTo({top:0, behavior:'smooth'});
      if (name === 'profile') loadProfileIfAuthed();
    }
    tabs.forEach(btn=>btn.addEventListener('click', ()=>switchTab(btn.dataset.tab)));
    document.querySelectorAll('[data-switch]').forEach(a=>{
      a.addEventListener('click', (e)=>{ e.preventDefault(); switchTab(a.dataset.switch); });
    });

    // Helpers
    function showAlert(id, msg){ const el = document.getElementById(id); el.textContent = msg; el.style.display='block'; }
    function hideAlert(id){ const el = document.getElementById(id); el.style.display='none'; el.textContent=''; }
    function showSuccess(id, msg){ const el = document.getElementById(id); if(msg) el.textContent = msg; el.style.display='block'; }
    function hideSuccess(id){ const el = document.getElementById(id); el.style.display='none'; }

    // ---------- LOGIN ----------
    document.getElementById('login-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideAlert('login-alert');
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if(!email || !password){ return showAlert('login-alert','Bitte E-Mail und Passwort eingeben.'); }
      try{
        const res = await fetch(`${API}/auth/login`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',  // für Cookies (Render: SameSite=None; Secure)
          body: JSON.stringify({email, password})
        });
        if(!res.ok){
          const data = await res.json().catch(()=>({error:'Fehler'}));
          const msg = data.error === 'email_not_verified'
            ? 'Bitte bestätige zuerst deine E-Mail über den Link in unserer Nachricht.'
            : 'Anmeldung fehlgeschlagen. Bitte E-Mail/Passwort prüfen.';
          return showAlert('login-alert', msg);
        }
        // Erfolg → Portal
        window.location.href = 'portal.html';
      }catch(err){
        showAlert('login-alert','Netzwerkfehler – bitte später erneut versuchen.');
      }
    });

    // ---------- REGISTER ----------
    document.getElementById('register-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideAlert('register-alert'); hideSuccess('register-success');

      const email = document.getElementById('reg-email').value.trim();
      const pw1 = document.getElementById('reg-password').value;
      const pw2 = document.getElementById('reg-password2').value;
      const terms = document.getElementById('reg-terms').checked;

      if(!email || !pw1 || !pw2){ return showAlert('register-alert','Bitte alle Pflichtfelder ausfüllen.'); }
      if(pw1.length < 8){ return showAlert('register-alert', REG_MESSAGES.password_too_short); }
      if(pw1 !== pw2){ return showAlert('register-alert','Passwörter stimmen nicht überein.'); }
      if(!terms){ return showAlert('register-alert','Bitte stimme Impressum & Datenschutz zu.'); }

      try{
        const res = await fetch(`${API}/auth/register`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({email, password: pw1})
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          return showAlert('register-alert', REG_MESSAGES[data.error] || 'Registrierung fehlgeschlagen.');
        }
        // Erfolg
        showSuccess('register-success', REG_MESSAGES.verification_sent);
        setTimeout(()=>switchTab('login'), 1800);
      }catch(err){
        showAlert('register-alert','Netzwerkfehler – bitte später erneut versuchen.');
      }
    });

    // PROFILE (requires auth)
    async function loadProfileIfAuthed(){
      hideAlert('profile-alert'); hideSuccess('profile-success');
      try{
        const res = await fetch(`${API}/me`, {credentials:'include'});
        if(!res.ok){ showAlert('profile-alert','Bitte zuerst anmelden, dann kannst du dein Profil bearbeiten.'); return; }
        const me = await res.json();
        const set = (id,val)=>{ const el = document.getElementById(id); if(el && (el.value==='' || el.value==null) && val) el.value = val; };
        set('pf-company', me.company_name);
        set('pf-branch', me.branch);
        set('pf-street', me.street);
        set('pf-zip', me.zip);
        set('pf-city', me.city);
        set('pf-phone', me.phone);
        set('pf-whatsapp', me.whatsapp);
      }catch(e){
        showAlert('profile-alert','Konnte Profil nicht laden.');
      }
    }

    // URL-Tab voreinstellen: /login.html?tab=register
    const url = new URL(window.location.href);
    const want = url.searchParams.get('tab');
    if (want && ['login','register','profile'].includes(want)) switchTab(want);
  </script>
  <script>
(() => {
  // Deine API auf Render:
  const API = 'https://api.terminmarktplatz.de';

  const form = document.getElementById('register-form');
  if (!form) return;

  const msg = document.getElementById('register-msg');
  const btn = document.getElementById('register-submit');

  function show(type, text) {
    // type: ok | err | info  (style in CSS nach Wunsch)
    msg.className = 'form-msg ' + type;
    msg.textContent = text;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    show('info', 'Einen Moment …');
    btn.disabled = true;

    const email = form.email.value.trim().toLowerCase();
    const password = form.password.value;

    if (!email || password.length < 8) {
      show('err', 'Bitte gültige E-Mail und Passwort (mind. 8 Zeichen) eingeben.');
      btn.disabled = false;
      return;
    }

    try {
      const r = await fetch(`${API}/auth/register`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      const data = await r.json().catch(() => ({}));

      if (r.ok && data?.ok) {
        if (data.mail_sent) {
          show('ok', 'Fast geschafft! Bitte prüfe deine E-Mails und bestätige die Adresse.');
        } else {
          show('info',
            `Registriert. Mailversand noch nicht erfolgt (${data.mail_reason || 'Info'}). ` +
            `Solange Postmark im Review ist, bitte @terminmarktplatz.de als Empfänger nutzen.`
          );
        }
        form.reset();
      } else {
        switch (data?.error) {
          case 'invalid_email':
            show('err', 'Diese E-Mail ist ungültig.'); break;
          case 'password_too_short':
            show('err', 'Passwort zu kurz (mind. 8 Zeichen).'); break;
          case 'email_exists':
            show('err', 'Diese E-Mail ist bereits registriert.'); break;
          default:
            show('err', 'Unerwarteter Fehler. Bitte später erneut versuchen.');
            console.warn('Register error', data);
        }
      }
    } catch (err) {
      console.error(err);
      show('err', 'Netzwerkfehler – bitte erneut versuchen.');
    } finally {
      btn.disabled = false;
    }
  });

  // Optional: Erfolgsmeldung nach /auth/verify-Redirect (?verified=1)
  const sp = new URLSearchParams(location.search);
  const v = sp.get('verified');
  if (v === '1')      show('ok', 'E-Mail bestätigt. Du kannst dich jetzt anmelden.');
  if (v === 'expired') show('err', 'Bestätigungslink abgelaufen.');
  if (v === 'invalid') show('err', 'Bestätigungslink ungültig.');
})();
</script>

</body>
</html>
