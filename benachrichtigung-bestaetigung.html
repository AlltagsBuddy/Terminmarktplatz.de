<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Benachrichtigung bestätigt | Terminmarktplatz</title>
  <meta name="description" content="Dein Termin-Alarm wurde bestätigt und ist jetzt aktiv." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/" />

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: #e8ecff;
      --muted: rgba(232,236,255,0.70);
      --brand: #6f53ff;
      --brand2:#a78bfa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 26px;
      --max: 980px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(111,83,255,0.35), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,0.25), transparent 55%),
        radial-gradient(700px 420px at 40% 100%, rgba(111,83,255,0.18), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
      min-height:100vh;
    }

    a{ color: #b9adff; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 10px 4px 22px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:0.2px;
    }

    .logoImg{
      width:40px;
      height:40px;
      border-radius: 14px;
      object-fit: cover;
      display:block;
      box-shadow: 0 10px 30px rgba(111,83,255,0.30);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
    }

    .logoFallback{
      width:40px; height:40px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 10px 30px rgba(111,83,255,0.30);
      position:relative;
      overflow:hidden;
      display:none;
    }
    .logoFallback::after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.35), transparent 45%);
      transform: rotate(15deg);
    }

    .pill{
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .pillDot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(34,197,94,0.95);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.18);
    }

    .card{
      background: linear-gradient(180deg, var(--card2), var(--card));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .inner{ padding: 26px 22px; }

    h1{
      margin: 0 0 10px;
      font-size: clamp(22px, 3vw, 30px);
      letter-spacing: -0.2px;
    }

    .sub{
      color: var(--muted);
      margin: 0 0 14px;
      font-size: 14px;
    }

    .okBox{
      border-radius: var(--radius);
      border: 1px solid rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.10);
      padding: 14px;
      color: rgba(255,255,255,0.92);
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-top: 12px;
    }
    .okIcon{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: rgba(34,197,94,0.18);
      border: 1px solid rgba(34,197,94,0.25);
      flex:0 0 auto;
      margin-top:2px;
      font-size: 18px;
    }

    .warnBox{
      border-radius: var(--radius);
      border: 1px solid rgba(245,158,11,0.28);
      background: rgba(245,158,11,0.10);
      padding: 14px;
      color: rgba(255,255,255,0.92);
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-top: 12px;
      display:none;
    }
    .warnIcon{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: rgba(245,158,11,0.18);
      border: 1px solid rgba(245,158,11,0.28);
      flex:0 0 auto;
      margin-top:2px;
      font-size: 18px;
    }

    .details{
      margin-top: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      overflow:hidden;
    }

    .detailsHeader{
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .detailsTitle{
      font-weight: 900;
      font-size: 14px;
      letter-spacing:0.2px;
    }

    .badge{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: rgba(232,236,255,0.88);
      white-space:nowrap;
    }

    .kv{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap: 0;
    }

    .kvRow{ display: contents; }

    .k, .v{
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 13px;
    }

    .k{
      color: rgba(232,236,255,0.72);
      font-weight: 800;
    }

    .v{
      color: rgba(232,236,255,0.92);
      font-weight: 650;
      overflow-wrap:anywhere;
    }

    .kvRow:last-child .k,
    .kvRow:last-child .v{ border-bottom:none; }

    .skeleton{
      animation: pulse 1.2s ease-in-out infinite;
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      height: 14px;
      width: 100%;
      max-width: 420px;
    }
    @keyframes pulse{
      0%{ opacity: .55; }
      50%{ opacity: 1; }
      100%{ opacity: .55; }
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 16px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      color: white;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 14px 35px rgba(111,83,255,0.25);
    }
    .btn:hover{ filter: brightness(1.05); }

    .btnGhost{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: rgba(232,236,255,0.92);
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
    }

    .btnSmall{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: rgba(232,236,255,0.92);
      cursor:pointer;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
    }

    .footer{
      margin-top: 18px;
      color: rgba(232,236,255,0.60);
      font-size: 12px;
      text-align:center;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    @media (max-width: 640px){
      .kv{ grid-template-columns: 1fr; }
      .k{ padding-bottom: 2px; border-bottom:none; }
      .v{ padding-top: 0; }
      .kvRow{ border-bottom: 1px solid rgba(255,255,255,0.06); }
      .kvRow:last-child{ border-bottom:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img id="logoImg" class="logoImg" src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo"
             onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';" />
        <div id="logoFallback" class="logoFallback" aria-hidden="true"></div>

        <div>
          <div style="font-size:15px; line-height:1;">Terminmarktplatz</div>
          <div style="font-size:12px; color:rgba(232,236,255,0.65); font-weight:650;">Benachrichtigung bestätigt</div>
        </div>
      </div>

      <div class="pill" id="statusPill"><span class="pillDot"></span><span>Aktiv</span></div>
    </div>

    <div class="card">
      <div class="inner">
        <h1>Benachrichtigung erfolgreich eingerichtet.</h1>
        <p class="sub" id="subtitle">
          Dein Termin-Alarm ist jetzt aktiv. Du bekommst automatisch eine E-Mail, sobald passende Slots veröffentlicht werden.
        </p>

        <div class="okBox" id="okBox">
          <div class="okIcon">✔</div>
          <div>
            <div style="font-weight:900; margin-bottom:6px;" id="okTitle">Fertig.</div>
            <div style="color:rgba(232,236,255,0.78); font-size:13px;" id="okText">
              Wir laden jetzt die Details deiner Benachrichtigung.
            </div>
          </div>
        </div>

        <div class="warnBox" id="warnBox">
          <div class="warnIcon">⚠</div>
          <div>
            <div style="font-weight:900; margin-bottom:6px;">Details konnten nicht geladen werden.</div>
            <div style="color:rgba(232,236,255,0.78); font-size:13px;" id="warnText">
              Prüfe den Bestätigungslink (token/alert_id). Unten siehst du, was angekommen ist.
            </div>
          </div>
        </div>

        <div class="details" id="detailsBox" aria-live="polite">
          <div class="detailsHeader">
            <div class="detailsTitle">Dein bestätigter Termin-Alarm</div>
            <div class="badge" id="detailsBadge">wird geladen…</div>
          </div>

          <div class="kv" id="kv">
            <!-- Skeleton -->
            <div class="kvRow">
              <div class="k">Kategorie</div>
              <div class="v"><div class="skeleton"></div></div>
            </div>
            <div class="kvRow">
              <div class="k">Umkreis</div>
              <div class="v"><div class="skeleton" style="max-width:180px;"></div></div>
            </div>
            <div class="kvRow">
              <div class="k">Ort / PLZ</div>
              <div class="v"><div class="skeleton" style="max-width:260px;"></div></div>
            </div>
            <div class="kvRow">
              <div class="k">Erstellt / bestätigt</div>
              <div class="v"><div class="skeleton" style="max-width:300px;"></div></div>
            </div>
            <div class="kvRow">
              <div class="k">Interne ID</div>
              <div class="v"><div class="skeleton" style="max-width:360px;"></div></div>
            </div>
          </div>
        </div>

        <div class="row">
          <button class="btn" type="button" onclick="window.location.href='/suche.html'">Zur Suche</button>
          <button class="btnGhost" type="button" onclick="window.location.href='/'">Startseite</button>

          <!-- ✅ wird nur angezeigt wenn k verfügbar -->
          <button class="btnGhost" type="button" id="myAlertsBtn" style="display:none;">Meine Benachrichtigungen</button>

          <button class="btnSmall" type="button" id="copyBtn" style="display:none;">Link kopieren</button>
        </div>

        <div class="footer" id="footerText">
          Hinweis: Wenn du später keine Mails mehr willst, nutze den Abmeldelink in einer Benachrichtigung.
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      // ✅ API_BASE wie auf der "meine-benachrichtigungen.html"
      const API_BASE = (() => {
        const h = location.hostname;
        const proto = location.protocol;

        const isLocal =
          h === 'localhost' ||
          h === '127.0.0.1' ||
          /^192\.168\./.test(h) ||
          /^10\./.test(h) ||
          h.endsWith('.local');

        if (isLocal) return `${proto}//${h}:5000`;
        if (h === 'api.terminmarktplatz.de') return `${proto}//${h}`;
        return 'https://api.terminmarktplatz.de';
      })();

      function qp(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      function safeStr(v){
        if (v === null || v === undefined) return "";
        if (typeof v === "string") return v;
        try { return String(v); } catch { return ""; }
      }

      function fmtDateMaybe(v){
        if (!v) return "";
        const s = safeStr(v);
        const num = Number(s);
        let d = null;
        if (!Number.isNaN(num) && num > 0){
          d = new Date(num < 1e12 ? num * 1000 : num);
        } else {
          const parsed = Date.parse(s);
          if (!Number.isNaN(parsed)) d = new Date(parsed);
        }
        if (!d) return s;
        return d.toLocaleString("de-DE");
      }

      function maskEmail(email){
        email = safeStr(email);
        if (!email.includes("@")) return email;
        const [a,b] = email.split("@");
        if (!a) return email;
        const left = a.slice(0,2);
        return left + "…" + "@" + b;
      }

      function pick(obj, keys){
        for (const k of keys){
          if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
        }
        return null;
      }

      function escapeHtml(str){
        return String(str || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // ✅ manage key / k aus URL oder später aus API
      let manageKey = (qp("k") || qp("manage_key") || "").trim();

      function showMyAlertsBtn(){
        if (!manageKey) return;
        const btn = $("myAlertsBtn");
        btn.style.display = "inline-block";
        btn.onclick = () => {
          window.location.href = "/meine-benachrichtigungen.html?k=" + encodeURIComponent(manageKey);
        };
      }

      function updateUrlWithManageKey(k){
        k = (k || "").trim();
        if(!k) return;
        const u = new URL(window.location.href);
        if (u.searchParams.get("k") !== k){
          u.searchParams.set("k", k);
          history.replaceState({}, "", u.toString());
        }
        manageKey = k;
        showMyAlertsBtn();
      }

      function renderKV(alert){
        // manage_key aus API ziehen, falls nicht in URL
        const mk = pick(alert, ["manage_key","manageKey","k"]);
        if (!manageKey && mk) updateUrlWithManageKey(mk);

        const id = pick(alert, ["id","alert_id","uuid"]);
        const category = pick(alert, ["categories","category","service_category","slot_category","type"]);
        const radius = pick(alert, ["radius_km","radius","distance_km","km"]);
        const city = pick(alert, ["city","location_city","place","town"]);
        const zip = pick(alert, ["zip","postal_code","plz"]);
        const street = pick(alert, ["street","straße"]);
        const house = pick(alert, ["house_number","hausnummer","houseNo"]);
        const email = pick(alert, ["email","user_email","notify_email"]);
        const created = pick(alert, ["created_at","createdAt","created"]);
        const confirmed = pick(alert, ["confirmed_at","confirmedAt","activated_at","activatedAt"]);
        const status = pick(alert, ["status","state","active"]);

        const partsCity = [safeStr(zip), safeStr(city)].filter(Boolean).join(" ");
        const partsAddr = [safeStr(street), safeStr(house)].filter(Boolean).join(" ").trim();

        const rows = [];
        rows.push(["Kategorie(n)", category ? String(category) : "—"]);
        rows.push(["Umkreis", radius ? `${radius} km` : "—"]);
        rows.push(["Ort / PLZ", partsCity || "—"]);
        if (partsAddr) rows.push(["Adresse", partsAddr]);
        if (email) rows.push(["E-Mail", maskEmail(email)]);
        rows.push(["Erstellt", created ? fmtDateMaybe(created) : "—"]);
        rows.push(["Bestätigt / aktiv", confirmed ? fmtDateMaybe(confirmed) : "—"]);
        rows.push(["Status", (typeof status === "boolean") ? (status ? "aktiv" : "inaktiv") : (status || "aktiv")]);
        rows.push(["Interne ID", id || "—"]);

        const kv = $("kv");
        kv.innerHTML = "";
        for (const [k,v] of rows){
          const row = document.createElement("div");
          row.className = "kvRow";
          const dk = document.createElement("div");
          dk.className = "k";
          dk.textContent = k;
          const dv = document.createElement("div");
          dv.className = "v";
          dv.innerHTML = (v && v !== "—") ? escapeHtml(String(v)) : "—";
          row.appendChild(dk);
          row.appendChild(dv);
          kv.appendChild(row);
        }

        $("detailsBadge").textContent = "geladen";
        $("okTitle").textContent = "Aktiv.";
        $("okText").textContent = "Das ist die Benachrichtigung, die du gerade bestätigt hast.";
      }

      async function tryFetchJson(url, opts){
        try{
          const res = await fetch(url, opts || {});
          if (!res.ok) return null;

          const txt = await res.text();
          try{
            return JSON.parse(txt);
          }catch{
            if (txt.trim().startsWith("<")) return null;
            return null;
          }
        }catch{
          return null;
        }
      }

      async function loadAlert(){
        const token = (qp("token") || "").trim();
        const id = (qp("id") || qp("alert_id") || "").trim();
        const confirm = (qp("confirm") || "").trim();

        // Copy-Link Button
        const copyBtn = $("copyBtn");
        copyBtn.style.display = "inline-block";
        copyBtn.onclick = async () => {
          try{
            await navigator.clipboard.writeText(window.location.href);
            copyBtn.textContent = "Kopiert ✓";
            setTimeout(()=>copyBtn.textContent="Link kopieren", 1300);
          }catch{
            copyBtn.textContent = "Kopieren geht nicht";
            setTimeout(()=>copyBtn.textContent="Link kopieren", 1300);
          }
        };

        // ✅ My-Alerts Button anzeigen falls k schon da ist
        showMyAlertsBtn();

        // Kandidaten-Endpunkte (alle mit API_BASE!)
        const candidates = [];

        if (id){
          candidates.push({ url: `${API_BASE}/api/alerts/${encodeURIComponent(id)}`, opts: { method:"GET" } });
          candidates.push({ url: `${API_BASE}/api/alerts?id=${encodeURIComponent(id)}`, opts: { method:"GET" } });
          candidates.push({ url: `${API_BASE}/api/alerts/get?id=${encodeURIComponent(id)}`, opts: { method:"GET" } });
        }

        if (token){
          candidates.push({ url: `${API_BASE}/api/alerts/by-token?token=${encodeURIComponent(token)}`, opts: { method:"GET" } });
          candidates.push({ url: `${API_BASE}/api/alerts/by_token?token=${encodeURIComponent(token)}`, opts: { method:"GET" } });
          candidates.push({ url: `${API_BASE}/api/alerts/lookup?token=${encodeURIComponent(token)}`, opts: { method:"GET" } });

          // falls confirm JSON zurückgibt
          candidates.push({ url: `${API_BASE}/api/alerts/confirm?token=${encodeURIComponent(token)}`, opts: { method:"POST" } });
          candidates.push({ url: `${API_BASE}/api/alerts/confirm?token=${encodeURIComponent(token)}`, opts: { method:"GET" } });
        }

        if (token && confirm === "1"){
          candidates.push({ url: `${API_BASE}/api/alerts/confirm?token=${encodeURIComponent(token)}`, opts: { method:"POST" } });
        }

        // zusätzlich: wenn wir manageKey schon haben, versuchen wir darüber zu laden
        if (manageKey){
          candidates.push({ url: `${API_BASE}/api/alert-subscriptions/by-manage-key?k=${encodeURIComponent(manageKey)}`, opts: { method:"GET" } });
          candidates.push({ url: `${API_BASE}/api/alerts/by-manage-key?k=${encodeURIComponent(manageKey)}`, opts: { method:"GET" } });
        }

        for (const c of candidates){
          const data = await tryFetchJson(c.url, c.opts);
          if (data){
            const alertObj =
              data.alert || data.data ||
              (Array.isArray(data.alerts) ? data.alerts[0] : null) ||
              data;

            if (alertObj && typeof alertObj === "object"){
              renderKV(alertObj);
              return;
            }
          }
        }

        // Wenn nix ging -> Fehlermodus, aber debugbar
        $("warnBox").style.display = "flex";
        $("detailsBadge").textContent = "nicht geladen";
        $("okTitle").textContent = "Aktiv – aber ohne Details.";
        $("okText").textContent = "Die Bestätigung ist wahrscheinlich durch, aber dein Backend liefert hier keine Alarm-Details als JSON zurück.";

        const kv = $("kv");
        kv.innerHTML = "";

        const dbg = {
          api_base: API_BASE,
          received_params: {
            token: token ? (token.slice(0,6) + "…") : null,
            id: id || null,
            alert_id: qp("alert_id") || null,
            k: manageKey ? (manageKey.slice(0,6) + "…") : null,
            confirm: confirm || null
          },
          tried_endpoints: candidates.map(x => `${x.opts.method} ${x.url}`)
        };

        const rows = [
          ["Hinweis", "Damit diese Seite den Alarm anzeigen kann, muss ein API-Endpunkt Alarm-Details als JSON liefern. Aktuell schlagen die GETs/POSTs fehl (404/HTML/leer)."],
          ["Angekommene Parameter", JSON.stringify(dbg.received_params, null, 2)],
          ["Getestete API-Aufrufe", JSON.stringify(dbg.tried_endpoints, null, 2)]
        ];

        for (const [k,v] of rows){
          const row = document.createElement("div");
          row.className = "kvRow";
          const dk = document.createElement("div");
          dk.className = "k";
          dk.textContent = k;
          const dv = document.createElement("div");
          dv.className = "v mono";
          dv.textContent = v;
          row.appendChild(dk);
          row.appendChild(dv);
          kv.appendChild(row);
        }
      }
 
      loadAlert();
    })();
  </script>
</body>
</html>
