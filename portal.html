<!-- FILE: templates/portal.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal – Anbieter | Terminmarktplatz</title>
  <meta name="description" content="Anbieter-Portal: Onboarding, Slots anlegen und verwalten, filtern, duplizieren, exportieren." />
  <meta name="theme-color" content="#6f53ff" />

  <meta property="og:type" content="website" />
  <meta property="og:title" content="Portal – Anbieter" />
  <meta property="og:description" content="Profil vervollständigen und freie Termine verwalten." />
  <meta property="og:site_name" content="Terminmarktplatz" />
  <meta property="og:image" content="{{ url_for('static', filename='og-cover.png') }}" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* kleine Portal-spezifische Ergänzungen */
    .wizard{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:12px}
    .wiz-step{background:#fff; border:1px solid var(--ab-border); border-radius:14px; padding:12px; display:flex; align-items:center; gap:10px}
    .wiz-step .num{width:28px; height:28px; border-radius:50%; display:grid; place-items:center; color:#fff;
      background:linear-gradient(135deg, var(--ab-primary), var(--ab-accent)); font-weight:800}
    .wiz-step.done{border-color:#22c55e; box-shadow:inset 0 0 0 1px #22c55e20}
    .wiz-step.done .num{background:#22c55e}

    .panel{background:#fff; border:1px solid var(--ab-border); border-radius:var(--radius-xl); padding:18px; box-shadow:var(--shadow-2)}
    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .form-grid .col-1{grid-column:span 1} .form-grid .col-2{grid-column:span 2}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-weight:600}
    .field input,.field select,.field textarea{border:1px solid var(--ab-border); border-radius:12px; padding:12px; background:#fff}
    .hint{font-size:13px; color:#64748b}
    .form-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .alert{display:none; border:1px solid var(--ab-danger); color:#7f1d1d; background:#fee2e2; padding:10px; border-radius:12px}
    .success{display:none; border:1px solid #16a34a; color:#065f46; background:#dcfce7; padding:10px; border-radius:12px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
    .toolbar .field{min-width:160px}
    .quick-filters{display:flex; gap:8px; flex-wrap:wrap}
    .status-badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid var(--ab-border); font-size:12px}
    .status-published{background:#ecfdf5; border-color:#bbf7d0}
    .status-pending_review{background:#fff7ed; border-color:#fed7aa}
    .status-archived{background:#f3f4f6; border-color:#e5e7eb}

    .table{width:100%; border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--ab-border); padding:10px; text-align:left; vertical-align:top}
    .table th{font-weight:700; color:#334155}
    .table .actions{white-space:nowrap; display:flex; gap:6px; flex-wrap:wrap}
    .table .sel{width:28px}

    .pagination{display:flex; gap:8px; align-items:center}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:200}
    .modal .dialog{width:min(720px, 96%); background:#fff; border:1px solid var(--ab-border); border-radius:16px; box-shadow:var(--shadow-2); padding:16px}
    @media (max-width: 960px){
      .wizard{grid-template-columns:1fr}
      .form-grid{grid-template-columns:1fr}
      .table th:nth-child(6), .table td:nth-child(6){display:none} /* Preis-Spalte ausblenden auf sehr klein */
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav" role="navigation" aria-label="Hauptnavigation">
      <a class="brand" href="/" aria-label="Startseite">
        <div class="brand-logo" aria-hidden="true">
          <img src="{{ url_for('static', filename='terminmarktplatz-logo.png') }}" alt="Terminmarktplatz Logo" />
        </div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>
      <button class="btn secondary hamburger" id="hamburger" aria-label="Navigation umschalten">☰</button>
      <nav class="nav-links" id="nav-links">
        <a href="/portal" class="active">Portal</a>
        <a href="/preise">Preise</a>
        <a href="/impressum">Impressum</a>
        <a href="/datenschutz">Datenschutz</a>
      </nav>
      <div class="cta-group">
        <a class="btn" id="logout-btn">Logout</a>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero" style="padding:40px 0 16px">
      <div class="container">
        <span class="badge">Anbieter-Portal</span>
        <h1>Willkommen im Portal</h1>
        <p class="lead">Profil vervollständigen, Leistung festlegen und freie Slots schnell veröffentlichen – mit Duplizieren, Filtern und CSV-Export.</p>

        <div class="wizard">
          <div class="wiz-step" id="step-indicator-1"><div class="num">1</div> Profil</div>
          <div class="wiz-step" id="step-indicator-2"><div class="num">2</div> Leistung & Dauer</div>
          <div class="wiz-step" id="step-indicator-3"><div class="num">3</div> Erster Slot</div>
        </div>
      </div>
    </section>

    <section>
      <div class="container" style="display:grid; gap:16px">
        <!-- STEP 1: Profil -->
        <div class="panel" id="step-1">
          <h2>Schritt 1: Profil vervollständigen</h2>
          <p class="hint">Mindestens <strong>Firmenname</strong>, <strong>Branche</strong>, <strong>PLZ</strong> & <strong>Ort</strong> angeben.</p>
          <div class="alert" id="alert-1"></div>
          <div class="success" id="success-1">Profil gespeichert!</div>
          <form id="form-profile" class="form-grid" novalidate>
            <div class="field col-2"><label for="pf-company">Firmenname *</label><input id="pf-company" name="company_name" type="text" required></div>
            <div class="field col-2">
              <label for="pf-branch">Branche/Kategorie *</label>
              <input id="pf-branch" name="branch" list="branch-list" type="text" required placeholder="z. B. Friseur">
              <datalist id="branch-list">
                <option>Friseur</option><option>Kosmetik</option><option>Physiotherapie</option>
                <option>Nagelstudio</option><option>Zahnarzt</option><option>Handwerk</option>
                <option>KFZ-Service</option><option>Fitness</option><option>Coaching</option>
                <option>Tierarzt</option><option>Behörde</option><option>Sonstiges</option>
              </datalist>
            </div>
            <div class="field"><label for="pf-street">Straße & Nr.</label><input id="pf-street" name="street" type="text"></div>
            <div class="field"><label for="pf-zip">PLZ *</label><input id="pf-zip" name="zip" type="text" required pattern="\\d{5}" inputmode="numeric"></div>
            <div class="field col-2"><label for="pf-city">Ort *</label><input id="pf-city" name="city" type="text" required></div>
            <div class="field"><label for="pf-phone">Telefon</label><input id="pf-phone" name="phone" type="tel" pattern="^\\+?[0-9\\s\\-\\/]{6,}$"></div>
            <div class="field"><label for="pf-whatsapp">WhatsApp (optional)</label><input id="pf-whatsapp" name="whatsapp" type="tel" pattern="^\\+?[0-9\\s\\-\\/]{6,}$"></div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Profil speichern</button>
              <button class="btn" type="button" id="skip-1">Überspringen</button>
            </div>
          </form>
        </div>

        <!-- STEP 2: Leistung & Dauer (lokal) -->
        <div class="panel" id="step-2">
          <h2>Schritt 2: Leistung & Dauer</h2>
          <p class="hint">Dient als Vorlage für Slots (lokal gespeichert).</p>
          <div class="success" id="success-2" style="display:none">Leistungs-Vorlage gespeichert.</div>
          <form id="form-service" class="form-grid" novalidate>
            <div class="field col-2"><label for="sv-title">Leistungstitel *</label><input id="sv-title" type="text" required></div>
            <div class="field"><label for="sv-category">Kategorie *</label><input id="sv-category" list="branch-list" type="text" required></div>
            <div class="field"><label for="sv-duration">Dauer (Min) *</label><input id="sv-duration" type="number" min="10" step="5" required value="60"></div>
            <div class="field col-2"><label for="sv-notes">Hinweise</label><textarea id="sv-notes" rows="2"></textarea></div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Vorlage sichern</button>
              <button class="btn" type="button" id="skip-2">Überspringen</button>
            </div>
          </form>
        </div>

        <!-- STEP 3: Erster Slot -->
        <div class="panel" id="step-3">
          <h2>Schritt 3: Ersten Slot veröffentlichen</h2>
          <p class="hint">Start wählen – Ende berechnen wir aus der Dauer. Preis optional in €.</p>
          <div class="alert" id="alert-3"></div>
          <div class="success" id="success-3">Slot gespeichert! Status: <b>pending_review</b>.</div>
          <form id="form-slot" class="form-grid" novalidate>
            <div class="field col-2"><label for="sl-title">Titel *</label><input id="sl-title" name="title" type="text" required></div>
            <div class="field"><label for="sl-category">Kategorie *</label><input id="sl-category" name="category" list="branch-list" type="text" required></div>
            <div class="field"><label for="sl-start">Start *</label><input id="sl-start" name="start" type="datetime-local" required></div>
            <div class="field"><label for="sl-duration">Dauer (Min) *</label><input id="sl-duration" name="duration" type="number" min="10" step="5" required value="60"></div>
            <div class="field"><label for="sl-capacity">Kapazität</label><input id="sl-capacity" name="capacity" type="number" min="1" step="1" value="1"></div>
            <div class="field"><label for="sl-price">Preis (€)</label><input id="sl-price" name="price" type="number" min="0" step="1"></div>
            <div class="field col-2"><label for="sl-location">Ort / Anschrift</label><input id="sl-location" name="location" type="text"></div>
            <div class="field"><label for="sl-contact">Kontaktweg</label>
              <select id="sl-contact" name="contact_method">
                <option value="mail">E-Mail</option><option value="phone">Telefon</option><option value="web">Externer Link</option>
              </select>
            </div>
            <div class="field"><label for="sl-link">Buchungslink</label><input id="sl-link" name="booking_link" type="url" placeholder="https://…"></div>
            <div class="field col-2"><label for="sl-notes">Hinweise</label><textarea id="sl-notes" name="notes" rows="2"></textarea></div>
            <div class="form-actions col-2">
              <button class="btn primary" type="submit">Slot anlegen</button>
              <a class="btn" href="#" id="btn-refresh-slots">Slots aktualisieren</a>
              <button class="btn" type="button" id="btn-fill-from-service">Aus Vorlage übernehmen</button>
            </div>
          </form>
        </div>

        <!-- SLOTS MANAGEMENT -->
        <div class="panel" id="manage">
          <h2>Meine Slots verwalten</h2>
          <p class="hint">Filtere nach Status/Zeitraum, suche im Titel/Kategorie, sortiere und exportiere nach CSV. Veröffentlichen erfolgt per Admin-Freigabe.</p>

          <div class="toolbar">
            <div class="field">
              <label for="flt-status">Status</label>
              <select id="flt-status">
                <option value="">Alle</option>
                <option value="published">Veröffentlicht</option>
                <option value="pending_review">In Prüfung</option>
                <option value="archived">Archiviert</option>
              </select>
            </div>
            <div class="field">
              <label for="flt-from">Von</label>
              <input type="date" id="flt-from">
            </div>
            <div class="field">
              <label for="flt-to">Bis</label>
              <input type="date" id="flt-to">
            </div>
            <div class="field" style="min-width:220px">
              <label for="flt-q">Suchen</label>
              <input type="text" id="flt-q" placeholder="Titel/Kategorie">
            </div>
            <div class="field">
              <label for="flt-sort">Sortierung</label>
              <select id="flt-sort">
                <option value="start_asc">Start ↑</option>
                <option value="start_desc">Start ↓</option>
                <option value="title_asc">Titel A–Z</option>
                <option value="title_desc">Titel Z–A</option>
              </select>
            </div>
            <div class="form-actions">
              <button class="btn" id="btn-apply">Filter anwenden</button>
              <button class="btn" id="btn-clear">Zurücksetzen</button>
            </div>
          </div>

          <div class="quick-filters" style="margin:8px 0">
            <button class="btn" id="qf-today">Heute</button>
            <button class="btn" id="qf-tomorrow">Morgen</button>
            <button class="btn" id="qf-week">Diese Woche</button>
            <button class="btn" id="btn-export">CSV-Export (gefiltert)</button>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table" id="slots-table">
              <thead>
                <tr>
                  <th class="sel"><input type="checkbox" id="sel-all"></th>
                  <th>Titel</th>
                  <th>Kategorie</th>
                  <th>Start</th>
                  <th>Ende</th>
                  <th>Preis</th>
                  <th>Status</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="slots-tbody">
                <tr><td colspan="8" class="muted">Lade …</td></tr>
              </tbody>
            </table>
          </div>

          <div class="form-actions" style="justify-content:space-between">
            <div>
              <button class="btn" id="bulk-archive">Auswahl archivieren</button>
              <button class="btn" id="bulk-delete">Auswahl löschen</button>
            </div>
            <div class="muted" id="result-info">0 Einträge</div>
            <div class="pagination">
              <button class="btn" id="page-prev">←</button>
              <span id="page-indicator" class="muted">1 / 1</span>
              <button class="btn" id="page-next">→</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- EDIT MODAL -->
  <div class="modal" id="edit-modal" aria-hidden="true">
    <div class="dialog">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
        <h3>Slot bearbeiten</h3>
        <button class="btn" id="edit-close">Schließen</button>
      </div>
      <div class="alert" id="edit-alert"></div>
      <div class="success" id="edit-success">Änderungen gespeichert.</div>
      <form id="edit-form" class="form-grid" novalidate>
        <input type="hidden" id="ed-id">
        <div class="field col-2"><label for="ed-title">Titel *</label><input id="ed-title" type="text" required></div>
        <div class="field"><label for="ed-category">Kategorie *</label><input id="ed-category" list="branch-list" type="text" required></div>
        <div class="field"><label for="ed-start">Start *</label><input id="ed-start" type="datetime-local" required></div>
        <div class="field"><label for="ed-duration">Dauer (Min)</label><input id="ed-duration" type="number" min="10" step="5"></div>
        <div class="field"><label for="ed-end">Ende *</label><input id="ed-end" type="datetime-local" required></div>
        <div class="field"><label for="ed-cap">Kapazität</label><input id="ed-cap" type="number" min="1" step="1"></div>
        <div class="field"><label for="ed-price">Preis (€)</label><input id="ed-price" type="number" min="0" step="1"></div>
        <div class="field col-2"><label for="ed-location">Ort</label><input id="ed-location" type="text"></div>
        <div class="field"><label for="ed-contact">Kontaktweg</label>
          <select id="ed-contact"><option value="mail">E-Mail</option><option value="phone">Telefon</option><option value="web">Externer Link</option></select>
        </div>
        <div class="field"><label for="ed-link">Buchungslink</label><input id="ed-link" type="url"></div>
        <div class="field col-2"><label for="ed-notes">Hinweise</label><textarea id="ed-notes" rows="2"></textarea></div>
        <div class="field col-2">
          <label for="ed-status">Status</label>
          <select id="ed-status">
            <option value="pending_review">In Prüfung</option>
            <option value="archived">Archiviert</option>
            <!-- "published" bleibt Admin-Freigabe -->
          </select>
          <span class="hint">„Veröffentlicht“ wird durch das Team freigegeben.</span>
        </div>
        <div class="form-actions col-2">
          <button class="btn primary" type="submit">Speichern</button>
          <button class="btn" type="button" id="ed-archive">Archivieren</button>
          <button class="btn" type="button" id="ed-delete">Löschen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- DUPLICATE MODAL -->
  <div class="modal" id="dup-modal" aria-hidden="true">
    <div class="dialog">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
        <h3>Slot duplizieren</h3>
        <button class="btn" id="dup-close">Schließen</button>
      </div>
      <p class="hint" id="dup-hint">Neuen Start wählen. Ende wird aus der Dauer berechnet.</p>
      <div class="alert" id="dup-alert"></div>
      <div class="success" id="dup-success">Duplikat angelegt.</div>
      <form id="dup-form" class="form-grid" novalidate>
        <input type="hidden" id="dup-src-id">
        <div class="field col-2"><label for="dup-title">Titel</label><input id="dup-title" type="text" disabled></div>
        <div class="field"><label for="dup-start">Neuer Start *</label><input id="dup-start" type="datetime-local" required></div>
        <div class="field"><label for="dup-duration">Dauer (Min)</label><input id="dup-duration" type="number" min="10" step="5"></div>
        <div class="form-actions col-2">
          <button class="btn" type="button" id="dup-plus-day">+1 Tag</button>
          <button class="btn" type="button" id="dup-plus-week">+1 Woche</button>
          <button class="btn primary" type="submit">Duplikat erstellen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="{{ url_for('static', filename='terminmarktplatz-logo.png') }}" alt="Terminmarktplatz Logo klein"/>
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte Lösungen für deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="/wie-es-funktioniert">Wie es funktioniert</a>
        <a class="foot-link" href="/kategorien">Kategorien</a>
        <a class="foot-link" href="/preise">Preise</a>
        <a class="foot-link" href="/anbieter">Für Anbieter</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="/impressum">Impressum</a>
        <a class="foot-link" href="/datenschutz">Datenschutz</a>
        <a class="foot-link" href="/agb">AGB</a>
        <a class="foot-link" href="/widerruf">Widerruf</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="/kontakt">Kontaktformular</a>
        <a class="foot-link" href="mailto:hello@terminmarktplatz.de">hello@terminmarktplatz.de</a>
        <a class="foot-link" href="/blog">Blog</a>
      </div>
    </div>
    <div class="container copyright">© <span id="y"></span> Terminmarktplatz · Alle Rechte vorbehalten.</div>
  </footer>

  <script>
    // Mobile Nav + Footer-Jahr
    const nav = document.querySelector('.nav');
    document.getElementById('hamburger')?.addEventListener('click', ()=>nav.classList.toggle('open'));
    document.getElementById('y').textContent = new Date().getFullYear();

    // Helpers
    function markDone(n, done){ document.getElementById('step-indicator-'+n).classList.toggle('done', !!done); }
    function setVal(id, val){ const el = document.getElementById(id); if(el && val!=null && (el.value==='' || el.value==null)) el.value = val; }
    function show(id, msg){ const el=document.getElementById(id); if(msg!==undefined) el.textContent=msg; el.style.display='block'; }
    function hide(id){ const el=document.getElementById(id); el.style.display='none'; el.textContent=''; }
    function pad(n){return String(n).padStart(2,'0');}
    function toIsoLocal(dtStr){ return dtStr && dtStr.length===16 ? dtStr+':00' : dtStr; }
    function addMinutesLocal(dtStr, minutes){
      const [d,t]=dtStr.split('T'); const [Y,M,D]=d.split('-').map(Number); const [h,m]=t.split(':').map(Number);
      const base=new Date(Y,M-1,D,h,m,0,0); const end=new Date(base.getTime()+minutes*60000);
      return `${end.getFullYear()}-${pad(end.getMonth()+1)}-${pad(end.getDate())}T${pad(end.getHours())}:${pad(end.getMinutes())}:${pad(end.getSeconds())}`;
    }
    function fromIsoToLocalInput(iso){ return iso ? iso.slice(0,16) : ''; }
    function durationFromISO(startISO, endISO){
      try{
        const s=new Date(startISO), e=new Date(endISO);
        return Math.max(0, Math.round((e - s)/60000));
      }catch{return 0;}
    }

    // Auth + Profil laden
    let ME = null;
    async function loadMeOrRedirect(){
      try{
        const res = await fetch('/me', {credentials:'include'});
        if(!res.ok){ window.location.href = '/login?tab=login'; return; }
        ME = await res.json();
        setVal('pf-company', ME.company_name); setVal('pf-branch', ME.branch);
        setVal('pf-street', ME.street); setVal('pf-zip', ME.zip); setVal('pf-city', ME.city);
        setVal('pf-phone', ME.phone); setVal('pf-whatsapp', ME.whatsapp);
        setVal('sl-location', [ME.street, ME.zip, ME.city].filter(Boolean).join(', '));
        const ok = !!(ME.company_name && ME.branch && ME.zip && ME.city);
        markDone(1, ok);
      }catch(e){ window.location.href = '/login?tab=login'; }
    }

    // Schritt 1: Profil speichern
    document.getElementById('form-profile').addEventListener('submit', async (e)=>{
      e.preventDefault(); hide('alert-1'); hide('success-1');
      const payload = {
        company_name: document.getElementById('pf-company').value.trim(),
        branch: document.getElementById('pf-branch').value.trim(),
        street: document.getElementById('pf-street').value.trim(),
        zip: document.getElementById('pf-zip').value.trim(),
        city: document.getElementById('pf-city').value.trim(),
        phone: document.getElementById('pf-phone').value.trim(),
        whatsapp: document.getElementById('pf-whatsapp').value.trim(),
      };
      if(!payload.company_name || !payload.branch || !payload.zip || !payload.city){
        return show('alert-1','Bitte Pflichtfelder ausfüllen (Firma, Branche, PLZ, Ort).');
      }
      try{
        const res = await fetch('/me',{method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(payload)});
        if(!res.ok) return show('alert-1','Konnte Profil nicht speichern.');
        show('success-1','Profil gespeichert!'); markDone(1, true);
        if(!document.getElementById('sv-category').value) document.getElementById('sv-category').value = payload.branch;
        if(!document.getElementById('sl-category').value) document.getElementById('sl-category').value = payload.branch;
      }catch{ show('alert-1','Netzwerkfehler – bitte später erneut versuchen.'); }
    });
    document.getElementById('skip-1').addEventListener('click', ()=>{ markDone(1, false); window.scrollTo({top:document.getElementById('step-2').offsetTop-40, behavior:'smooth'}); });

    // Schritt 2: Leistung (lokal)
    const SERVICE = { title:'', category:'', duration:60, notes:'' };
    document.getElementById('form-service').addEventListener('submit', (e)=>{
      e.preventDefault();
      SERVICE.title = document.getElementById('sv-title').value.trim();
      SERVICE.category = document.getElementById('sv-category').value.trim();
      SERVICE.duration = parseInt(document.getElementById('sv-duration').value,10)||60;
      SERVICE.notes = document.getElementById('sv-notes').value.trim();
      if(!SERVICE.title || !SERVICE.category || !SERVICE.duration) return;
      document.getElementById('success-2').style.display='block'; markDone(2, true);
      window.scrollTo({top:document.getElementById('step-3').offsetTop-40, behavior:'smooth'});
    });
    document.getElementById('skip-2').addEventListener('click', ()=>{ markDone(2, false); window.scrollTo({top:document.getElementById('step-3').offsetTop-40, behavior:'smooth'}); });
    document.getElementById('btn-fill-from-service').addEventListener('click', ()=>{
      if(SERVICE.title) setVal('sl-title', SERVICE.title);
      if(SERVICE.category) setVal('sl-category', SERVICE.category);
      if(SERVICE.duration) setVal('sl-duration', SERVICE.duration);
      if(SERVICE.notes) setVal('sl-notes', SERVICE.notes);
    });

    // Schritt 3: Slot anlegen
    document.getElementById('form-slot').addEventListener('submit', async (e)=>{
      e.preventDefault(); hide('alert-3'); hide('success-3');
      const title=document.getElementById('sl-title').value.trim();
      const category=document.getElementById('sl-category').value.trim();
      const startLocal=document.getElementById('sl-start').value;
      const duration=parseInt(document.getElementById('sl-duration').value,10)||60;
      if(!title || !category || !startLocal || duration<=0) return show('alert-3','Bitte Titel, Kategorie, Start & Dauer prüfen.');
      const payload={
        title, category,
        start_at: toIsoLocal(startLocal),
        end_at: addMinutesLocal(startLocal, duration),
        location: document.getElementById('sl-location').value.trim() || [ME?.street,ME?.zip,ME?.city].filter(Boolean).join(', '),
        capacity: parseInt(document.getElementById('sl-capacity').value,10)||1,
        contact_method: document.getElementById('sl-contact').value || 'mail',
        booking_link: document.getElementById('sl-link').value.trim() || null,
        price_cents: (()=>{
          const eur=parseFloat(document.getElementById('sl-price').value);
          return Number.isFinite(eur)?Math.round(eur*100):null;
        })(),
        notes: document.getElementById('sl-notes').value.trim() || null
      };
      try{
        const res=await fetch('/slots',{method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(payload)});
        if(!res.ok){
          const data=await res.json().catch(()=>({error:'Fehler'}));
          const map={missing_fields:'Pflichtfelder fehlen.', bad_datetime:'Datum/Uhrzeit ungültig.', end_before_start:'Ende vor Start.', limit_reached:'Limit erreicht – bitte alte Slots archivieren.'};
          return show('alert-3', map[data.error]||'Konnte Slot nicht speichern.');
        }
        show('success-3','Slot gespeichert! Status: pending_review.'); markDone(3,true); loadSlots();
      }catch{ show('alert-3','Netzwerkfehler – bitte später erneut versuchen.'); }
    });
    document.getElementById('btn-refresh-slots').addEventListener('click', (e)=>{ e.preventDefault(); loadSlots(); });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async ()=>{ try{await fetch('/auth/logout',{method:'POST',credentials:'include'});}catch{} window.location.href='/'; });

    // --------- Slots-Verwaltung ---------
    let ALL_SLOTS=[], PAGE=1, PAGE_SIZE=10;

    // Filter-UI
    const $status=document.getElementById('flt-status');
    const $from=document.getElementById('flt-from');
    const $to=document.getElementById('flt-to');
    const $q=document.getElementById('flt-q');
    const $sort=document.getElementById('flt-sort');
    document.getElementById('btn-apply').addEventListener('click', (e)=>{ e.preventDefault(); PAGE=1; renderTable(); });
    document.getElementById('btn-clear').addEventListener('click', (e)=>{
      e.preventDefault(); $status.value=''; $from.value=''; $to.value=''; $q.value=''; $sort.value='start_asc'; PAGE=1; renderTable();
    });

    // Schnellfilter
    function setDateRange(d1, d2){ $from.value=d1; $to.value=d2; PAGE=1; renderTable(); }
    document.getElementById('qf-today').addEventListener('click', ()=>{
      const n=new Date(); const s=`${n.getFullYear()}-${pad(n.getMonth()+1)}-${pad(n.getDate())}`;
      setDateRange(s,s);
    });
    document.getElementById('qf-tomorrow').addEventListener('click', ()=>{
      const n=new Date(); n.setDate(n.getDate()+1);
      const s=`${n.getFullYear()}-${pad(n.getMonth()+1)}-${pad(n.getDate())}`;
      setDateRange(s,s);
    });
    document.getElementById('qf-week').addEventListener('click', ()=>{
      const n=new Date(); const day=n.getDay()||7; // Mo=1..So=7
      const monday=new Date(n); monday.setDate(n.getDate()-(day-1));
      const sunday=new Date(monday); sunday.setDate(monday.getDate()+6);
      const s1=`${monday.getFullYear()}-${pad(monday.getMonth()+1)}-${pad(monday.getDate())}`;
      const s2=`${sunday.getFullYear()}-${pad(sunday.getMonth()+1)}-${pad(sunday.getDate())}`;
      setDateRange(s1,s2);
    });

    // CSV-Export (gefilterte Liste)
    document.getElementById('btn-export').addEventListener('click', ()=>{
      const items = filterSlots(ALL_SLOTS);
      if(!items.length){ alert('Keine Daten für Export.'); return; }
      const rows = [
        ['ID','Titel','Kategorie','Start','Ende','Status','Kapazität','Preis (EUR)','Ort','Kontaktweg','Buchungslink','Notizen']
      ];
      items.forEach(x=>{
        rows.push([
          x.id, x.title||'', x.category||'',
          x.start_at, x.end_at, x.status||'',
          x.capacity??'', (x.price_cents!=null? Math.round(x.price_cents/100):''),
          x.location||'', x.contact_method||'', x.booking_link||'', (x.notes||'').replace(/\s+/g,' ').trim()
        ]);
      });
      const csv = rows.map(r=>r.map(v=>{
        const s=String(v??''); return s.includes(';')||s.includes('"')||s.includes('\n') ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `slots_${ts}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
    });

    // Pagination
    document.getElementById('page-prev').addEventListener('click', ()=>{ if(PAGE>1){ PAGE--; renderTable(); }});
    document.getElementById('page-next').addEventListener('click', ()=>{
      const totalFiltered = filterSlots(ALL_SLOTS).length;
      const maxPage = Math.max(1, Math.ceil(totalFiltered/PAGE_SIZE));
      if(PAGE<maxPage){ PAGE++; renderTable(); }
    });

    // Laden
    async function loadSlots(){
      const qs = $status.value ? ('?status='+encodeURIComponent($status.value)) : '';
      const tbody=document.getElementById('slots-tbody');
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Lade …</td></tr>`;
      try{
        const res = await fetch('/slots'+qs, {credentials:'include'});
        if(!res.ok){ tbody.innerHTML = `<tr><td colspan="8" class="muted">Keine Slots abrufbar.</td></tr>`; return; }
        ALL_SLOTS = await res.json();
        PAGE=1; renderTable();
      }catch{
        tbody.innerHTML = `<tr><td colspan="8" class="muted">Fehler beim Laden.</td></tr>`;
      }
    }

    function filterSlots(items){
      const s = $status.value.trim();
      const q = $q.value.trim().toLowerCase();
      const f = $from.value ? new Date($from.value+'T00:00:00') : null;
      const t = $to.value ? new Date($to.value+'T23:59:59') : null;
      let arr = items.filter(x=>{
        if(s && x.status!==s) return false;
        const title = (x.title||'').toLowerCase();
        const cat = (x.category||'').toLowerCase();
        if(q && !(title.includes(q)||cat.includes(q))) return false;
        const start = new Date(x.start_at);
        if(f && start < f) return false;
        if(t && start > t) return false;
        return true;
      });
      // Sort
      const sort = $sort.value;
      arr.sort((a,b)=>{
        if(sort==='start_asc') return new Date(a.start_at)-new Date(b.start_at);
        if(sort==='start_desc') return new Date(b.start_at)-new Date(a.start_at);
        if(sort==='title_asc') return (a.title||'').localeCompare(b.title||'');
        if(sort==='title_desc') return (b.title||'').localeCompare(a.title||'');
        return 0;
      });
      return arr;
    }

    function eurFromCents(cents){
      if(cents==null) return '–';
      return Math.round(cents/100)+' €';
    }
    function badge(status){
      const cls = status==='published'?'status-published':(status==='archived'?'status-archived':'status-pending_review');
      const label = status==='published'?'Veröffentlicht':(status==='archived'?'Archiviert':'In Prüfung');
      return `<span class="status-badge ${cls}">${label}</span>`;
    }

    function renderTable(){
      const body = document.getElementById('slots-tbody');
      const items = filterSlots(ALL_SLOTS);
      const total = items.length;
      const maxPage = Math.max(1, Math.ceil(total/PAGE_SIZE));
      if(PAGE>maxPage) PAGE = maxPage;

      const startIdx = (PAGE-1)*PAGE_SIZE;
      const pageItems = items.slice(startIdx, startIdx+PAGE_SIZE);

      if(!pageItems.length){
        body.innerHTML = `<tr><td colspan="8" class="muted">Keine Einträge.</td></tr>`;
      } else {
        body.innerHTML = pageItems.map(x=>{
          const start = x.start_at.replace('T',' ').slice(0,16);
          const end   = x.end_at.replace('T',' ').slice(0,16);
          return `<tr data-id="${x.id}">
            <td class="sel"><input type="checkbox" class="sel-row"></td>
            <td><b>${x.title||''}</b></td>
            <td>${x.category||''}</td>
            <td>${start}</td>
            <td>${end}</td>
            <td>${eurFromCents(x.price_cents)}</td>
            <td>${badge(x.status)}</td>
            <td class="actions">
              <button class="btn" data-act="edit">Bearbeiten</button>
              <button class="btn" data-act="duplicate">Duplizieren</button>
              <button class="btn" data-act="archive">Archivieren</button>
              <button class="btn" data-act="delete">Löschen</button>
            </td>
          </tr>`;
        }).join('');
      }

      document.getElementById('result-info').textContent = `${total} Einträge`;
      document.getElementById('page-indicator').textContent = `${PAGE} / ${maxPage}`;

      // Select-All
      const selAll = document.getElementById('sel-all');
      selAll.checked = false;
      selAll.addEventListener('change', (e)=>{
        body.querySelectorAll('.sel-row').forEach(cb=>cb.checked = selAll.checked);
      });

      // action listeners
      body.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const tr = e.target.closest('tr');
          const id = tr?.dataset.id;
          const slot = ALL_SLOTS.find(s=>s.id===id);
          const act = e.target.dataset.act;
          if(!id || !slot) return;
          if(act==='edit') openEdit(slot);
          if(act==='duplicate') openDuplicate(slot);
          if(act==='archive') confirmArchive(slot);
          if(act==='delete') confirmDelete(slot);
        });
      });
    }

    // --------- Edit Modal ---------
    const modal = document.getElementById('edit-modal');
    function openEdit(slot){
      hide('edit-alert'); hide('edit-success');
      modal.style.display='flex';
      document.getElementById('ed-id').value = slot.id;
      document.getElementById('ed-title').value = slot.title||'';
      document.getElementById('ed-category').value = slot.category||'';
      document.getElementById('ed-start').value = fromIsoToLocalInput(slot.start_at);
      document.getElementById('ed-end').value = fromIsoToLocalInput(slot.end_at);
      document.getElementById('ed-cap').value = slot.capacity||1;
      document.getElementById('ed-price').value = slot.price_cents!=null ? Math.round(slot.price_cents/100) : '';
      document.getElementById('ed-location').value = slot.location||'';
      document.getElementById('ed-contact').value = slot.contact_method||'mail';
      document.getElementById('ed-link').value = slot.booking_link||'';
      document.getElementById('ed-notes').value = slot.notes||'';
      document.getElementById('ed-status').value = (slot.status==='archived'?'archived':'pending_review');
      // Dauer als Vorschlag
      document.getElementById('ed-duration').value = durationFromISO(slot.start_at, slot.end_at) || '';
    }
    document.getElementById('edit-close').addEventListener('click', ()=>{ modal.style.display='none'; });
    document.getElementById('ed-duration').addEventListener('input', ()=>{
      const d = parseInt(document.getElementById('ed-duration').value,10)||0;
      const s = document.getElementById('ed-start').value;
      if(d>0 && s){ document.getElementById('ed-end').value = addMinutesLocal(s, d).slice(0,16); }
    });
    document.getElementById('edit-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); hide('edit-alert'); hide('edit-success');
      const id = document.getElementById('ed-id').value;
      const payload = {
        title: document.getElementById('ed-title').value.trim(),
        category: document.getElementById('ed-category').value.trim(),
        location: document.getElementById('ed-location').value.trim()||null,
        capacity: parseInt(document.getElementById('ed-cap').value,10)||1,
        contact_method: document.getElementById('ed-contact').value||'mail',
        booking_link: document.getElementById('ed-link').value.trim()||null,
        price_cents: (()=>{
          const eur=parseFloat(document.getElementById('ed-price').value);
          return Number.isFinite(eur)?Math.round(eur*100):null;
        })(),
        notes: document.getElementById('ed-notes').value.trim()||null,
        status: document.getElementById('ed-status').value
      };
      const start = document.getElementById('ed-start').value;
      const end = document.getElementById('ed-end').value;
      if(start) payload.start_at = toIsoLocal(start);
      if(end) payload.end_at = toIsoLocal(end);

      try{
        const res = await fetch(`/slots/${encodeURIComponent(id)}`, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          credentials:'include', body: JSON.stringify(payload)
        });
        if(!res.ok) return show('edit-alert','Konnte Slot nicht speichern.');
        show('edit-success','Änderungen gespeichert.');
        await loadSlots();
        setTimeout(()=>{ modal.style.display='none'; }, 600);
      }catch{ show('edit-alert','Netzwerkfehler – bitte später erneut versuchen.'); }
    });
    document.getElementById('ed-archive').addEventListener('click', async ()=>{
      const id = document.getElementById('ed-id').value;
      try{
        const res=await fetch(`/slots/${encodeURIComponent(id)}`,{
          method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({status:'archived'})
        });
        if(!res.ok){ show('edit-alert','Konnte Slot nicht archivieren.'); return; }
        await loadSlots(); modal.style.display='none';
      }catch{ show('edit-alert','Netzwerkfehler.'); }
    });
    document.getElementById('ed-delete').addEventListener('click', async ()=>{
      const id = document.getElementById('ed-id').value;
      if(!confirm('Diesen Slot dauerhaft löschen?')) return;
      try{
        const res=await fetch(`/slots/${encodeURIComponent(id)}`,{method:'DELETE', credentials:'include'});
        if(!res.ok){ show('edit-alert','Konnte Slot nicht löschen.'); return; }
        await loadSlots(); modal.style.display='none';
      }catch{ show('edit-alert','Netzwerkfehler.'); }
    });

    // --------- Duplicate Modal ---------
    const dmodal = document.getElementById('dup-modal');
    function openDuplicate(slot){
      hide('dup-alert'); hide('dup-success'); dmodal.style.display='flex';
      document.getElementById('dup-src-id').value = slot.id;
      document.getElementById('dup-title').value = slot.title||'';
      const startLocal = fromIsoToLocalInput(slot.start_at);
      document.getElementById('dup-start').value = startLocal ? startLocal : '';
      document.getElementById('dup-duration').value = durationFromISO(slot.start_at, slot.end_at) || '';
      // Hinweis
      document.getElementById('dup-hint').textContent = `Basis: ${slot.category||'Kategorie'} • ${startLocal?.replace('T',' ')} (${document.getElementById('dup-duration').value||'–'} Min)`;
      // Buttons
      document.getElementById('dup-plus-day').onclick = ()=>{
        const v = document.getElementById('dup-start').value || startLocal;
        if(!v) return;
        const d = new Date(v.replace('T',' ') + ':00');
        d.setDate(d.getDate()+1);
        document.getElementById('dup-start').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      };
      document.getElementById('dup-plus-week').onclick = ()=>{
        const v = document.getElementById('dup-start').value || startLocal;
        if(!v) return;
        const d = new Date(v.replace('T',' ') + ':00');
        d.setDate(d.getDate()+7);
        document.getElementById('dup-start').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      };
    }
    document.getElementById('dup-close').addEventListener('click', ()=>{ dmodal.style.display='none'; });
    document.getElementById('dup-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); hide('dup-alert'); hide('dup-success');
      const id = document.getElementById('dup-src-id').value;
      const src = ALL_SLOTS.find(s=>s.id===id);
      if(!src) return show('dup-alert','Quelle nicht gefunden.');
      const start = document.getElementById('dup-start').value;
      const dur = parseInt(document.getElementById('dup-duration').value,10) || durationFromISO(src.start_at, src.end_at) || 60;
      if(!start || dur<=0) return show('dup-alert','Bitte Start und Dauer prüfen.');
      const payload = {
        title: src.title, category: src.category,
        start_at: toIsoLocal(start),
        end_at: addMinutesLocal(start, dur),
        location: src.location, capacity: src.capacity||1,
        contact_method: src.contact_method||'mail', booking_link: src.booking_link||null,
        price_cents: src.price_cents??null, notes: src.notes||null
      };
      try{
        const res=await fetch('/slots',{method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(payload)});
        if(!res.ok){
          const data=await res.json().catch(()=>({error:'Fehler'}));
          const map={missing_fields:'Pflichtfelder fehlen.', bad_datetime:'Datum/Uhrzeit ungültig.', end_before_start:'Ende vor Start.', limit_reached:'Limit erreicht – bitte alte Slots archivieren.'};
          return show('dup-alert', map[data.error]||'Konnte Duplikat nicht anlegen.');
        }
        show('dup-success','Duplikat angelegt.'); await loadSlots();
        setTimeout(()=>{ dmodal.style.display='none'; }, 600);
      }catch{ show('dup-alert','Netzwerkfehler – bitte später erneut versuchen.'); }
    });

    // Bulk-Actions
    function selectedIds(){
      return Array.from(document.querySelectorAll('#slots-tbody tr')).filter(tr=>tr.querySelector('.sel-row')?.checked).map(tr=>tr.dataset.id);
    }
    document.getElementById('bulk-archive').addEventListener('click', async ()=>{
      const ids = selectedIds(); if(!ids.length) return alert('Keine Auswahl.');
      if(!confirm(`${ids.length} Slots archivieren?`)) return;
      for(const id of ids){
        try{ await fetch(`/slots/${encodeURIComponent(id)}`, {method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({status:'archived'})}); }catch{}
      }
      await loadSlots();
    });
    document.getElementById('bulk-delete').addEventListener('click', async ()=>{
      const ids = selectedIds(); if(!ids.length) return alert('Keine Auswahl.');
      if(!confirm(`${ids.length} Slots dauerhaft löschen?`)) return;
      for(const id of ids){
        try{ await fetch(`/slots/${encodeURIComponent(id)}`, {method:'DELETE', credentials:'include'}); }catch{}
      }
      await loadSlots();
    });

    // Einzel-Aktionen (Archiv/Löschen)
    async function confirmArchive(slot){
      if(!confirm(`Slot „${slot.title}“ archivieren?`)) return;
      try{
        const res=await fetch(`/slots/${encodeURIComponent(slot.id)}`,{
          method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({status:'archived'})
        });
        if(!res.ok){ alert('Konnte Slot nicht archivieren.'); return; }
        await loadSlots();
      }catch{ alert('Netzwerkfehler.'); }
    }
    async function confirmDelete(slot){
      if(!confirm(`Slot „${slot.title}“ dauerhaft löschen?`)) return;
      try{
        const res=await fetch(`/slots/${encodeURIComponent(slot.id)}`,{method:'DELETE', credentials:'include'});
        if(!res.ok){ alert('Konnte Slot nicht löschen.'); return; }
        await loadSlots();
      }catch{ alert('Netzwerkfehler.'); }
    }

    // Init
    (async function init(){
      document.getElementById('y').textContent = new Date().getFullYear();
      await loadMeOrRedirect();
      if(!document.getElementById('sl-duration').value) document.getElementById('sl-duration').value = 60;
      loadSlots();
    })();
  </script>
</body>
</html>
