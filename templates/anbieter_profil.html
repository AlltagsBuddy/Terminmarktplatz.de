<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ provider.name }} | Terminmarktplatz</title>
  <meta name="description" content="Öffentliches Anbieterprofil mit verfügbaren Terminen." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/" />

  <link rel="icon" href="static/favicon.png"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="static/style.css?v=20251103" />

  <style>
    .profile-grid{display:grid; gap:16px}
    @media(min-width: 920px){ .profile-grid{grid-template-columns: 1fr 1.2fr} }
    .profile-card{display:flex; gap:12px; align-items:center}
    .profile-logo{width:72px; height:72px; border-radius:14px; object-fit:cover; border:1px solid #e2e8f0; background:#fff}
    .slot-table .badge{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border)}
    .badge-cat{background:#eef2ff; color:#4338ca}
    .price{font-weight:700}
    .book-dialog{
      border:none;
      border-radius:18px;
      padding:0;
      max-width:480px;
      width:calc(100% - 32px);
      background:#fff;
      color:#111;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
    }
    .book-dialog .panel{ margin:0; }
  </style>
</head>
<body>
  {% include "_header.html" %}

  <main>
    <section class="hero" style="padding:36px 0 18px">
      <div class="container">
        <span class="badge">Anbieterprofil</span>
        <h1>{{ provider.name }}</h1>
        {% if provider.branch %}
          <p class="lead">{{ provider.branch }}</p>
        {% endif %}
      </div>
    </section>

    <section>
      <div class="container profile-grid">
        <div class="panel">
          <div class="profile-card">
            {% if provider.logo_url %}
              <img class="profile-logo" src="{{ provider.logo_url }}" alt="Logo {{ provider.name }}">
            {% endif %}
            <div>
              <div style="font-weight:700; font-size:1.1rem;">{{ provider.name }}</div>
              {% if provider.address %}
                <div class="muted">{{ provider.address }}</div>
              {% endif %}
            </div>
          </div>

          <div style="margin-top:12px">
            {% if provider.phone %}
              <div><strong>Telefon:</strong> <a href="tel:{{ provider.phone }}">{{ provider.phone }}</a></div>
            {% endif %}
            {% if provider.whatsapp %}
              <div><strong>WhatsApp:</strong> <a href="https://wa.me/{{ provider.whatsapp|replace('+','') }}">{{ provider.whatsapp }}</a></div>
            {% endif %}
          </div>
        </div>

        <div class="panel">
          <h2>Verfügbare Termine</h2>
          {% if slots and slots|length > 0 %}
            <div class="table-wrap slot-table">
              <table class="table">
                <thead>
                  <tr>
                    <th>Datum</th>
                    <th>Zeit</th>
                    <th>Titel</th>
                    <th>Kategorie</th>
                    <th>Ort</th>
                    <th>Preis</th>
                    <th>Aktion</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in slots %}
                  <tr>
                    <td>{{ s.start_date }}</td>
                    <td>{{ s.start_time }} – {{ s.end_time }}</td>
                    <td>
                      <div style="font-weight:600;">{{ s.title }}</div>
                      {% if s.description %}
                        <div class="muted" style="font-size:12px;">{{ s.description }}</div>
                      {% endif %}
                    </td>
                    <td><span class="badge badge-cat">{{ s.category }}</span></td>
                    <td>{{ s.address }}</td>
                    <td class="price">{% if s.price_eur %}{{ s.price_eur }} €{% else %}-{% endif %}</td>
                    <td>
                      <button class="btn" type="button" data-book="{{ s.id }}" data-title="{{ s.title }}">Buchen</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="muted">Aktuell sind keine öffentlichen Termine verfügbar.</div>
          {% endif %}
        </div>
      </div>
    </section>

    <dialog id="book-dialog" class="book-dialog">
      <div class="panel" style="padding:16px;">
        <h3 style="margin-top:0;">Termin buchen</h3>
        <p class="muted" id="book-slot-title">Bitte Termin auswählen.</p>
        <form id="book-form">
          <input type="hidden" id="book-slot-id">
          <div class="field">
            <label for="book-name">Name <span class="req">*</span></label>
            <input id="book-name" required placeholder="Vor- und Nachname">
          </div>
          <div class="field">
            <label for="book-email">E-Mail <span class="req">*</span></label>
            <input id="book-email" type="email" required placeholder="name@example.com">
          </div>
          <div class="toolbar" style="justify-content:flex-end;">
            <button type="button" class="btn" id="book-cancel">Abbrechen</button>
            <button type="submit" class="btn primary">Buchung anfragen</button>
          </div>
          <div id="book-msg" class="msg"></div>
        </form>
      </div>
    </dialog>

    <section>
      <div class="container">
        <div class="panel">
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <h2 style="margin:0;">Bewertungen</h2>
            {% if review_avg %}
              <span class="badge">{{ review_avg }} ★</span>
              <span class="muted">({{ review_count }} Bewertungen)</span>
            {% else %}
              <span class="muted">Noch keine Bewertungen</span>
            {% endif %}
          </div>

          {% if reviews and reviews|length > 0 %}
            <div style="margin-top:12px; display:grid; gap:12px;">
              {% for r in reviews %}
                <div style="border:1px solid var(--border); border-radius:12px; padding:12px;">
                  <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
                    <div style="font-weight:600;">{{ r.reviewer_name }}</div>
                    <div>{{ "★" * r.rating }}{{ "☆" * (5 - r.rating) }}</div>
                  </div>
                  {% if r.comment %}
                    <div style="margin-top:6px; color:#475569;">{{ r.comment }}</div>
                  {% endif %}
                  {% if r.reply_text %}
                    <div style="margin-top:10px; padding:8px 10px; background:#f8fafc; border-radius:8px;">
                      <div style="font-weight:600;">Antwort des Anbieters</div>
                      <div class="muted" style="margin-top:4px;">{{ r.reply_text }}</div>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </section>
  </main>

  <script>
    const API = (() => {
      const h = location.hostname;
      const proto = location.protocol;
      const isLocal =
        h === 'localhost' ||
        h === '127.0.0.1' ||
        /^192\.168\./.test(h) ||
        /^10\./.test(h) ||
        h.endsWith('.local');
      if (isLocal) return `${proto}//${h}:5000`;
      if (h.includes('testsystem') || h.includes('onrender.com')) return `${proto}//${location.host}`;
      if (h === 'api.terminmarktplatz.de') return `${proto}//${h}`;
      return 'https://api.terminmarktplatz.de';
    })();

    const dialog = document.getElementById('book-dialog');
    const form = document.getElementById('book-form');
    const msg = document.getElementById('book-msg');
    const titleEl = document.getElementById('book-slot-title');
    const slotIdEl = document.getElementById('book-slot-id');
    const cancelBtn = document.getElementById('book-cancel');

    function showBookMsg(text, ok=false){
      if (!msg) return;
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
      msg.textContent = text;
      msg.style.display = 'block';
      setTimeout(()=>{ msg.style.display = 'none'; }, ok ? 3000 : 6000);
    }

    function openBookDialog(slotId, title){
      if (!dialog || !form) return;
      slotIdEl.value = slotId;
      titleEl.textContent = title ? `Termin: ${title}` : 'Termin buchen';
      form.reset();
      if (dialog.showModal) dialog.showModal();
      else dialog.setAttribute('open', '');
    }

    function closeBookDialog(){
      if (!dialog) return;
      if (dialog.close) dialog.close();
      else dialog.removeAttribute('open');
    }

    document.querySelectorAll('[data-book]').forEach(btn => {
      btn.addEventListener('click', () => {
        openBookDialog(btn.dataset.book, btn.dataset.title || '');
      });
    });

    cancelBtn?.addEventListener('click', closeBookDialog);

    form?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const slot_id = slotIdEl.value;
      const name = document.getElementById('book-name').value.trim();
      const email = document.getElementById('book-email').value.trim();
      if (!slot_id || !name || !email) {
        showBookMsg('Bitte Name und E‑Mail angeben.');
        return;
      }
      try{
        const res = await fetch(`${API}/public/book`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ slot_id, name, email })
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok){
          showBookMsg(data.error || 'Buchung konnte nicht erstellt werden.');
          return;
        }
        showBookMsg('Buchung angefragt. Bitte E‑Mail bestätigen.', true);
        setTimeout(closeBookDialog, 1200);
      }catch(e){
        showBookMsg('Netzwerkfehler.');
      }
    });
  </script>

  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein">
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte Lösungen für deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">Für Anbieter</a>
        <a class="foot-link" href="suchende.html">Für Suchende</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
        <a class="foot-link" href="cookie-einstellungen.html">Cookie-Einstellungen</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">© <span id="y"></span> Terminmarktplatz · Alle Rechte vorbehalten.</div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
