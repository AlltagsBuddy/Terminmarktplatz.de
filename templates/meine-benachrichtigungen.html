<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meine Benachrichtigungen | Terminmarktplatz</title>
  <meta name="description" content="Ãœbersicht deiner bestÃ¤tigten Termin-Alarme (ohne Account, per Magic-Link)." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/" />

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: #e8ecff;
      --muted: rgba(232,236,255,0.70);
      --brand: #6f53ff;
      --brand2:#a78bfa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 26px;
      --max: 980px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(111,83,255,0.35), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,0.25), transparent 55%),
        radial-gradient(700px 420px at 40% 100%, rgba(111,83,255,0.18), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
      min-height:100vh;
    }

    a{ color: #b9adff; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 10px 4px 22px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:0.2px;
    }

    .logoImg{
      width:40px;
      height:40px;
      border-radius: 14px;
      object-fit: cover;
      display:block;
      box-shadow: 0 10px 30px rgba(111,83,255,0.30);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
    }
    .logoFallback{
      width:40px; height:40px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 10px 30px rgba(111,83,255,0.30);
      position:relative;
      overflow:hidden;
      display:none;
    }
    .logoFallback::after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.35), transparent 45%);
      transform: rotate(15deg);
    }

    .pill{
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }

    .card{
      background: linear-gradient(180deg, var(--card2), var(--card));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .inner{
      padding: 26px 22px;
    }

    h1{
      margin: 0 0 10px;
      font-size: clamp(22px, 3vw, 30px);
      letter-spacing: -0.2px;
    }

    .sub{
      color: var(--muted);
      margin: 0 0 14px;
      font-size: 14px;
    }

    .statRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }
    .stat{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      padding: 10px 12px;
      border-radius: 14px;
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 160px;
    }
    .stat b{ font-size: 16px; }
    .stat span{ color: var(--muted); font-size: 12px; display:block; }

    .okBox{
      border-radius: var(--radius);
      border: 1px solid rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.10);
      padding: 12px 14px;
      color: rgba(255,255,255,0.92);
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-top: 12px;
    }

    .warnBox{
      border-radius: var(--radius);
      border: 1px solid rgba(245,158,11,0.25);
      background: rgba(245,158,11,0.10);
      padding: 12px 14px;
      color: rgba(255,255,255,0.92);
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-top: 12px;
    }

    .errBox{
      border-radius: var(--radius);
      border: 1px solid rgba(239,68,68,0.25);
      background: rgba(239,68,68,0.10);
      padding: 12px 14px;
      color: rgba(255,255,255,0.92);
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-top: 12px;
    }

    .icon{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      flex:0 0 auto;
      margin-top:2px;
      font-size: 18px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 14px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      color: white;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 14px 35px rgba(111,83,255,0.25);
    }
    .btn:hover{ filter: brightness(1.05); }

    .btnGhost{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: rgba(232,236,255,0.92);
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
    }
    .btnGhost:hover{ background: rgba(255,255,255,0.08); }

    .btnSmall{
      padding: 9px 10px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: rgba(232,236,255,0.92);
      cursor:pointer;
    }
    .btnSmall:hover{ background: rgba(255,255,255,0.08); }

    /* NEU: Danger buttons */
    .btnDanger{
      border-color: rgba(239,68,68,0.35);
      background: rgba(239,68,68,0.12);
      color: rgba(255,255,255,0.92);
    }
    .btnDanger:hover{ background: rgba(239,68,68,0.16); }

    .btnSmall[disabled]{
      opacity: 0.55;
      cursor: not-allowed;
    }

    .list{
      margin-top: 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .item{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius: 18px;
      padding: 14px;
    }

    .itemTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.85);
      white-space:nowrap;
    }
    .badgeOk{ border-color: rgba(34,197,94,0.25); background: rgba(34,197,94,0.12); }
    .badgeOff{ border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.10); }
    .badgeWarn{ border-color: rgba(245,158,11,0.25); background: rgba(245,158,11,0.10); }

    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
      margin-top: 10px;
      font-size: 13px;
    }
    .k{ color: rgba(232,236,255,0.65); }
    .v{ color: rgba(232,236,255,0.92); }

    /* NEU: actions row inside item */
    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color: var(--muted); }

    .footer{
      margin-top: 18px;
      color: rgba(232,236,255,0.60);
      font-size: 12px;
      text-align:center;
    }

    .hidden{ display:none !important; }

    input.link{
      width: min(720px, 100%);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.20);
      color: rgba(232,236,255,0.95);
      outline: none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a href="/" class="brand" style="text-decoration:none; color:inherit;">
        <img id="logoImg" class="logoImg" src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo"
             onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';" />
        <div id="logoFallback" class="logoFallback" aria-hidden="true"></div>

        <div>
          <div style="font-size:15px; line-height:1;">Terminmarktplatz</div>
          <div style="font-size:12px; color:rgba(232,236,255,0.65); font-weight:600;">Meine Benachrichtigungen</div>
        </div>
      </a>

      <div id="pill" class="pill">ðŸ”’ Magic-Link</div>
    </div>

    <div class="card">
      <div class="inner">
        <h1>Ãœbersicht deiner Benachrichtigungen</h1>
        <p class="sub">
          Diese Seite ist <b>read-only</b>. Du brauchst keinen Account â€“ dein Zugriff lÃ¤uft Ã¼ber den Magic-Link in der URL.
        </p>

        <!-- Fehler: kein Key -->
        <div id="noKeyBox" class="errBox hidden">
          <div class="icon">âœ–</div>
          <div>
            <div style="font-weight:800; margin-bottom:6px;">Kein Magic-Link vorhanden.</div>
            <div class="muted" style="font-size:13px;">
              Ã–ffne diese Seite Ã¼ber deinen gespeicherten Link (Parameter <span class="mono">?k=...</span>).
            </div>
          </div>
        </div>

        <!-- Fehler: API -->
        <div id="apiErrorBox" class="errBox hidden">
          <div class="icon">âš </div>
          <div>
            <div style="font-weight:800; margin-bottom:6px;">Konnte deine Benachrichtigungen nicht laden.</div>
            <div id="apiErrorMsg" class="muted" style="font-size:13px;"></div>
          </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="okBox hidden" role="status" aria-live="polite">
          <div class="icon">âœ”</div>
          <div>
            <div id="toastTitle" style="font-weight:800; margin-bottom:6px;">OK</div>
            <div id="toastMsg" class="muted" style="font-size:13px;"></div>
          </div>
        </div>

        <!-- Stats -->
        <div id="statsWrap" class="hidden">
          <div class="statRow">
            <div class="stat">
              <div style="font-size:20px;">ðŸ“Œ</div>
              <div>
                <b id="used">0</b>
                <span>aktiv</span>
              </div>
            </div>
            <div class="stat">
              <div style="font-size:20px;">ðŸŽ¯</div>
              <div>
                <b id="limit">10</b>
                <span>Limit</span>
              </div>
            </div>
            <div class="stat">
              <div style="font-size:20px;">ðŸŸ£</div>
              <div>
                <b id="remaining">0</b>
                <span>noch mÃ¶glich</span>
              </div>
            </div>
          </div>

          <div id="limitHintOk" class="okBox hidden">
            <div class="icon">âœ”</div>
            <div>
              <div style="font-weight:800; margin-bottom:6px;">Alles gut.</div>
              <div class="muted" style="font-size:13px;">
                Du hast noch freie Benachrichtigungen Ã¼brig.
              </div>
            </div>
          </div>

          <div id="limitHintWarn" class="warnBox hidden">
            <div class="icon">âš </div>
            <div>
              <div style="font-weight:800; margin-bottom:6px;">Limit erreicht.</div>
              <div class="muted" style="font-size:13px;">
                Du kannst aktuell keine weiteren Benachrichtigungen hinzufÃ¼gen.
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn" type="button" onclick="goSearch()">Zur Suche</button>
            <button class="btnGhost" type="button" onclick="goCreate()">Neue Benachrichtigung anlegen</button>
          </div>

          <div class="row" style="margin-top:12px;">
            <input id="shareLink" class="link mono" readonly />
            <button class="btnSmall" type="button" onclick="copyLink()">Link kopieren</button>
          </div>

          <div class="list" id="list"></div>

          <div class="footer">
            Hinweis: Wer diesen Link besitzt, kann deine Benachrichtigungen sehen. Behandle ihn wie ein Passwort.
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // âœ… API-Basis wie im Anbieter-Portal (robust gegen 404 auf terminmarktplatz.de)
    const API_BASE = (() => {
      const h = location.hostname;
      const proto = location.protocol;

      const isLocal =
        h === 'localhost' ||
        h === '127.0.0.1' ||
        /^192\.168\./.test(h) ||
        /^10\./.test(h) ||
        h.endsWith('.local');

      if (isLocal) return `${proto}//${h}:5000`;
      if (h === 'api.terminmarktplatz.de') return `${proto}//${h}`;
      return 'https://api.terminmarktplatz.de';
    })();

    function qs(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name) || "";
    }

    const k = (qs("k") || "").trim();

    const pill = document.getElementById("pill");

    const noKeyBox = document.getElementById("noKeyBox");
    const apiErrorBox = document.getElementById("apiErrorBox");
    const apiErrorMsg = document.getElementById("apiErrorMsg");
    const statsWrap = document.getElementById("statsWrap");

    const elUsed = document.getElementById("used");
    const elLimit = document.getElementById("limit");
    const elRemaining = document.getElementById("remaining");
    const list = document.getElementById("list");
    const shareLink = document.getElementById("shareLink");

    const limitHintOk = document.getElementById("limitHintOk");
    const limitHintWarn = document.getElementById("limitHintWarn");

    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    let toastTimer = null;

    function showToast(type, title, msg){
      // type: 'ok' | 'warn' | 'err'
      toast.classList.remove("hidden");
      toastTitle.textContent = title || "Info";
      toastMsg.textContent = msg || "";

      toast.className = (type === 'err') ? "errBox" : (type === 'warn' ? "warnBox" : "okBox");
      toast.id = "toast"; // keep id

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.add("hidden"), 3200);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function goSearch(){ window.location.href = "/suche.html"; }
    function goCreate(){
      const url = k ? ("/benachrichtigung-einrichten.html?k=" + encodeURIComponent(k)) : "/benachrichtigung-einrichten.html";
      window.location.href = url;
    }

    async function copyLink(){
      try{
        await navigator.clipboard.writeText(shareLink.value);
        showToast("ok", "Link kopiert", "Du kannst den Link jetzt teilen (wie ein Passwort behandeln).");
      }catch(e){
        shareLink.select();
        document.execCommand("copy");
        showToast("ok", "Link kopiert", "Du kannst den Link jetzt teilen (wie ein Passwort behandeln).");
      }
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function badgeFor(item){
      const active = (item.active !== undefined) ? !!item.active : ((item.status || '').toString().toLowerCase() === 'active');
      const okEmail = !!item.via_email && !!(item.email_confirmed ?? item.confirmed_email ?? item.email_verified);
      const okSms = !!item.via_sms && !!(item.sms_confirmed ?? item.confirmed_sms ?? item.sms_verified);

      if(active && (okEmail || okSms)) return `<span class="badge badgeOk">âœ… aktiv</span>`;
      if(active && !(okEmail || okSms)) return `<span class="badge badgeWarn">âš  aktiv, aber nicht bestÃ¤tigt</span>`;
      return `<span class="badge badgeOff">â›” deaktiviert</span>`;
    }

    function fmtCats(s){
      if(!s) return "Alle";
      return String(s).split(",").map(x => x.trim()).filter(Boolean).join(", ") || "Alle";
    }

    function fmtChannel(item){
      const a = [];
      const okEmail = !!(item.email_confirmed ?? item.confirmed_email ?? item.email_verified);
      const okSms   = !!(item.sms_confirmed ?? item.confirmed_sms ?? item.sms_verified);

      if(item.via_email) a.push(okEmail ? "E-Mail âœ…" : "E-Mail â³");
      if(item.via_sms) a.push(okSms ? "SMS âœ…" : "SMS â³");
      return a.length ? a.join(" Â· ") : "â€”";
    }

    function isActive(item){
      return (item.active !== undefined) ? !!item.active : ((item.status || '').toString().toLowerCase() === 'active');
    }

    function renderItem(item){
      const id = String(item.id || "");
      const idShort = id ? id.slice(0, 8) : "â€”";
      const created = item.created_at ? escapeHtml(item.created_at) : "â€”";

      const r = (item.radius_km ?? item.radius ?? 0);
      const radius = (Number(r) > 0) ? `${r} km` : "0 km (nur PLZ)";
      const place = [item.zip, item.city].filter(Boolean).join(" ") || "â€”";

      const active = isActive(item);

      return `
        <div class="item" data-item-id="${escapeHtml(id)}">
          <div class="itemTop">
            <div>
              <div style="font-weight:900; font-size:14px;">Alarm <span class="mono">#${escapeHtml(idShort)}</span></div>
              <div class="muted" style="font-size:12px;">Erstellt: <span class="mono">${created}</span></div>
            </div>
            <div>${badgeFor(item)}</div>
          </div>

          <div class="kv">
            <div class="k">Ort</div><div class="v">${escapeHtml(place)}</div>
            <div class="k">Radius</div><div class="v">${escapeHtml(radius)}</div>
            <div class="k">Kategorien</div><div class="v">${escapeHtml(fmtCats(item.categories))}</div>
            <div class="k">Kanal</div><div class="v">${escapeHtml(fmtChannel(item))}</div>
            <div class="k">Paket</div><div class="v">${escapeHtml(item.package_name || "â€”")}</div>
          </div>

          <div class="actions">
            <button class="btnSmall ${active ? "btnDanger" : ""}" type="button"
              data-action="toggle"
              data-id="${escapeHtml(id)}"
              data-active="${active ? "true" : "false"}"
              ${!id ? "disabled" : ""}>
              ${active ? "â›” Deaktivieren" : "âœ… Aktivieren"}
            </button>
            <button class="btnSmall btnDanger" type="button"
              data-action="delete"
              data-id="${escapeHtml(id)}"
              ${!id ? "disabled" : ""}>
              ðŸ—‘ LÃ¶schen
            </button>
          </div>
        </div>
      `;
    }

    function normalizeResponse(js){
      const stats = js?.stats && typeof js.stats === 'object' ? js.stats : js;

      const used = (stats?.used ?? stats?.count_used ?? stats?.active ?? 0);
      const limit = (stats?.limit ?? stats?.max ?? 10);

      const remaining =
        (stats?.remaining ?? stats?.left ?? (Number(limit) - Number(used)));

      const alerts =
        Array.isArray(js?.alerts) ? js.alerts :
        Array.isArray(js?.items) ? js.items :
        Array.isArray(js?.data) ? js.data :
        [];

      return {
        used: Number.isFinite(+used) ? +used : 0,
        limit: Number.isFinite(+limit) ? +limit : 10,
        remaining: Number.isFinite(+remaining) ? +remaining : 0,
        alerts
      };
    }

    async function fetchFirstWorking(){
      const endpoints = [
        `${API_BASE}/api/alert-subscriptions/by-manage-key?k=${encodeURIComponent(k)}`,
        `${API_BASE}/api/alerts/manage?k=${encodeURIComponent(k)}`,
        `${API_BASE}/api/alerts/by-manage-key?k=${encodeURIComponent(k)}`,
        `${API_BASE}/api/alerts?manage_key=${encodeURIComponent(k)}`,
        `${API_BASE}/api/alerts?k=${encodeURIComponent(k)}`
      ];

      let lastErr = null;

      for (const url of endpoints){
        try{
          const r = await fetch(url, { method:"GET", headers:{ "Accept":"application/json" } });
          const js = await r.json().catch(() => null);

          if (!r.ok){
            lastErr = `HTTP ${r.status} (${url})`;
            continue;
          }
          if (!js){
            lastErr = `Leere Antwort (${url})`;
            continue;
          }
          if (js.ok === false){
            lastErr = `API-Fehler: ${js.error || 'unknown'} (${url})`;
            continue;
          }

          return { js, usedUrl: url };
        }catch(e){
          lastErr = `Netzwerkfehler (${url}): ${e && e.message ? e.message : String(e)}`;
        }
      }

      throw new Error(lastErr || "Unbekannter Fehler");
    }

    function removeFromDomById(id){
      const el = document.querySelector(`[data-item-id="${CSS.escape(id)}"]`);
      if (el) el.remove();
    }

    function recomputeStatsFromDom(){
      // used = count of remaining items that are active (best-effort)
      const cards = Array.from(document.querySelectorAll(".item[data-item-id]"));
      const used = cards.length; // simpler: total cards shown as "aktiv" count in your UI semantics
      const limit = Number(elLimit.textContent || "10") || 10;
      const remaining = Math.max(0, limit - used);

      elUsed.textContent = String(used);
      elRemaining.textContent = String(remaining);
      limitHintOk.classList.toggle("hidden", !(remaining > 0));
      limitHintWarn.classList.toggle("hidden", !(remaining <= 0));
    }

    async function deleteAlert(alertId, btn){
      if (!k){
        showToast("err", "Fehler", "Magic-Link fehlt (?k=...).");
        return;
      }
      if (!alertId){
        showToast("err", "Fehler", "Keine Alarm-ID gefunden.");
        return;
      }

      const ok = confirm("Diesen Alarm wirklich lÃ¶schen?");
      if (!ok) return;

      const oldText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "â€¦ lÃ¶sche";

      // Optimistic UI: remove immediately; if API fails -> reload.
      removeFromDomById(alertId);
      recomputeStatsFromDom();

      const candidates = [
        { method: "DELETE", url: `${API_BASE}/api/alert-subscriptions/${encodeURIComponent(alertId)}?k=${encodeURIComponent(k)}` },
        { method: "DELETE", url: `${API_BASE}/api/alerts/${encodeURIComponent(alertId)}?k=${encodeURIComponent(k)}` },
        { method: "POST",   url: `${API_BASE}/api/alert-subscriptions/${encodeURIComponent(alertId)}/delete?k=${encodeURIComponent(k)}` },
      ];

      let lastErr = null;

      for (const c of candidates){
        try{
          const r = await fetch(c.url, { method: c.method, headers:{ "Accept":"application/json" } });
          const js = await r.json().catch(() => ({}));

          if (r.ok && (js.ok !== false)){
            showToast("ok", "GelÃ¶scht", "Der Alarm wurde entfernt.");
            return;
          }

          lastErr = js?.error || `HTTP ${r.status}`;
        }catch(e){
          lastErr = e?.message || String(e);
        }
      }

      // If we are here: API failed. Reload to get back to consistent state.
      showToast("err", "LÃ¶schen fehlgeschlagen", lastErr || "Unbekannter Fehler");
      await load(true);
    }

    async function load(isReload = false){
      if(!k){
        noKeyBox.classList.remove("hidden");
        pill.textContent = "âŒ Kein Magic-Link";
        return;
      }

      pill.textContent = "ðŸ”’ Magic-Link Â· k=" + (k.length > 10 ? (k.slice(0,6) + "â€¦" + k.slice(-3)) : k);

      shareLink.value = window.location.origin + "/meine-benachrichtigungen.html?k=" + encodeURIComponent(k);

      try{
        if (isReload){
          apiErrorBox.classList.add("hidden");
          apiErrorMsg.textContent = "";
        }

        const { js, usedUrl } = await fetchFirstWorking();
        const norm = normalizeResponse(js);

        statsWrap.classList.remove("hidden");

        elUsed.textContent = String(norm.used);
        elLimit.textContent = String(norm.limit);
        elRemaining.textContent = String(Math.max(0, norm.remaining));

        const rem = Number(norm.remaining);
        limitHintOk.classList.toggle("hidden", !(rem > 0));
        limitHintWarn.classList.toggle("hidden", !(rem <= 0));

        const items = Array.isArray(norm.alerts) ? norm.alerts : [];

        if(items.length === 0){
          list.innerHTML = `
            <div class="warnBox">
              <div class="icon">â„¹</div>
              <div>
                <div style="font-weight:800; margin-bottom:6px;">Keine Benachrichtigungen gefunden.</div>
                <div class="muted" style="font-size:13px;">
                  Entweder ist der Link falsch oder deine Alerts wurden gelÃ¶scht/deaktiviert.
                </div>
                <div class="muted" style="font-size:12px; margin-top:8px;">
                  Endpoint: <span class="mono">${escapeHtml(usedUrl)}</span>
                </div>
              </div>
            </div>
          `;
          return;
        }

        list.innerHTML = items.map(renderItem).join("");

      }catch(e){
        apiErrorBox.classList.remove("hidden");
        apiErrorMsg.textContent = (e && e.message ? e.message : String(e));
      }
    }

    async function toggleAlert(alertId, btn, newActive){
      if (!k){
        showToast("err", "Fehler", "Magic-Link fehlt (?k=...).");
        return;
      }
      if (!alertId){
        showToast("err", "Fehler", "Keine Alarm-ID gefunden.");
        return;
      }

      const oldText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "â€¦";

      try{
        const r = await fetch(`${API_BASE}/api/alert-subscriptions/${encodeURIComponent(alertId)}/toggle?k=${encodeURIComponent(k)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify({ active: newActive })
        });

        const js = await r.json().catch(() => ({}));

        if (r.ok && (js.ok !== false)){
          showToast("ok", newActive ? "Aktiviert" : "Deaktiviert", `Der Alarm wurde ${newActive ? "aktiviert" : "deaktiviert"}.`);
          await load(true);
          return;
        }

        showToast("err", "Fehler", js?.error || `HTTP ${r.status}`);
        btn.disabled = false;
        btn.textContent = oldText;
      }catch(e){
        showToast("err", "Fehler", e?.message || String(e));
        btn.disabled = false;
        btn.textContent = oldText;
      }
    }

    // Event delegation for delete and toggle buttons
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action='delete']");
      if (btn) {
        const id = btn.getAttribute("data-id");
        deleteAlert(id, btn);
        return;
      }

      const toggleBtn = e.target.closest("[data-action='toggle']");
      if (toggleBtn) {
        const id = toggleBtn.getAttribute("data-id");
        const currentActive = toggleBtn.getAttribute("data-active") === "true";
        toggleAlert(id, toggleBtn, !currentActive);
        return;
      }
    });

    load();
  </script>
</body>
</html>
