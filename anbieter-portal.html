<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mein Portal ‚Äì Profil & Slots | Terminmarktplatz</title>
  <meta name="description" content="Anbieter-Portal: Profil pflegen, freie Zeitfenster/Slots anlegen, verwalten und ver√∂ffentlichen." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/" />

  <!-- OG/Twitter minimal -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Anbieter-Portal | Terminmarktplatz"/>
  <meta property="og:image" content="static/og-cover.png"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-YNZ8GW523R');
  </script>

  <!-- Assets -->
  <link rel="icon" href="static/favicon.png"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet" />

  <!-- Nur EIN Stylesheet-Import -->
  <link rel="stylesheet" href="static/style.css?v=20251103" />

  <!-- Portal-spezifische Overrides -->
  <style>
    .page-portal .btn,
    .page-portal .btn.primary,
    .page-portal .seg .btn,
    .page-portal .table .btn,
    .page-portal .table .btn.action,
    .page-portal .table .btn.danger {
      color:#0f172a !important; background:#ffffff !important; border:1px solid #cbd5e1 !important; text-shadow:none !important; background-image:none !important;
    }
    .page-portal .panel{border-radius:var(--r-3xl); box-shadow:var(--shadow-2)}
    .grid{display:grid; gap:16px}
    @media(min-width: 920px){ .grid-2{grid-template-columns:1fr 1fr} }

    /* Formular */
    .field{ display:flex; flex-direction:column; gap:6px; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:10px; }
    .field input,.field select,.field textarea{ background:#fff; color:#0f172a; border:1px solid rgba(15,23,42,.28); border-radius:12px; padding:10px; box-shadow: inset 0 1px 0 rgba(0,0,0,.03); }
    .field input::placeholder,.field textarea::placeholder{ color:#64748b }
    .field input:focus,.field select:focus,.field textarea:focus{ outline:none; border-color:#60a5fa; box-shadow:0 0 0 3px rgba(59,130,246,.25) }
    .req{ color:#ef4444; font-weight:700 }

    .muted{color:var(--ink-dim)}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    /* Tabelle */
    .table{width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
    .table th{background:#f8fafc; color:#0f172a}
    .table th:first-child,.table td:first-child{ text-align:center; width:34px }

    .badge-st{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .st-pending{background:#fff7ed}
    .st-pub{background:#ecfeff}
    .st-arch{background:#f1f5f9}

    .msg{display:none; padding:10px; border-radius:12px; margin-top:8px}
    .msg.ok{display:block; background:#dcfce7; color:#065f46; border:1px solid #16a34a}
    .msg.err{display:block; background:#fee2e2; color:#7f1d1d; border:1px solid #ef4444}

    .seg{margin:4px 0 0; display:flex; gap:8px; flex-wrap:wrap}
    .seg .btn { padding:8px 12px; }
    .seg .btn[data-hour], .seg .btn[data-min]{ background:#f8fafc !important; border-color:#cbd5e1 !important; color:#0f172a !important; }

    /* Suchfeld oben rechts √ºber Tabelle */
    .slot-filter{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .slot-filter input{ background:#fff; color:#0f172a; border:1px solid rgba(15,23,42,.28); border-radius:12px; padding:8px 10px; min-width:220px; }

    /* Sticky Hinweis-Banner (sofort sichtbar) */
    .alert-bar{
      position: sticky; top: 0; z-index: 1000;
      display:block; border:2px solid #f59e0b; background:#FEF3C7; /* amber-100 */
      color:#7c2d12; padding:14px 16px; border-radius:14px; margin:0 0 16px;
      box-shadow: 0 6px 14px rgba(124,45,18,.15);
    }
    .alert-bar strong{ color:#92400e }
    .alert-bar .row{ display:flex; gap:12px; align-items:center; }
    .alert-bar .icon{ font-size:22px; line-height:1; }
    .alert-bar .txt{ font-weight:700 }
    .alert-bar .sub{ font-weight:500; opacity:.9 }

    /* Guard / Callout im Slot-Panel (sichtbar bis Profil vollst.) */
    .callout { display:block; border:1px dashed #f59e0b; background:#fffbeb; color:#7c2d12; padding:12px 14px; border-radius:12px; margin-bottom:10px; }
    .callout strong { color:#92400e }
    .lock-hint { font-size: 14px; }
    fieldset[disabled] { filter: grayscale(0.1); opacity: .75; }
  </style>
</head>

<body class="page-portal">

  <!-- Header -->
  <header>
    <div class="container nav">
      <a class="brand" href="index.html">
        <div class="brand-logo"><img src="static/terminmarktplatz-logo.png" alt="Logo" width="50" height="50"></div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>
      <nav class="nav-links">
        <a href="anbieter.html">F√ºr Anbieter</a>
        <a href="suchende.html">F√ºr Suchende</a>
        <a href="preise.html">Preise</a>
      </nav>
      <div class="cta-group">
        <button id="btn-logout" class="btn">Abmelden</button>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero" style="padding:36px 0 18px">
      <div class="container">
        <span class="badge">Anbieter-Portal</span>
        <h1>Willkommen! üëã</h1>
        <p class="lead">Pflege hier dein <strong>Profil</strong> und lege <strong>freie Slots</strong> an.
          Neue Slots starten als <em>‚Äûpending_review‚Äú</em>. Nach deiner Best√§tigung werden sie ver√∂ffentlicht.</p>
      </div>
    </section>

    <!-- STICKY HINWEIS (immer sofort sichtbar, bis Profil vollst√§ndig ist) -->
    <section>
      <div class="container">
        <div id="profile-alert" class="alert-bar" role="alert" aria-live="assertive">
          <div class="row">
            <div class="icon">‚ö†Ô∏è</div>
            <div>
              <div class="txt">Profil zuerst vollst√§ndig speichern!</div>
              <div class="sub">Pflichtfelder: <em>Firma</em>, <em>Branche</em>, <em>Stra√üe & Nr.</em>, <em>PLZ</em>, <em>Ort</em>, <em>Telefon</em>. WhatsApp ist optional. Danach kannst du Slots erstellen.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTENT -->
    <section>
      <div class="container grid grid-2">

        <!-- Profil -->
        <div class="panel">
          <h2>Profil</h2>
          <p class="muted">Diese Daten sieht der/die Kund:in bei deinen Angeboten.</p>
          <form id="form-profile" class="grid">
            <div class="field">
              <label for="pf-company">Firma / Praxis / Studio <span class="req">*</span></label>
              <input id="pf-company" name="company_name" placeholder="z. B. Salon Mira" required/>
            </div>
            <div class="field">
              <label for="pf-branch">Branche <span class="req">*</span></label>
              <input id="pf-branch" name="branch" list="branch-list" placeholder="z. B. Friseur" required/>
              <datalist id="branch-list">
                <option>Friseur</option><option>Kosmetik</option><option>Physiotherapie</option>
                <option>Nagelstudio</option><option>Zahnarzt</option><option>Handwerk</option>
                <option>KFZ-Service</option><option>Fitness</option><option>Coaching</option>
                <option>Tierarzt</option><option>Beh√∂rde</option><option>Sonstiges</option>
              </datalist>
            </div>
            <div class="field">
              <label for="pf-street">Stra√üe & Nr. <span class="req">*</span></label>
              <input id="pf-street" name="street" placeholder="Musterstra√üe 1" required/>
            </div>
            <div class="field">
              <label for="pf-zip">PLZ <span class="req">*</span></label>
              <input id="pf-zip" name="zip" placeholder="12345" pattern="\d{5}" inputmode="numeric" required/>
            </div>
            <div class="field">
              <label for="pf-city">Ort <span class="req">*</span></label>
              <input id="pf-city" name="city" placeholder="Musterstadt" required/>
            </div>
            <div class="field">
              <label for="pf-phone">Telefon <span class="req">*</span></label>
              <input id="pf-phone" name="phone" placeholder="+49 ‚Ä¶" pattern="^\+?[0-9\s\-\/]{6,}$" required/>
            </div>
            <div class="field">
              <label for="pf-whatsapp">WhatsApp (optional)</label>
              <input id="pf-whatsapp" name="whatsapp" placeholder="+49 ‚Ä¶" pattern="^\+?[0-9\s\-\/]{6,}$"/>
            </div>
            <div class="toolbar">
              <button class="btn primary" type="submit">Profil speichern</button>
              <span class="muted">Pflicht: Firma, Branche, Stra√üe & Nr., PLZ, Ort, Telefon.</span>
            </div>
            <div id="msg-profile" class="msg"></div>
          </form>
        </div>

        <!-- Slot anlegen -->
        <div class="panel">
          <h2>Neuen Slot anlegen</h2>

          <!-- Guard-Hinweis, solange Profil unvollst√§ndig -->
          <div id="slot-guard" class="callout">
            <strong>Profil unvollst√§ndig.</strong>
            <div class="lock-hint">Bitte f√ºlle zuerst alle Pflichtfelder im Profil aus (WhatsApp ist optional). Danach kannst du Slots anlegen.</div>
          </div>

          <!-- Alles im fieldset, das wir sperren -->
          <form id="form-slot" class="grid" novalidate>
            <fieldset id="slot-fields" disabled>
              <div class="field">
                <label for="sl-title">Titel <span class="req">*</span></label>
                <input id="sl-title" name="title" placeholder="z. B. Damenhaarschnitt" required/>
              </div>

              <!-- Kategorie -->
              <div class="field">
                <label for="sl-cat">Kategorie <span class="req">*</span></label>
                <select id="sl-cat" name="category" required>
                  <option value="" disabled selected>Bitte w√§hlen ‚Ä¶</option>
                </select>
              </div>

              <div class="field">
                <label for="sl-date">Datum <span class="req">*</span></label>
                <input id="sl-date" type="date" required/>
              </div>
              <div class="field">
                <label for="sl-start">Start (Uhrzeit) <span class="req">*</span></label>
                <input id="sl-start" type="time" step="60" required/>
              </div>

              <!-- Dauer: Minuten oder Stunden -->
              <div class="field">
                <label for="sl-duration">Dauer <span class="req">*</span></label>
                <div style="display:flex; gap:8px; align-items:center">
                  <input id="sl-duration" type="number" min="1" step="1" value="30" required style="flex:1"/>
                  <select id="sl-unit" aria-label="Einheit">
                    <option value="min">Minuten</option>
                    <option value="h">Stunden</option>
                  </select>
                </div>
                <div class="seg">
                  <button type="button" class="btn" data-min="15">15&nbsp;min</button>
                  <button type="button" class="btn" data-min="30">30&nbsp;min</button>
                  <button type="button" class="btn" data-min="45">45&nbsp;min</button>
                  <button type="button" class="btn" data-min="60">60&nbsp;min</button>
                  <button type="button" class="btn" data-min="90">90&nbsp;min</button>
                  <button type="button" class="btn" data-hour="1">1&nbsp;h</button>
                  <button type="button" class="btn" data-hour="2">2&nbsp;h</button>
                </div>
              </div>

              <div class="field">
                <label for="sl-end">Ende (berechnet)</label>
                <input id="sl-end" type="time" readonly/>
              </div>

              <!-- ORT / PLZ ‚Äì PFLICHT -->
              <div class="field">
                <label for="sl-location">Ort / PLZ <span class="req">*</span></label>
                <input id="sl-location" name="location"
                       placeholder="z. B. 96191 Viereth / Filiale Zentrum"
                       required pattern="(\d{5}|.{3,})"
                       title="5-stellige PLZ oder ein Ortsname (mind. 3 Zeichen)" />
              </div>

              <div class="field">
                <label for="sl-cap">Kapazit√§t</label>
                <input id="sl-cap" type="number" min="1" step="1" value="1"/>
              </div>
              <div class="field">
                <label for="sl-price">Preis (Euro, optional)</label>
                <input id="sl-price" type="number" min="0" step="1" placeholder="z. B. 49"/>
              </div>
              <div class="field" style="grid-column:1/-1">
                <label for="sl-notes">Notizen (intern)</label>
                <textarea id="sl-notes" rows="2" placeholder="optional"></textarea>
              </div>

              <div class="toolbar">
                <button class="btn primary" type="submit">Slot anlegen</button>
                <span class="muted">Status: <span class="badge-st st-pending">pending_review</span></span>
              </div>
            </fieldset>
            <div id="msg-slot" class="msg"></div>
          </form>
        </div>

        <!-- Meine Slots -->
        <div class="panel" style="grid-column:1/-1">
          <div class="toolbar" style="justify-content:space-between">
            <h2 style="margin:0">Meine Slots</h2>
            <div class="slot-filter">
              <input id="slot-search" type="text" placeholder="Suche Titel oder Kategorie ‚Ä¶">
              <div class="seg">
                <label class="check">
                  <input type="checkbox" id="chk-all"> Alle ausw√§hlen
                </label>
                <button class="btn action" id="btn-publish" disabled>Ver√∂ffentlichen</button>
                <button class="btn" id="btn-archive" disabled>Archivieren</button>
                <button class="btn danger" id="btn-delete" disabled>L√∂schen</button>
                <button class="btn" id="btn-refresh">Aktualisieren</button>
              </div>
            </div>
          </div>

          <div class="muted" style="margin:6px 0 12px">
            Hinweis: Neue Slots werden zun√§chst als <em>‚Äûpending_review‚Äú</em> angelegt. Nach deiner Best√§tigung werden sie ver√∂ffentlicht.
          </div>

          <div class="table-wrap">
            <table class="table" id="tbl-slots">
              <thead>
                <tr>
                  <th>‚úì</th>
                  <th>Start</th>
                  <th>Ende</th>
                  <th>Titel</th>
                  <th>Kategorie</th>
                  <th class="nowrap">Ort</th>
                  <th>Kap.</th>
                  <th>Status</th>
                  <th class="nowrap">Aktionen</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="9" class="muted">Lade ‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
          <div id="msg-slots" class="msg"></div>
        </div>

      </div>
    </section>
  </main>

  <script>
    // ---------- API-Basis (robust f√ºr Lokalnetz/Prod) ----------
    const API = (() => {
      const h = location.hostname;
      const proto = location.protocol;

      const isLocal =
        h === 'localhost' ||
        h === '127.0.0.1' ||
        /^192\.168\./.test(h) ||
        /^10\./.test(h) ||
        h.endsWith('.local');

      if (isLocal) {
        return `${proto}//${h}:5000`;
      }
      if (h === 'api.terminmarktplatz.de') {
        return `${proto}//${h}`;
      }
      return 'https://api.terminmarktplatz.de';
    })();

    const $  = (q, root=document)=>root.querySelector(q);
    const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));

    function showMsg(id, text, ok=false){
      const el = document.getElementById(id);
      el.className = 'msg ' + (ok ? 'ok' : 'err');
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, ok ? 1800 : 4200);
    }

    function pad(n){ return n.toString().padStart(2,'0'); }
    function toLocalISO(dateLocal){ return new Date(dateLocal).toISOString(); }
    function joinDateTime(dateStr, timeStr){
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      return new Date(y, (m-1), d, hh, mm, 0, 0);
    }
    function fmtLocal(dtStr){
      const d = new Date(dtStr);
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ---------- Kategorien (Dropdown) ----------
    const CATEGORIES = [
      "Friseur","Kosmetik","Physiotherapie","Nagelstudio","Zahnarzt",
      "Handwerk","KFZ-Service","Fitness","Coaching","Tierarzt","Beh√∂rde","Sonstiges"
    ];
    function fillCategoryOptions(){
      const sel = $('#sl-cat');
      if(!sel) return;
      sel.innerHTML = `<option value="" disabled selected>Bitte w√§hlen ‚Ä¶</option>`
        + CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    // ---------- Profil-Completeness & Slot-Lock ----------
    function isValidZip(v){ return /^\d{5}$/.test((v||'').trim()); }
    function isValidPhone(v){ return /^\+?[0-9\s\-\/]{6,}$/.test((v||'').trim()); }

    function isProfileCompleteFromValues(vals){
      return !!(
        vals.company_name &&
        vals.branch &&
        vals.street &&
        isValidZip(vals.zip) &&
        vals.city &&
        isValidPhone(vals.phone)
      );
    }

    function getProfileValuesFromForm(){
      return {
        company_name: $('#pf-company').value.trim(),
        branch:       $('#pf-branch').value.trim(),
        street:       $('#pf-street').value.trim(),
        zip:          $('#pf-zip').value.trim(),
        city:         $('#pf-city').value.trim(),
        phone:        $('#pf-phone').value.trim(),
        whatsapp:     $('#pf-whatsapp').value.trim(),
      };
    }

    function setSlotLock(locked){
      const fs = $('#slot-fields');
      const guard = $('#slot-guard');
      const banner = $('#profile-alert');
      if (fs) fs.disabled = !!locked;
      if (guard) guard.style.display = locked ? 'block' : 'none';
      if (banner) banner.style.display = locked ? 'block' : 'none';
    }

    // ---------- Auth-Gate / Me ----------
    let ME = null;
    async function requireAuth(){
      try{
        const r = await fetch(`${API}/me`, { credentials:'include' });
        if (!r.ok) {
          if (r.status === 401 || r.status === 403) {
            window.location.href = 'login.html?tab=login';
            return;
          }
          showMsg('msg-profile', 'Anmeldung erforderlich oder API nicht erreichbar.', false);
          return;
        }
        ME = await r.json();

        // Felder bef√ºllen
        $('#pf-company').value  = ME.company_name || '';
        $('#pf-branch').value   = ME.branch || '';
        $('#pf-street').value   = ME.street || '';
        $('#pf-zip').value      = ME.zip || '';
        $('#pf-city').value     = ME.city || '';
        $('#pf-phone').value    = ME.phone || '';
        $('#pf-whatsapp').value = ME.whatsapp || '';

        // Lock gem√§√ü Profilstatus der serverseitigen Daten
        const complete = isProfileCompleteFromValues(getProfileValuesFromForm());
        setSlotLock(!complete);
      }catch(err){
        showMsg('msg-profile', 'Netzwerkfehler ‚Äì API aktuell nicht erreichbar.', false);
      }
    }

    // ---------- Profil speichern (hier wird entsperrt) ----------
    $('#form-profile').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = getProfileValuesFromForm();
      try{
        const r = await fetch(`${API}/me`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=> ({}));
        if(r.ok){
          showMsg('msg-profile','Gespeichert ‚úì', true);
          const complete = isProfileCompleteFromValues(payload);
          setSlotLock(!complete); // Freigabe ausschlie√ülich nach Save
          if(!complete){
            showMsg('msg-profile','Bitte alle Pflichtfelder ausf√ºllen (WhatsApp ist optional).');
          }
        }else{
          const map = {
            unauthorized: 'Bitte erneut anmelden.',
            invalid_zip: 'PLZ muss 5-stellig sein.',
            db_constraint_error: 'Ung√ºltige/fehlende Felder (DB-Vorgaben).',
            db_error: 'Datenbankfehler.'
          };
          showMsg('msg-profile', map[data.error] || 'Konnte Profil nicht speichern.');
          if(r.status === 401) location.href = 'login.html?tab=login';
        }
      }catch(e){
        showMsg('msg-profile','Netzwerkfehler.');
      }
    });

    // ---------- Slot-Form: Dauer -> Ende berechnen ----------
    function totalMinutes(){
      const val = parseInt($('#sl-duration').value || '0', 10);
      const unit = $('#sl-unit').value;
      if (!val) return 0;
      return unit === 'h' ? val * 60 : val;
    }
    function recalcEnd(){
      const d = $('#sl-date').value;
      const t = $('#sl-start').value;
      const min = totalMinutes();
      if(!d || !t || !min){ $('#sl-end').value=''; return; }
      const start = joinDateTime(d,t);
      const end   = new Date(start.getTime() + min*60000);
      $('#sl-end').value = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
    }

    // Events (genau einmal)
    $('#sl-date').addEventListener('change',  recalcEnd);
    $('#sl-start').addEventListener('input',  recalcEnd);
    $('#sl-duration').addEventListener('input', recalcEnd);
    $('#sl-unit').addEventListener('change',  recalcEnd);

    // Schnellwahl-Buttons ‚Äì Minuten
    $$('#form-slot .seg [data-min]').forEach(b => b.addEventListener('click', ()=>{
      $('#sl-unit').value = 'min';
      $('#sl-duration').value = b.dataset.min;
      recalcEnd();
    }));
    // Schnellwahl-Buttons ‚Äì Stunden
    $$('#form-slot .seg [data-hour]').forEach(b => b.addEventListener('click', ()=>{
      $('#sl-unit').value = 'h';
      $('#sl-duration').value = b.dataset.hour;
      recalcEnd();
    }));

    // ---------- Slots laden & rendern + Freigabe-Workflow ----------
    let SELECTED = new Set();
    let LAST_ITEMS = [];

    function updateBulkButtons(items){
      const byId = Object.fromEntries(items.map(x => [x.id, x]));
      const ids = [...SELECTED];
      const any = ids.length > 0;
      const anyPending = ids.some(id => (byId[id]?.status === 'pending_review' || byId[id]?.status === 'archived'));
      const anyPub     = ids.some(id => byId[id]?.status === 'published');
      $('#btn-publish').disabled = !(any && anyPending);
      $('#btn-archive').disabled = !(any && anyPub);
      $('#btn-delete').disabled  = !any;
    }

    function renderTable(items){
      const tbody = $('#tbl-slots tbody');
      if(!items.length){ tbody.innerHTML = `<tr><td colspan="9" class="muted">Noch keine Slots angelegt.</td></tr>`; return; }
      tbody.innerHTML = '';
      for(const s of items){
        const tr = document.createElement('tr');
        const theStatus = s.status;
        const isPending   = theStatus === 'pending_review';
        const isPublished = theStatus === 'published';
        const isArchived  = theStatus === 'archived';
        const stClass = isPublished ? 'st-pub' : (isArchived ? 'st-arch' : 'st-pending');

        tr.innerHTML = `
          <td><input type="checkbox" class="row-check" data-id="${s.id}"></td>
          <td>${fmtLocal(s.start_at)}</td>
          <td>${fmtLocal(s.end_at)}</td>
          <td>${s.title}</td>
          <td>${s.category||''}</td>
          <td>${s.location||''}</td>
          <td>${s.capacity||1}</td>
          <td><span class="badge-st ${stClass}">${s.status}</span></td>
          <td class="nowrap">
            ${isPending || isArchived ? `<button class="btn action" data-arch="${s.id}" data-status="published">Ver√∂ffentlichen</button>` : ''}
            ${isPublished ? `<button class="btn" data-arch="${s.id}" data-status="archived">Archivieren</button>` : ''}
            <button class="btn danger" data-del="${s.id}">L√∂schen</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Zeilen-Checkboxen
      $$('#tbl-slots .row-check').forEach(cb => {
        cb.addEventListener('change', ()=>{
          const id = cb.dataset.id;
          if(cb.checked) SELECTED.add(id); else SELECTED.delete(id);
          updateBulkButtons(items);
        });
      });

      // Einzelaktionen
      $$('#tbl-slots [data-del]').forEach(b =>
        b.addEventListener('click', async ()=>{ await delSlot(b.dataset.del); await loadSlots(); })
      );
      $$('#tbl-slots [data-arch]').forEach(b =>
        b.addEventListener('click', async ()=>{ await setStatus(b.dataset.arch, b.dataset.status); await loadSlots(); })
      );

      // Master-Checkbox
      $('#chk-all').onchange = (e) => {
        SELECTED.clear();
        $$('#tbl-slots .row-check').forEach(cb => {
          cb.checked = e.target.checked;
          if(cb.checked) SELECTED.add(cb.dataset.id);
        });
        updateBulkButtons(items);
      };

      updateBulkButtons(items);
    }

    async function loadSlots(){
      const tbody = $('#tbl-slots tbody');
      tbody.innerHTML = `<tr><td colspan="9" class="muted">Lade ‚Ä¶</td></tr>`;
      SELECTED.clear(); const master = $('#chk-all'); if (master) master.checked = false;

      try{
        const r = await fetch(`${API}/slots`, {credentials:'include'});
        if(!r.ok){ tbody.innerHTML = `<tr><td colspan="9" class="muted">Bitte (erneut) anmelden.</td></tr>`; return; }
        LAST_ITEMS = await r.json();
        renderTable(LAST_ITEMS);
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Fehler beim Laden.</td></tr>`;
      }
    }

    // Live-Suche Titel/Kategorie
    const slotSearch = $('#slot-search');
    if (slotSearch) {
      slotSearch.addEventListener('input', ()=>{
        const q = slotSearch.value.trim().toLowerCase();
        if(!q) return renderTable(LAST_ITEMS);
        const filtered = LAST_ITEMS.filter(s =>
          (s.title||'').toLowerCase().includes(q) || (s.category||'').toLowerCase().includes(q)
        );
        renderTable(filtered);
      });
    }

    async function delSlot(id){
      if(!confirm('Diesen Slot wirklich l√∂schen?')) return;
      try{
        const r = await fetch(`${API}/slots/${id}`, {method:'DELETE', credentials:'include'});
        if(!r.ok) showMsg('msg-slots','Konnte Slot nicht l√∂schen.');
      }catch(e){ showMsg('msg-slots','Netzwerkfehler.'); }
    }
    async function setStatus(id, status){
      try{
        const r = await fetch(`${API}/slots/${id}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({status})
        });
        if(!r.ok) showMsg('msg-slots','Konnte Status nicht √§ndern.');
      }catch(e){ showMsg('msg-slots','Netzwerkfehler.'); }
    }

    // Bulk-Aktionen
    async function bulkSetStatus(ids, status){
      if(!ids.length) return;
      await Promise.all(ids.map(id =>
        fetch(`${API}/slots/${id}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({status})
        })
      ));
    }
    async function bulkDelete(ids){
      if(!ids.length) return;
      await Promise.all(ids.map(id =>
        fetch(`${API}/slots/${id}`, {method:'DELETE', credentials:'include'})
      ));
    }
    $('#btn-publish')?.addEventListener('click', async ()=>{
      const ids = [...SELECTED];
      await bulkSetStatus(ids, 'published'); await loadSlots();
    });
    $('#btn-archive')?.addEventListener('click', async ()=>{
      const ids = [...SELECTED];
      await bulkSetStatus(ids, 'archived'); await loadSlots();
    });
    $('#btn-delete')?.addEventListener('click', async ()=>{
      const ids = [...SELECTED];
      if(!ids.length) return;
      if(!confirm(`Diese ${ids.length} Slot(s) wirklich l√∂schen?`)) return;
      await bulkDelete(ids); await loadSlots();
    });
    $('#btn-refresh')?.addEventListener('click', loadSlots);

    // ---------- Slot anlegen ----------
    $('#form-slot').addEventListener('submit', async (e)=>{
      e.preventDefault();

      // Serverseitigen Gate simulieren: Nur nach gespeichertem, vollst√§ndigem Profil
      const completeNow = isProfileCompleteFromValues(getProfileValuesFromForm());
      if(!completeNow){
        setSlotLock(true);
        return showMsg('msg-slot','Bitte Profil zuerst vollst√§ndig speichern (WhatsApp ist optional).');
      }

      // ORT / PLZ PFLICHT (zus√§tzlich zur HTML-Validierung)
      const loc = ($('#sl-location').value || '').trim();
      if(!loc){
        $('#sl-location').focus();
        return showMsg('msg-slot','‚ÄûOrt / PLZ‚Äú ist ein Pflichtfeld.');
      }

      const date = $('#sl-date').value, time = $('#sl-start').value, durMin = totalMinutes();
      if(!date || !time || !durMin){ return showMsg('msg-slot','Bitte Datum, Start und Dauer angeben.'); }

      const startLocal = joinDateTime(date,time);
      const endLocal   = new Date(startLocal.getTime() + durMin*60000);

      const payload = {
        title: ($('#sl-title').value||'').trim() || 'Slot',
        category: ($('#sl-cat').value||'').trim() || 'Sonstiges',
        start_at: toLocalISO(startLocal),
        end_at: toLocalISO(endLocal),
        location: loc,
        capacity: parseInt($('#sl-cap').value || '1',10),
        contact_method: 'mail',
        booking_link: null,
        price_cents: $('#sl-price').value ? Math.round(parseFloat($('#sl-price').value)*100) : null,
        notes: ($('#sl-notes').value||'').trim() || null
      };

      try{
        const r = await fetch(`${API}/slots`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=> ({}));
        if(r.ok){
          showMsg('msg-slot','Slot angelegt (wartet auf Pr√ºfung) ‚úì', true);
          e.target.reset(); $('#sl-unit').value='min'; recalcEnd(); fillCategoryOptions(); await loadSlots();
        }else{
          const m = {
            missing_fields:'Pflichtfelder fehlen.',
            missing_location:'‚ÄûOrt / PLZ‚Äú ist ein Pflichtfeld.',
            bad_datetime:'Datum/Uhrzeit ung√ºltig.',
            end_before_start:'Ende liegt vor dem Start.',
            limit_reached:'Limit erreicht.',
            start_in_past:'Start darf nicht in der Vergangenheit liegen.',
            bad_capacity:'Kapazit√§t ung√ºltig.',
            db_constraint_error:'Kategorie entspricht nicht den DB-Vorgaben.',
            db_error:'Datenbankfehler.',
            profile_incomplete:'Profil unvollst√§ndig. Bitte erst Profil speichern.'
          };
          showMsg('msg-slot', m[data.error] || `Konnte Slot nicht anlegen.${data.detail ? ' ('+data.detail+')' : ''}`);
        }
      }catch(err){ showMsg('msg-slot','Netzwerkfehler.'); }
    });

    // ---------- Logout ----------
    $('#btn-logout').addEventListener('click', async ()=>{
      try{ await fetch(`${API}/auth/logout`, {method:'POST', credentials:'include'}); }catch(_){}
      location.href = 'login.html?tab=login';
    });

    // ---------- Init ----------
    (async function init(){
      // WICHTIG: Vorab sperren & Banner zeigen, noch bevor /me geladen ist:
      setSlotLock(true); // zeigt auch #profile-alert an

      await requireAuth();
      fillCategoryOptions();
      recalcEnd();
      await loadSlots();
    })();
  </script>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein">
          </div>
        <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte L√∂sungen f√ºr deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">F√ºr Anbieter</a>
        <a class="foot-link" href="suchende.html">F√ºr Suchende</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">¬© <span id="y"></span> Terminmarktplatz ¬∑ Alle Rechte vorbehalten.</div>
    <script>document.getElementById('y').textContent=new Date().getFullYear();</script>
  </footer>
</body>
</html>
