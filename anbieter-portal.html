<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mein Portal ‚Äì Profil & Slots | Terminmarktplatz</title>
  <meta name="description" content="Anbieter-Portal: Profil pflegen, freie Zeitfenster/Slots anlegen, verwalten und ver√∂ffentlichen." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/" />

  <!-- OG/Twitter minimal -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Anbieter-Portal | Terminmarktplatz"/>
  <meta property="og:image" content="static/og-cover.png"/>
  <meta name="twitter:card" content="summary_large_image"/>


  <!-- Assets -->
  <link rel="icon" href="static/favicon.png"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet" />

  <!-- Nur EIN Stylesheet-Import -->
  <link rel="stylesheet" href="static/style.css?v=20251103" />

  <!-- Portal-spezifische Button-Overrides + Mobile-Optimierung -->
  <style>
    html, body { width: 100%; margin: 0; padding: 0; }

    .page-portal .container { max-width: 1120px; box-sizing: border-box; }

    .page-portal form,
    .page-portal .panel,
    .page-portal .field { width: 100%; box-sizing: border-box; }

    .page-portal .field input,
    .page-portal .field select,
    .page-portal .field textarea { width: 100%; box-sizing: border-box; }

    .page-portal .btn,
    .page-portal .btn.primary,
    .page-portal .seg .btn,
    .page-portal .table .btn,
    .page-portal .table .btn.action,
    .page-portal .table .btn.danger {
      color:#0f172a !important;
      background:#ffffff !important;
      border:1px solid #cbd5e1 !important;
      text-shadow:none !important;
      background-image:none !important;
    }

    .page-portal .panel{ border-radius:var(--r-3xl); box-shadow:var(--shadow-2); }
    .grid{display:grid; gap:16px}
    @media(min-width: 920px){ .grid-2{grid-template-columns:1fr 1fr} }

    .field{
      display:flex; flex-direction:column; gap:6px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
    }
    .field input,.field select,.field textarea{
      background:#fff; color:#0f172a; border:1px solid rgba(15,23,42,.28);
      border-radius:12px; padding:10px;
      box-shadow: inset 0 1px 0 rgba(0,0,0,.03);
    }
    .field input::placeholder,.field textarea::placeholder{ color:#64748b }
    .field input:focus,.field select:focus,.field textarea:focus{
      outline:none; border-color:#60a5fa; box-shadow:0 0 0 3px rgba(59,130,246,.25)
    }
    .req{ color:#ef4444; font-weight:700 }
    .req-text{ color:#ef4444; font-weight:600; font-size:12px; margin-left:6px; }

    .muted{color:var(--ink-dim)}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .duration-row{ display:flex; gap:8px; align-items:center; }
    .duration-row input{ flex:1 1 auto; width:100%; }
    .duration-row select{ flex:0 0 90px; max-width:90px; }

    .table{width:100%; border-collapse:collapse; border:1px solid var(--border);
           border-radius:14px; overflow:hidden}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
    .table th{background:#f8fafc; color:#0f172a}
    .table th:first-child,.table td:first-child{ text-align:center; width:34px }

    .badge-st{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .st-pending{background:#fff7ed}
    .st-pub{background:#ecfeff}
    .st-arch{background:#f1f5f9}
    .st-canceled{background:#fee2e2}

    .table tr.slot-past td{ color:#94a3b8; }
    .table tr.slot-pending td{ background:#fef9c3; }
    .table tr.slot-free td{ background:#e0f2fe; }
    .table tr.slot-booked td{ background:#dcfce7; }
    .table tr.slot-booked.slot-past td{ background:#bbf7d0; }

    .slot-hint{
      display:block;
      font-size:12px;
      margin-top:2px;
      color:#0f172a;
    }
    .slot-past .slot-hint{
      color:#64748b;
      font-style:italic;
    }
    .slot-booked .slot-hint{
      color:#15803d;
      font-weight:500;
    }

    .table tr.slot-canceled td{ background:#fee2e2; }
    .slot-hint-canceled{ color:#b91c1c; font-weight:600; }

    .msg{display:none; padding:10px; border-radius:12px; margin-top:8px}
    .msg.ok{display:block; background:#dcfce7; color:#065f46; border:1px solid #16a34a}
    .msg.err{display:block; background:#fee2e2; color:#7f1d1d; border:1px solid #ef4444}

    .seg{margin:4px 0 0; display:flex; gap:8px; flex-wrap:wrap}
    .seg .btn { padding:8px 12px; }
    .seg .btn[data-hour], .seg .btn[data-min]{
      background:#f8fafc !important;
      border-color:#cbd5e1 !important;
      color:#0f172a !important;
    }

    .slot-filter{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .slot-filter input{
      background:#fff; color:#0f172a; border:1px solid rgba(15,23,42,.28);
      border-radius:12px; padding:8px 10px; min-width:220px;
    }

    .callout {
      display:none;
      border:1px dashed #f59e0b;
      background:#fffbeb;
      color:#7c2d12;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:10px;
    }
    .callout strong { color:#92400e }
    .lock-hint { font-size: 14px; }
    fieldset[disabled] { filter: grayscale(0.1); opacity: .75; }

    .alert{
      display:none;
      border:1px solid #f59e0b;
      background:linear-gradient(0deg,#fff7ed,#fff7ed);
      color:#7c2d12;
      padding:14px 16px;
      border-radius:14px;
      margin:0 0 16px 0;
    }
    .alert strong{ color:#92400e }
    .alert .small{ font-size:13px; opacity:.9 }

    @media (min-width: 769px) {
      .container.nav { display:flex; align-items:center; justify-content:flex-start; gap:16px; }
    }

    @media (max-width: 768px) {
      .page-portal { font-size: 0.9rem; }

      header .container.nav,
      .page-portal main .container {
        max-width: 720px;
        margin: 0 auto;
        padding-inline: 12px;
      }

      .container.nav { flex-wrap: wrap; gap: 6px; align-items: flex-start; }

      .brand-title { font-size: 1.0rem; }

      .nav-links {
        display: flex !important;
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
        gap: 6px;
        text-align: center;
        margin-top: 2px;
      }

      .nav-links a { font-size: 0.85rem; padding: 2px 4px; }

      .user-menu { display: block; }

      .hero { padding: 20px 0 8px !important; }

      .hero h1 { font-size: 1.35rem; line-height: 1.2; margin-bottom: 4px; }

      .hero .lead { font-size: 0.9rem; }

      .grid-2 { grid-template-columns: 1fr !important; }
      .grid { gap: 10px; }

      .panel {
        margin-bottom: 10px;
        padding: 12px 10px;
        border-radius: 18px;
        max-width: 100%;
        overflow: visible;
      }

      .panel h2 { font-size: 1.05rem; margin-bottom: 4px; text-align: left; }

      #form-profile, #form-slot { gap: 8px; }

      .field { padding: 6px; gap: 3px; }

      .field label { font-size: 0.85rem; }

      .field input, .field select, .field textarea { padding: 6px 8px; font-size: 0.85rem; }

      .req-text { font-size: 10px; }

      .toolbar { flex-direction: column; align-items: flex-start; gap: 6px; }

      .toolbar .btn { width: auto; justify-content: flex-start; }

      .toolbar .muted { font-size: 0.8rem; text-align: left; }

      #form-slot .seg { gap: 4px; }

      #form-slot .seg .btn { font-size: 0.75rem; padding: 4px 6px; }

      .slot-filter { flex-direction: column; align-items: stretch; gap: 4px; }

      .slot-filter input { width: 100%; min-width: 0; }

      .slot-filter .seg { width: 100%; justify-content: flex-start; flex-wrap: wrap; gap: 4px; }

      .slot-filter .seg .btn { font-size: 0.75rem; padding: 4px 6px; }

      .table-wrap { width: 100%; overflow-x: hidden; }

      .table { width: 100%; border-collapse: separate; border-spacing: 0; }

      .table thead { display: none; }

      .table tbody tr {
        display: grid;
        grid-template-columns: minmax(0,1fr) auto;
        align-items: flex-start;
        gap: 4px;
        padding: 6px 4px;
        border-bottom: 1px solid var(--border);
        background: #ffffff;
        border-radius: 10px;
        margin-bottom: 8px;
      }

      .table tbody tr td {
        border: 0;
        padding: 2px 4px;
        font-size: 0.8rem;
        white-space: normal;
      }

      .table tbody tr td[data-label]::before { content: none; }

      .table tbody tr td:nth-child(-n+8) { grid-column: 1 / 2; text-align: left; }

      .table tbody tr td:nth-child(9) { grid-column: 2 / 3; text-align: right; }

      .table tbody tr td:nth-child(9) .btn {
        display: block;
        width: 100%;
        margin: 2px 0;
        text-align: center;
      }

      .table tbody tr td:first-child { display: flex; align-items: center; gap: 4px; }

      .slot-hint { font-size: 0.78rem; }

      .foot-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }

      .foot-col { margin-top: 4px; }

      .duration-row select{ flex:0 0 80px; max-width:80px; }
    }

    .user-menu .btn {
      background:#ffffff;
      color:#0f172a;
      border:1px solid #cbd5e1;
      text-shadow:none;
      background-image:none;
    }

    .booking-cancel {
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:6px;
    }
    .booking-cancel select.booking-select {
      max-width: 220px;
      font-size: 0.8rem;
    }

    header .nav{ display:flex; align-items:center; gap:16px; }
    header .brand{ display:flex; align-items:center; gap:12px; }
    header .user-menu{ display:block; position:relative; z-index:60; margin-left:12px; }

    @media (min-width:769px){
      header .nav{ justify-content:flex-start; }
      header .nav-links{ display:flex; align-items:center; gap:16px; margin-left:auto; }
    }

    @media (max-width:768px){
      header .nav{ flex-wrap:wrap; align-items:flex-start; gap:8px; }
      header .brand{ margin-right:0; }
      header .user-menu{ margin-left:auto; }
      header .nav-links{
        width:100%;
        justify-content:center;
        flex-wrap:wrap;
        gap:8px;
        text-align:center;
        margin-top:4px;
      }
      header .nav-links a{ font-size:0.9rem; padding:6px 8px; }
    }

    .plan-info {
      margin: 8px 0 18px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.9rem;
    }
    .plan-label { font-weight: 600; color: #111827; }
    .plan-name { font-weight: 600; color: #4f46e5; }
    .plan-valid { color: #6b7280; }
    .plan-change-link { margin-left: 6px; font-weight: 500; color: #4f46e5; text-decoration: underline; }

    .plan-info .btn-cancel-plan {
      margin-left: auto;
      font-size: 0.85rem;
      padding: 6px 10px;
      white-space: nowrap;
    }

    @media (max-width: 768px){
      .plan-info { width: 100%; justify-content: flex-start; }
      .plan-info .btn-cancel-plan { margin-left: 0; width: 100%; justify-content: center; }
    }
  </style>
</head>

<body class="page-portal">
  <!-- Header -->
  <header>
    <div class="container nav"
         role="navigation"
         aria-label="Hauptnavigation">
      <a class="brand" href="index.html" aria-label="Startseite">
        <div class="brand-logo" aria-hidden="true">
          <img src="/static/terminmarktplatz-logo.png"
               alt="Terminmarktplatz Logo"
               width="50" height="50">
        </div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>

      <div class="user-menu">
        <button id="userMenuBtn" class="btn" aria-haspopup="menu" aria-expanded="false">
          ‚ò∞ Men√º
        </button>
        <div id="userMenu" class="menu" role="menu" hidden>
          <a href="login.html?tab=login" class="item auth-out" role="menuitem">Anmelden</a>

          <button type="button" class="item auth-in" data-action="logout" role="menuitem">Abmelden</button>
          <a href="anbieter-portal.html" class="item auth-in" role="menuitem">Profil</a>
          <a href="anbieter-portal.html#step-3" class="item auth-in" role="menuitem">Slot anlegen</a>
          <a href="https://api.terminmarktplatz.de/admin-rechnungen.html" class="item auth-in admin-only" role="menuitem" id="admin-invoices-link" style="display:none;">Rechnungen (Admin)</a>
          <button class="item danger auth-in" data-action="delete" role="menuitem">Konto l√∂schen</button>

          <a href="kontakt.html" class="item" role="menuitem">Kontakt</a>
        </div>
      </div>

      <nav class="nav-links">
        <a href="anbieter.html">F√ºr Anbieter</a>
        <a href="suchende.html">F√ºr Suchende</a>
        <a href="preise.html">Preise</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero" style="padding:36px 0 18px">
      <div class="container">
        <span class="badge">Anbieter-Portal</span>
        <h1>Willkommen! üëã</h1>
        <p class="lead">Pflege hier dein <strong>Profil</strong> und lege <strong>freie Slots</strong> an.
          Neue Slots starten als <em>Entwurf</em> und werden erst nach dem Ver√∂ffentlichen sichtbar.</p>

        <!-- Gebuchtes Paket-Hinweis -->
        <div class="plan-info">
          <span class="plan-label">Aktuelles Paket:</span>
          <span id="plan-name" class="plan-name">Basis (Standard)</span>
          <span id="plan-valid-until" class="plan-valid">¬∑ kein Ablaufdatum hinterlegt</span>
          <span id="plan-slots" class="plan-valid"></span>
          <a href="preise.html#pakete" class="plan-change-link">Paket √§ndern</a>
          <button type="button"
                  id="cancel-plan-btn"
                  class="btn danger btn-cancel-plan"
                  style="display:none;">
            Paket k√ºndigen
          </button>
        </div>

      </div>
    </section>

    <section>
      <div class="container grid grid-2">

        <!-- Profil -->
        <div class="panel">
          <h2>Profil</h2>
          <p class="muted">Diese Daten sieht der/die Kund:in bei deinen Angeboten.</p>
          <form id="form-profile" class="grid" novalidate>
            <div class="field">
              <label for="pf-company">Firma / Praxis / Studio <span class="req">*</span></label>
              <input id="pf-company" name="company_name" placeholder="z. B. Salon Mira" required aria-required="true"/>
            </div>
            <div class="field">
              <label for="pf-branch">Branche <span class="req">*</span></label>
              <input id="pf-branch" name="branch" list="branch-list" placeholder="z. B. Friseur" required aria-required="true"/>
              <datalist id="branch-list">
                <option>Friseur</option><option>Kosmetik</option><option>Physiotherapie</option>
                <option>Nagelstudio</option><option>Zahnarzt</option><option>Handwerk</option>
                <option>KFZ-Service</option><option>Fitness</option><option>Coaching</option>
                <option>Tierarzt</option><option>Beh√∂rde</option><option>Sonstiges</option>
              </datalist>
            </div>

            <div class="field">
              <label for="pf-street">Stra√üe & Nr. <span class="req">*</span> <span class="req-text">(Pflichtfeld)</span></label>
              <input id="pf-street" name="street" placeholder="Musterstra√üe 1" required aria-required="true"/>
            </div>

            <div class="field">
              <label for="pf-zip">PLZ <span class="req">*</span></label>
              <input id="pf-zip" name="zip" placeholder="12345" pattern="\d{5}" inputmode="numeric" required aria-required="true"/>
            </div>
            <div class="field">
              <label for="pf-city">Ort <span class="req">*</span></label>
              <input id="pf-city" name="city" placeholder="Musterstadt" required aria-required="true"/>
            </div>

            <div class="field">
              <label for="pf-phone">Telefon <span class="req">*</span> <span class="req-text">(Pflichtfeld)</span></label>
              <input id="pf-phone" name="phone" placeholder="+49 ‚Ä¶" pattern="^\+?[0-9\s\-\/]{6,}$" required aria-required="true"/>
            </div>

            <div class="field">
              <label for="pf-whatsapp">WhatsApp (optional)</label>
              <input id="pf-whatsapp" name="whatsapp" placeholder="+49 ‚Ä¶" pattern="^\+?[0-9\s\-\/]{6,}$"/>
            </div>
            <div class="toolbar">
              <button class="btn primary" type="submit">Profil speichern</button>
              <span class="muted">Pflicht: Firma, Branche, Stra√üe, PLZ, Ort, Telefon.</span>
            </div>
            <div id="msg-profile" class="msg"></div>
          </form>

          <!-- Passwort √§ndern -->
          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <h3 style="margin-bottom: 12px; font-size: 1.1rem;">Passwort √§ndern</h3>
            <p class="muted" style="margin-bottom: 12px; font-size: 0.9rem;">√Ñndere hier dein Passwort. Du musst dein aktuelles Passwort eingeben.</p>
            <form id="form-change-password" class="grid" novalidate>
              <div class="field col-2">
                <label for="cp-old-password">Aktuelles Passwort <span class="req">*</span></label>
                <input id="cp-old-password" name="old_password" type="password" placeholder="Aktuelles Passwort" required minlength="8" autocomplete="current-password">
              </div>
              <div class="field col-2">
                <label for="cp-new-password">Neues Passwort <span class="req">*</span></label>
                <input id="cp-new-password" name="password" type="password" placeholder="Mind. 8 Zeichen" required minlength="8" autocomplete="new-password">
                <span class="hint" style="font-size: 12px;">Tipp: Mind. 8 Zeichen, besser mit Zahl & Sonderzeichen.</span>
              </div>
              <div class="field col-2">
                <label for="cp-new-password2">Neues Passwort wiederholen <span class="req">*</span></label>
                <input id="cp-new-password2" type="password" placeholder="Passwort best√§tigen" required minlength="8" autocomplete="new-password">
              </div>
              <div class="toolbar">
                <button class="btn primary" type="submit">Passwort √§ndern</button>
              </div>
              <div id="msg-change-password" class="msg"></div>
            </form>
          </div>
        </div>

        <!-- Slot anlegen / bearbeiten -->
        <div class="panel">
          <h2>Neuen Slot anlegen</h2>

          <div id="slot-guard" class="callout">
            <strong>Profil unvollst√§ndig.</strong>
            <div class="lock-hint">Bitte f√ºlle zuerst alle Pflichtfelder im Profil aus (WhatsApp ist optional). Danach kannst du Slots anlegen.</div>
          </div>

          <form id="form-slot" class="grid" novalidate>
            <fieldset id="slot-fields" disabled>
              <div class="field">
                <label for="sl-title">Titel <span class="req">*</span></label>
                <input id="sl-title" name="title" placeholder="z. B. Damenhaarschnitt" required aria-required="true"/>
              </div>

              <div class="field">
                <label for="sl-cat-main">Kategorie <span class="req">*</span></label>
                <select id="sl-cat-main" required aria-required="true">
                  <option value="" disabled selected>Bitte w√§hlen ‚Ä¶</option>
                </select>
              </div>

              <div class="field" id="sl-cat-sub-container" style="display:none;">
                <label for="sl-cat-sub">Unterkategorie <span class="req">*</span></label>
                <select id="sl-cat-sub">
                  <option value="" disabled selected>Bitte w√§hlen ‚Ä¶</option>
                </select>
              </div>

              <!-- Verstecktes Feld f√ºr die finale Kategorie, die ans Backend gesendet wird -->
              <input type="hidden" id="sl-cat" name="category" required aria-required="true"/>

              <div class="field">
                <label for="sl-date">Datum <span class="req">*</span></label>
                <input id="sl-date" type="date" required aria-required="true"/>
              </div>
              <div class="field">
                <label for="sl-start">Start (Uhrzeit) <span class="req">*</span></label>
                <input id="sl-start" type="time" step="60" required aria-required="true"/>
              </div>

              <div class="field">
                <label for="sl-duration">Dauer <span class="req">*</span></label>
                <div class="duration-row">
                  <input id="sl-duration" type="number" min="1" step="1" value="30" required aria-required="true"/>
                  <select id="sl-unit" aria-label="Einheit">
                    <option value="min">Minuten</option>
                    <option value="h">Stunden</option>
                  </select>
                </div>
                <div class="seg">
                  <button type="button" class="btn" data-min="15">15&nbsp;min</button>
                  <button type="button" class="btn" data-min="30">30&nbsp;min</button>
                  <button type="button" class="btn" data-min="45">45&nbsp;min</button>
                  <button type="button" class="btn" data-min="60">60&nbsp;min</button>
                  <button type="button" class="btn" data-min="90">90&nbsp;min</button>
                  <button type="button" class="btn" data-hour="1">1&nbsp;h</button>
                  <button type="button" class="btn" data-hour="2">2&nbsp;h</button>
                </div>
              </div>

              <div class="field">
                <label for="sl-end">Ende (berechnet)</label>
                <input id="sl-end" type="time" readonly/>
              </div>

              <!-- Slot-Adresse mit Validierung -->
              <div class="field">
                <label for="sl-street">Stra√üe & Nr. <span class="req">*</span></label>
                <input id="sl-street" name="slot_street"
                       placeholder="z. B. Musterstra√üe 12a"
                       required aria-required="true"
                       pattern="^.{2,}\s+\d{1,4}[a-zA-Z0-9\-\/]*$"
                       title="Bitte Stra√üe und Hausnummer angeben, z. B. Musterstra√üe 12a" />
              </div>

              <div class="field">
                <label for="sl-zip">PLZ <span class="req">*</span></label>
                <input id="sl-zip" name="slot_zip"
                       placeholder="z. B. 96191"
                       required aria-required="true"
                       inputmode="numeric"
                       pattern="\d{5}"
                       title="5-stellige Postleitzahl, z. B. 96191" />
              </div>

              <div class="field">
                <label for="sl-city">Ort <span class="req">*</span></label>
                <input id="sl-city" name="slot_city"
                       placeholder="z. B. Viereth"
                       required aria-required="true"
                       pattern="^[A-Za-z√Ñ√ñ√ú√§√∂√º√ü.\-\s]{2,}$"
                       title="Bitte einen g√ºltigen Ortsnamen angeben, z. B. Viereth" />
              </div>

              <div class="toolbar">
                <button type="button" class="btn" id="slot-copy-from-profile">Adresse aus Profil √ºbernehmen</button>
                <span class="muted">Standard: Profiladresse nutzen, bei Bedarf f√ºr Filialen anpassen.</span>
              </div>

              <div class="field">
                <label for="sl-cap">Kapazit√§t</label>
                <input id="sl-cap" type="number" min="1" step="1" value="1"/>
              </div>
              <div class="field">
                <label for="sl-price">Preis (Euro, optional)</label>
                <input id="sl-price" type="number" min="0" step="1" placeholder="z. B. 49"/>
              </div>
              <div class="field" style="grid-column:1/-1">
                <label for="sl-notes">Notizen (intern)</label>
                <textarea id="sl-notes" rows="2" placeholder="optional"></textarea>
              </div>

              <div class="toolbar">
                <button class="btn primary" type="submit" id="slot-submit-btn">Slot anlegen</button>
                <button type="button" class="btn" id="btn-slot-cancel-edit" style="display:none;">Bearbeitung abbrechen</button>
                <span class="muted">Status: <span class="badge-st st-pending">Entwurf</span></span>
              </div>
            </fieldset>
            <div id="msg-slot" class="msg"></div>
          </form>
        </div>

        <!-- Meine Slots -->
        <div class="panel" style="grid-column:1/-1">
          <div class="toolbar" style="justify-content:space-between">
            <h2 style="margin:0">Meine Slots</h2>
            <div class="slot-filter">
              <input id="slot-search" type="text" placeholder="Suche Titel oder Kategorie ‚Ä¶">
              <div class="seg" style="gap:8px">
                <button class="btn" id="btn-show-active" data-filter="active">Aktive Termine</button>
                <button class="btn" id="btn-show-archived" data-filter="archived">Archivierte Termine</button>
              </div>
              <div class="seg">
                <label class="check">
                  <input type="checkbox" id="chk-all"> Alle ausw√§hlen
                </label>
                <button class="btn action" id="btn-publish" disabled>Ver√∂ffentlichen</button>
                <button class="btn" id="btn-archive" disabled>Archivieren</button>
                <button class="btn danger" id="btn-delete" disabled>L√∂schen</button>
                <button class="btn" id="btn-refresh">Aktualisieren</button>
              </div>
            </div>
          </div>

          <div class="muted" style="margin:6px 0 12px">
            Hinweis: Neue Slots werden zun√§chst als <em>Entwurf</em> angelegt und sind erst nach dem Ver√∂ffentlichen √∂ffentlich sichtbar.
          </div>

          <!-- Hinweis bei erreichtem Slot-Limit -->
          <div id="slot-limit-alert" class="alert">
            <strong>Slot-Limit erreicht.</strong>
            <div class="small">
              Du hast dein monatliches Ver√∂ffentlichungslimit erreicht.
              Du kannst aktuell keine weiteren Slots freischalten.
              Wenn du mehr Termine ver√∂ffentlichen m√∂chtest, wechsle auf ein gr√∂√üeres Paket
              oder versuche es im n√§chsten Monat erneut.
            </div>
          </div>

          <div class="table-wrap">
            <table class="table" id="tbl-slots">
              <thead>
                <tr>
                  <th>‚úì</th>
                  <th>Start</th>
                  <th>Ende</th>
                  <th>Titel</th>
                  <th>Kategorie</th>
                  <th class="nowrap">Ort</th>
                  <th>Kap.</th>
                  <th>Status</th>
                  <th class="nowrap">Aktionen</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="9" class="muted">Lade ‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
          <div id="msg-slots" class="msg"></div>
        </div>

      </div>
    </section>
  </main>

  <script>
    // ---------- API-Basis (global, wie vorher) ----------
    const API = (() => {
      const h = location.hostname;
      const proto = location.protocol;

      const isLocal =
        h === 'localhost' ||
        h === '127.0.0.1' ||
        /^192\.168\./.test(h) ||
        /^10\./.test(h) ||
        h.endsWith('.local');

      if (isLocal) {
        return `${proto}//${h}:5000`;
      }
      if (h === 'api.terminmarktplatz.de') {
        return `${proto}//${h}`;
      }
      return 'https://api.terminmarktplatz.de';
    })();
    window.API = API;

    const $  = (q, root=document)=>root.querySelector(q);
    const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));

    function showMsg(id, text, ok=false){
      const el = document.getElementById(id);
      if (!el) return;
      el.className = 'msg ' + (ok ? 'ok' : 'err');
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, ok ? 1800 : 4200);
    }

    function showSlotLimitAlert(){
      const el = document.getElementById('slot-limit-alert');
      if (el) el.style.display = 'block';
    }
    function hideSlotLimitAlert(){
      const el = document.getElementById('slot-limit-alert');
      if (el) el.style.display = 'none';
    }

    function pad(n){ return n.toString().padStart(2,'0'); }
    function joinDateTime(dateStr, timeStr){
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      return new Date(y, (m-1), d, hh, mm, 0, 0);
    }

    // ‚úÖ FIX: Backend liefert teils ISO ohne Zeitzone -> als UTC interpretieren
    function looksLikeIsoWithTZ(s){
      return /[zZ]$/.test(s) || /[+\-]\d{2}:\d{2}$/.test(s);
    }
    function parseApiDate(s){
      if (!s) return null;
      const str = String(s).trim();
      if (!str) return null;
      const normalized = looksLikeIsoWithTZ(str) ? str : (str + 'Z');
      const d = new Date(normalized);
      return isNaN(d.getTime()) ? null : d;
    }

    function fmtLocal(dtStr){
      const d = parseApiDate(dtStr);
      if (!d) return '';
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ---------- Kategorien mit Unterkategorien ----------
    const CATEGORIES = {
      // Einfache Kategorien (ohne Unterkategorien)
      "Friseur": null,
      "Kosmetik": null,
      "Physiotherapie": null,
      "Nagelstudio": null,
      "Handwerk": null,
      "KFZ-Service": null,
      "Fitness": null,
      "Coaching": null,
      "Tierarzt": null,
      "Rechtsanwalt": null,
      "Notar": null,
      "T√§towierer": null,
      "Sonstiges": null,
      // √Ñrzte mit Unterkategorien
      "√Ñrzte": [
        "Haus√§rzte",
        "Orthop√§den",
        "Gyn√§kologen",
        "Haut√§rzte",
        "Psychotherapeuten",
        "Zahn√§rzte",
        "Kinder√§rzte"
      ],
      // √Ñmter mit Unterkategorien
      "√Ñmter": [
        "B√ºrgeramt",
        "Kfz-Zulassungsstelle",
        "Finanzamt",
        "Ausl√§nderbeh√∂rde",
        "Jobcenter"
      ],
      // Legacy-Kategorien (f√ºr Kompatibilit√§t)
      "Zahnarzt": null,
      "Beh√∂rde": null
    };

    // Hauptkategorie-Select
    const mainCatSel = document.getElementById('sl-cat-main');
    // Unterkategorie-Select
    const subCatSel = document.getElementById('sl-cat-sub');
    // Verstecktes Feld f√ºr die finale Kategorie
    const finalCatInput = document.getElementById('sl-cat');

    // Event-Listener nur einmal registrieren
    let categoryListenersInitialized = false;

    function fillCategoryOptions(){
      // Hauptkategorie-Select f√ºllen
      if(mainCatSel) {
        const mainCategories = Object.keys(CATEGORIES).filter(key => key !== 'Zahnarzt' && key !== 'Beh√∂rde');
        mainCatSel.innerHTML = `<option value="" disabled selected>Bitte w√§hlen ‚Ä¶</option>`
          + mainCategories.map(c => `<option value="${c}">${c}</option>`).join('');
      }

      // Event-Listener nur einmal registrieren
      if(mainCatSel && subCatSel && finalCatInput && !categoryListenersInitialized) {
        categoryListenersInitialized = true;

        // Wenn Hauptkategorie ausgew√§hlt wird, Unterkategorien anzeigen
        mainCatSel.addEventListener('change', function() {
          const selectedMain = this.value;
          const subCats = CATEGORIES[selectedMain];

          // Unterkategorie-Container anzeigen/verstecken
          const subCatContainer = document.getElementById('sl-cat-sub-container');
          if(subCatContainer) {
            if(subCats && subCats.length > 0) {
              subCatContainer.style.display = 'block';
              subCatSel.required = true;
              subCatSel.innerHTML = `<option value="" disabled selected>Bitte Unterkategorie w√§hlen ‚Ä¶</option>`
                + subCats.map(c => `<option value="${c}">${c}</option>`).join('');
              finalCatInput.value = '';
            } else {
              subCatContainer.style.display = 'none';
              subCatSel.required = false;
              subCatSel.innerHTML = '';
              finalCatInput.value = selectedMain;
            }
          }
        });

        // Wenn Unterkategorie ausgew√§hlt wird, finale Kategorie setzen
        subCatSel.addEventListener('change', function() {
          finalCatInput.value = this.value;
        });
      }

      // Legacy: Falls nur ein Select-Feld existiert, alle Kategorien anzeigen
      const legacySel = document.getElementById('sl-cat');
      if(legacySel && !mainCatSel && legacySel.tagName === 'SELECT') {
        const allCategories = [];
        Object.keys(CATEGORIES).forEach(main => {
          if(CATEGORIES[main] === null) {
            allCategories.push(main);
          } else {
            allCategories.push(...CATEGORIES[main]);
          }
        });
        legacySel.innerHTML = `<option value="" disabled selected>Bitte w√§hlen ‚Ä¶</option>`
          + allCategories.map(c => `<option value="${c}">${c}</option>`).join('');
      }
    }

    // Hilfsfunktion: Kategorie aus dem versteckten Feld setzen (beim Bearbeiten)
    function setCategoryFromValue(categoryValue) {
      if(!categoryValue) return;

      // Pr√ºfe ob es eine Unterkategorie ist
      let found = false;
      Object.keys(CATEGORIES).forEach(main => {
        const subCats = CATEGORIES[main];
        if(subCats && subCats.includes(categoryValue)) {
          // Es ist eine Unterkategorie
          if(mainCatSel) mainCatSel.value = main;
          if(mainCatSel) mainCatSel.dispatchEvent(new Event('change'));
          setTimeout(() => {
            if(subCatSel) subCatSel.value = categoryValue;
            if(finalCatInput) finalCatInput.value = categoryValue;
          }, 0);
          found = true;
        } else if(main === categoryValue) {
          // Es ist eine Hauptkategorie ohne Unterkategorien
          if(mainCatSel) mainCatSel.value = main;
          if(mainCatSel) mainCatSel.dispatchEvent(new Event('change'));
          if(finalCatInput) finalCatInput.value = categoryValue;
          found = true;
        }
      });
    }

    // ---------- Validierungen ----------
    function isValidZip(v){ return /^\d{5}$/.test((v||'').trim()); }
    function isValidPhone(v){ return /^\+?[0-9\s\-\/]{6,}$/.test((v||'').trim()); }

    function isValidStreetWithNumber(v){
      v = (v || '').trim();
      if (!v) return false;
      return /^.{2,}\s+\d{1,4}[a-zA-Z0-9\-\/]*$/.test(v);
    }

    function isValidCityName(v){
      v = (v || '').trim();
      if (!v) return false;
      return /^[A-Za-z√Ñ√ñ√ú√§√∂√º√ü.\-\s]{2,}$/.test(v);
    }

    // ‚úÖ Stra√üe+Nr splitten f√ºr DB-Felder
    function splitStreetAndNumber(v){
      v = (v || '').trim();
      const m = v.match(/^(.{2,}?)\s+(\d{1,4}[a-zA-Z0-9\-\/]*)$/);
      if (!m) return { street: v, house_number: '' };
      return { street: m[1].trim(), house_number: m[2].trim() };
    }

    // ‚úÖ Adresse aus Slot-Daten f√ºr Anzeige bauen (fallback)
    function displayAddress(slot){
      if (!slot) return '';
      const s = (slot.street || '').trim();
      const hn = (slot.house_number || '').trim();
      const z = (slot.zip || '').trim();
      const c = (slot.city || '').trim();

      const line1 = (s || hn) ? `${s}${hn ? ' ' + hn : ''}`.trim() : '';
      const line2 = (z || c) ? `${z}${(z && c) ? ' ' : ''}${c}`.trim() : '';
      const combined = [line1, line2].filter(Boolean).join(', ');
      return combined || (slot.location || '');
    }

    // ---------- Profil-Check ----------
    function isProfileCompleteFromValues(vals){
      const streetCombined = `${(vals.street || '').trim()} ${(vals.house_number || '').trim()}`.trim();

      return !!(
        vals.company_name &&
        vals.branch &&
        isValidStreetWithNumber(streetCombined) &&
        isValidZip(vals.zip) &&
        vals.city &&
        isValidPhone(vals.phone)
      );
    }


    function getProfileValuesFromForm(){
      const combined = $('#pf-street').value.trim();
      const parsed = splitStreetAndNumber(combined); // nutzt deine bestehende Funktion

      return {
        company_name: $('#pf-company').value.trim(),
        branch:       $('#pf-branch').value.trim(),

        // ‚úÖ DB-Felder sauber
        street:       parsed.street,
        house_number: parsed.house_number,

        zip:          $('#pf-zip').value.trim(),
        city:         $('#pf-city').value.trim(),
        phone:        $('#pf-phone').value.trim(),
        whatsapp:     $('#pf-whatsapp').value.trim(),
      };
    }


    function copyProfileAddressToSlot(force=false){
      const streetInput = $('#sl-street');
      const zipInput    = $('#sl-zip');
      const cityInput   = $('#sl-city');
      if (!streetInput || !zipInput || !cityInput) return;

      const currentFilled =
        (streetInput.value && streetInput.value.trim()) ||
        (zipInput.value && zipInput.value.trim()) ||
        (cityInput.value && cityInput.value.trim());

      if (!force && currentFilled) return;

      const prof = getProfileValuesFromForm();
      if (!prof.street && !prof.zip && !prof.city) return;

      const combined = `${prof.street || ''}${prof.house_number ? ' ' + prof.house_number : ''}`.trim();
      streetInput.value = combined;
      zipInput.value    = prof.zip || '';
      cityInput.value   = prof.city || '';

    }

    function setSlotLock(locked){
      const fs = $('#slot-fields');
      const guard = $('#slot-guard');
      if (fs) fs.disabled = !!locked;
      if (guard) guard.style.display = locked ? 'block' : 'none';
    }

    // ---------- Auth / Profil laden ----------
    let ME = null;
    async function requireAuth(){
      try{
        const r = await fetch(`${API}/me`, { credentials:'include' });
        if (!r.ok) {
          if (r.status === 401 || r.status === 403) {
            window.location.href = 'login.html?tab=login';
            return;
          }
          showMsg('msg-profile', 'Anmeldung erforderlich oder API nicht erreichbar.', false);
          return;
        }
        ME = await r.json();

        // Admin-Link anzeigen nur wenn Admin (explizit true)
        const adminInvoicesLink = document.getElementById('admin-invoices-link');
        if (adminInvoicesLink) {
          // Nur anzeigen wenn is_admin explizit true ist (strict check)
          if (ME.is_admin === true) {
            adminInvoicesLink.style.display = 'block';
          } else {
            adminInvoicesLink.style.display = 'none'; // Explizit verstecken
          }
        }

        $('#pf-company').value  = ME.company_name || '';
        $('#pf-branch').value   = ME.branch || '';
        $('#pf-street').value = `${ME.street || ''}${ME.house_number ? ' ' + ME.house_number : ''}`.trim();
        $('#pf-zip').value      = ME.zip || '';
        $('#pf-city').value     = ME.city || '';
        $('#pf-phone').value    = ME.phone || '';
        $('#pf-whatsapp').value = ME.whatsapp || '';

        const PLAN_LABELS = { basic:'Basis (Standard)', starter:'Starter', profi:'Profi', business:'Business' };
        const planNameEl   = document.getElementById('plan-name');
        const planValidEl  = document.getElementById('plan-valid-until');
        const planSlotsEl  = document.getElementById('plan-slots');
        const cancelBtn    = document.getElementById('cancel-plan-btn');

        if (planNameEl && planValidEl) {
          const key   = (ME.plan || ME.plan_key || 'basic');
          const label = ME.plan_label || PLAN_LABELS[key] || key;
          planNameEl.textContent = label;

          if (ME.plan_valid_until) {
            const d = new Date(ME.plan_valid_until);
            if (!isNaN(d.getTime())) {
              planValidEl.textContent = '¬∑ g√ºltig bis ' + d.toLocaleDateString('de-DE');
            } else {
              planValidEl.textContent = '¬∑ Laufzeit aktiv';
            }
          } else {
            planValidEl.textContent = '¬∑ kein Ablaufdatum hinterlegt';
          }

          if (planSlotsEl) {
            if (ME.slots_unlimited) {
              planSlotsEl.textContent = '¬∑ Slots diesen Monat: unbegrenzt';
            } else if (typeof ME.free_slots_per_month === 'number' &&
                       typeof ME.slots_used_this_month === 'number') {

              const total = ME.free_slots_per_month;
              const used  = ME.slots_used_this_month;
              const left  = (typeof ME.slots_left_this_month === 'number')
                ? ME.slots_left_this_month
                : Math.max(0, total - used);

              planSlotsEl.textContent = `¬∑ Slots diesen Monat: ${used}/${total} (noch ${left} frei)`;
            } else {
              planSlotsEl.textContent = '';
            }
          }
        }

        if (cancelBtn) {
          const planKey = (ME.plan || ME.plan_key || '').trim();
          if (planKey && planKey !== 'basic') {
            cancelBtn.style.display = 'inline-flex';
            cancelBtn.onclick = async () => {
              const ok = confirm(
                'Willst du dein aktuelles Paket im Terminmarktplatz-Portal wirklich k√ºndigen?\n\n' +
                'Hinweis: Dein kostenpflichtiges Abo bei CopeCart musst du zus√§tzlich direkt bei CopeCart k√ºndigen.'
              );
              if (!ok) return;

              try {
                const res = await fetch(`${API}/me/cancel_plan`, { method: 'POST', credentials: 'include' });
                const data = await res.json().catch(() => ({}));
                if (res.ok && data.ok) {
                  alert(
                    'Paket im Portal gek√ºndigt.\n\n' +
                    'Dein Paket wurde im Terminmarktplatz-Portal auf das kostenlose Basis-Paket umgestellt.\n\n' +
                    'WICHTIG: Damit keine weiteren Abbuchungen erfolgen, musst du dein kostenpflichtiges Abo zus√§tzlich direkt bei CopeCart k√ºndigen.\n\n' +
                    'So gehst du vor:\n' +
                    '1. √ñffne deine CopeCart-Bestellbest√§tigung oder logge dich bei CopeCart ein.\n' +
                    '2. Suche dein aktives Abo f√ºr den Terminmarktplatz.\n' +
                    '3. Klicke dort auf ‚ÄûAbo k√ºndigen‚Äú bzw. den entsprechenden K√ºndigungslink.\n\n' +
                    'Erst wenn die K√ºndigung bei CopeCart durchgef√ºhrt wurde, stoppen zuk√ºnftige Abbuchungen.'
                  );
                  location.reload();
                } else if (data.error === 'no_active_plan') {
                  alert('Du hast aktuell kein bezahltes Paket. Du nutzt bereits das Basis-Paket.');
                  cancelBtn.style.display = 'none';
                } else {
                  alert(data.error ? `K√ºndigung fehlgeschlagen: ${data.error}` : 'K√ºndigung fehlgeschlagen.');
                }
              } catch (err) {
                alert('Netzwerkfehler bei der K√ºndigung ‚Äì bitte sp√§ter erneut versuchen.');
              }
            };
          } else {
            cancelBtn.style.display = 'none';
          }
        }

        const complete = isProfileCompleteFromValues(getProfileValuesFromForm());
        setSlotLock(!complete);

        if (complete) copyProfileAddressToSlot(false);

      }catch(err){
        showMsg('msg-profile', 'Netzwerkfehler ‚Äì API aktuell nicht erreichbar.', false);
      }
    }

    // ---------- Profil speichern ----------
    $('#form-profile').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = getProfileValuesFromForm();
      try{
        const r = await fetch(`${API}/me`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=> ({}));
        if(r.ok){
          const complete = isProfileCompleteFromValues(payload);
          showMsg('msg-profile', complete ? 'Gespeichert ‚úì Profil vollst√§ndig.' : 'Gespeichert ‚úì Bitte Pflichtfelder erg√§nzen.');
          setSlotLock(!complete);
          if (complete) copyProfileAddressToSlot(false);
        }else{
          const map = {
            unauthorized: 'Bitte erneut anmelden.',
            invalid_zip: 'PLZ muss 5-stellig sein.',
            db_constraint_error: 'Ung√ºltige/fehlende Felder (DB-Vorgaben).',
            db_error: 'Datenbankfehler.'
          };
          showMsg('msg-profile', map[data.error] || 'Konnte Profil nicht speichern.');
          if(r.status === 401) location.href = 'login.html?tab=login';
        }
      }catch(e){
        showMsg('msg-profile','Netzwerkfehler.');
      }
    });

    // ---------- Passwort √§ndern ----------
    $('#form-change-password').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const oldPassword = $('#cp-old-password').value;
      const newPassword = $('#cp-new-password').value;
      const newPassword2 = $('#cp-new-password2').value;

      if (!oldPassword || !newPassword || !newPassword2) {
        return showMsg('msg-change-password', 'Bitte alle Felder ausf√ºllen.');
      }
      if (newPassword.length < 8) {
        return showMsg('msg-change-password', 'Neues Passwort muss mindestens 8 Zeichen haben.');
      }
      if (newPassword !== newPassword2) {
        return showMsg('msg-change-password', 'Passw√∂rter stimmen nicht √ºberein.');
      }

      try {
        const r = await fetch(`${API}/auth/change-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ old_password: oldPassword, password: newPassword })
        });
        const data = await r.json().catch(() => ({}));
        if (r.ok) {
          showMsg('msg-change-password', 'Passwort wurde erfolgreich ge√§ndert.', true);
          $('#form-change-password').reset();
        } else {
          const errorMsg = {
            'invalid_old_password': 'Aktuelles Passwort ist falsch.',
            'password_too_short': 'Neues Passwort muss mindestens 8 Zeichen haben.',
            'missing_fields': 'Bitte alle Felder ausf√ºllen.',
          }[data.error] || (data.error || 'Fehler beim √Ñndern des Passworts.');
          showMsg('msg-change-password', errorMsg);
          if (r.status === 401) location.href = 'login.html?tab=login';
        }
      } catch (e) {
        showMsg('msg-change-password', 'Netzwerkfehler.');
      }
    });

    // ---------- Slot-Form: Dauer -> Ende ----------
    function totalMinutes(){
      const val = parseInt($('#sl-duration').value || '0', 10);
      const unit = $('#sl-unit').value;
      if (!val) return 0;
      return unit === 'h' ? val * 60 : val;
    }
    function recalcEnd(){
      const d = $('#sl-date').value;
      const t = $('#sl-start').value;
      const min = totalMinutes();
      if(!d || !t || !min){ $('#sl-end').value=''; return; }
      const start = joinDateTime(d,t);
      const end   = new Date(start.getTime() + min*60000);
      $('#sl-end').value = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
    }

    $('#sl-date').addEventListener('change',  recalcEnd);
    $('#sl-start').addEventListener('input',  recalcEnd);
    $('#sl-duration').addEventListener('input', recalcEnd);
    $('#sl-unit').addEventListener('change',  recalcEnd);

    $$('#form-slot .seg [data-min]').forEach(b => b.addEventListener('click', ()=>{
      $('#sl-unit').value = 'min';
      $('#sl-duration').value = b.dataset.min;
      recalcEnd();
    }));
    $$('#form-slot .seg [data-hour]').forEach(b => b.addEventListener('click', ()=>{
      $('#sl-unit').value = 'h';
      $('#sl-duration').value = b.dataset.hour;
      recalcEnd();
    }));

    const copyBtn = document.getElementById('slot-copy-from-profile');
    if (copyBtn) {
      copyBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        copyProfileAddressToSlot(true);
        showMsg('msg-slot', 'Adresse aus Profil √ºbernommen.', true);
      });
    }

    const cancelEditBtn = document.getElementById('btn-slot-cancel-edit');
    if (cancelEditBtn) {
      cancelEditBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        resetSlotForm();
        showMsg('msg-slot', 'Bearbeitung abgebrochen. Neuer Slot kann angelegt werden.', true);
      });
    }

    // ---------- Slot anlegen / aktualisieren ----------
    document.getElementById('form-slot').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fs = document.getElementById('slot-fields');
      if (fs && fs.disabled) {
        showMsg('msg-slot', 'Profil zuerst vollst√§ndig ausf√ºllen.');
        return;
      }

      const title    = $('#sl-title').value.trim();
      const category = $('#sl-cat').value;
      const date     = $('#sl-date').value;
      const start    = $('#sl-start').value;

      const streetCombined = $('#sl-street').value.trim();
      const zip      = $('#sl-zip').value.trim();
      const city     = $('#sl-city').value.trim();

      const duration = totalMinutes();

      if (!title || !category || !date || !start || !streetCombined || !zip || !city || !duration) {
        showMsg('msg-slot', 'Bitte alle Pflichtfelder f√ºr den Slot ausf√ºllen.');
        return;
      }

      if (!isValidStreetWithNumber(streetCombined)) {
        showMsg('msg-slot', 'Adresse unplausibel: Bitte Stra√üe und Hausnummer eingeben (z. B. Musterstra√üe 12a).');
        return;
      }
      if (!isValidZip(zip)) {
        showMsg('msg-slot', 'PLZ muss 5-stellig sein.');
        return;
      }
      if (!isValidCityName(city)) {
        showMsg('msg-slot', 'Ort unplausibel ‚Äì bitte nur Buchstaben verwenden.');
        return;
      }

      const startDt = joinDateTime(date, start);
      const endDt   = new Date(startDt.getTime() + duration * 60000);

      const capacity = parseInt($('#sl-cap').value || '1', 10);
      const priceVal = $('#sl-price').value;
      const notes    = $('#sl-notes').value.trim();

      // ‚úÖ splitten -> DB-Felder
      const parsed = splitStreetAndNumber(streetCombined);

      // Kompatibilit√§t / Anzeige
      const location = `${streetCombined}, ${zip} ${city}`;

      const priceCents = (priceVal === '' ? null : Math.round(Number(priceVal) * 100));

      const payload = {
        title,
        category,
        start_at: startDt.toISOString(),
        end_at:   endDt.toISOString(),

        // ‚úÖ DB-Felder (Model Slot.street/house_number/zip/city)
        street: parsed.street,
        house_number: parsed.house_number,
        zip,
        city,

        // optional: Freitext-Adresse weiter f√ºllen
        location,

        capacity: isNaN(capacity) ? 1 : capacity,
        price_cents: (priceCents === null || isNaN(priceCents)) ? null : priceCents,
        notes: notes || null
      };

      try {
        let res;
        let data = {};

        if (EDITING_SLOT && EDITING_SLOT.id) {
          const body = Object.assign({}, payload);
          if (EDITING_SLOT.status) body.status = EDITING_SLOT.status;

          res = await fetch(`${API}/slots/${EDITING_SLOT.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(body)
          });
        } else {
          res = await fetch(`${API}/slots`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
        }

        data = await res.json().catch(() => ({}));

        if (res.ok) {
          const msg = (EDITING_SLOT && EDITING_SLOT.id) ? 'Slot aktualisiert.' : 'Slot angelegt.';
          showMsg('msg-slot', msg, true);
          resetSlotForm();
          await loadSlots();
        } else {
          showMsg('msg-slot', data.error || 'Slot konnte nicht gespeichert werden.');
        }
      } catch (err) {
        showMsg('msg-slot', 'Netzwerkfehler ‚Äì Slot konnte nicht gespeichert werden.');
      }
    });

    // ---------- Buchung absagen ----------
    async function cancelBooking(bookingId, customerLabel){
      if (!bookingId) return;
      const confirmText = customerLabel ? `Buchung von ${customerLabel} wirklich absagen?` : 'Diese Buchung wirklich absagen?';
      const ok = confirm(confirmText);
      if (!ok) return;

      const reason = prompt('Optional: Grund f√ºr die Absage (wird per E-Mail mitgeschickt):', '') || '';

      try{
        const res = await fetch(`${API}/provider/bookings/${bookingId}/cancel`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ reason })
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.ok){
          showMsg('msg-slots', data.error || 'Buchung konnte nicht abgesagt werden.');
          return;
        }
        showMsg('msg-slots', 'Buchung abgesagt. Kund:in wurde per E-Mail informiert.', true);
        await loadSlots();
      }catch(e){
        showMsg('msg-slots', 'Netzwerkfehler ‚Äì Buchung konnte nicht abgesagt werden.');
      }
    }

    // ---------- Slots laden & rendern ----------
    let SELECTED = new Set();
    let LAST_ITEMS = [];
    let EDITING_SLOT = null;

    function updateBulkButtons(items){
      const byId = Object.fromEntries(items.map(x => [x.id, x]));
      const ids = [...SELECTED];
      const any = ids.length > 0;

      const anyDraft = ids.some(id => ((byId[id]?.status || '').toString().toUpperCase() === 'DRAFT'));
      const anyPublished = ids.some(id => ((byId[id]?.status || '').toString().toUpperCase() === 'PUBLISHED'));

      $('#btn-publish').disabled = !(any && anyDraft);
      $('#btn-archive').disabled = !(any && anyPublished);
      $('#btn-delete').disabled  = !any;
    }

    function pickTimestamp(candidates) {
      for (const v of candidates) {
        if (v) return v;
      }
      return null;
    }

    function isoToLocalDateTime(iso){
      const d = parseApiDate(iso);
      if (!d) return { date:'', time:'' };
      const date = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      return { date, time };
    }

    function parseLocation(loc){
      loc = (loc || '').trim();
      if (!loc) return { street:'', zip:'', city:'' };
      const parts = loc.split(',');
      if (parts.length < 2){
        return { street: loc, zip:'', city:'' };
      }
      const street = parts[0].trim();
      const rest = parts.slice(1).join(',').trim();
      const m = rest.match(/^(\d{4,5})\s+(.*)$/);
      if (m){
        return { street, zip: m[1], city: m[2].trim() };
      }
      return { street, zip:'', city: rest };
    }

    function resetSlotForm(){
      EDITING_SLOT = null;
      const form = document.getElementById('form-slot');
      if (form) form.reset();
      
      // Kategorie-Felder zur√ºcksetzen
      const mainCatSel = document.getElementById('sl-cat-main');
      const subCatSel = document.getElementById('sl-cat-sub');
      const subCatContainer = document.getElementById('sl-cat-sub-container');
      const finalCatInput = document.getElementById('sl-cat');
      if (mainCatSel) mainCatSel.value = '';
      if (subCatSel) {
        subCatSel.value = '';
        subCatSel.required = false;
      }
      if (subCatContainer) subCatContainer.style.display = 'none';
      if (finalCatInput) finalCatInput.value = '';
      
      const dur = document.getElementById('sl-duration');
      const unit = document.getElementById('sl-unit');
      if (dur) dur.value = 30;
      if (unit) unit.value = 'min';
      recalcEnd();
      copyProfileAddressToSlot(false);
      const submitBtn = document.getElementById('slot-submit-btn');
      if (submitBtn) submitBtn.textContent = 'Slot anlegen';
      const cancelEditBtnInner = document.getElementById('btn-slot-cancel-edit');
      if (cancelEditBtnInner) cancelEditBtnInner.style.display = 'none';
    }

    function enterEditMode(slot){
      if (!slot) return;
      EDITING_SLOT = slot;

      const title = document.getElementById('sl-title');
      if (title) title.value = slot.title || '';

      // Kategorie setzen mit hierarchischer Struktur
      if (slot.category) {
        setCategoryFromValue(slot.category);
      }

      const dt = isoToLocalDateTime(slot.start_at);
      const dateInput = document.getElementById('sl-date');
      const startInput = document.getElementById('sl-start');
      if (dateInput) dateInput.value = dt.date;
      if (startInput) startInput.value = dt.time;

      let durationMinutes = 0;
      if (slot.start_at && slot.end_at){
        const start = parseApiDate(slot.start_at);
        const end   = parseApiDate(slot.end_at);
        if (start && end){
          const diff  = Math.round((end - start) / 60000);
          if (diff > 0) durationMinutes = diff;
        }
      }
      if (!durationMinutes) durationMinutes = 30;

      const dur = document.getElementById('sl-duration');
      const unit = document.getElementById('sl-unit');
      if (unit) unit.value = 'min';
      if (dur) dur.value = durationMinutes;
      recalcEnd();

      const cap = document.getElementById('sl-cap');
      if (cap) cap.value = slot.capacity || 1;

      const priceInput = document.getElementById('sl-price');
      if (priceInput){
        if (typeof slot.price_cents === 'number' && !isNaN(slot.price_cents)){
          priceInput.value = (slot.price_cents / 100).toFixed(2);
        } else {
          priceInput.value = '';
        }
      }

      const notesInput = document.getElementById('sl-notes');
      if (notesInput) notesInput.value = slot.notes || '';

      // ‚úÖ DB-Felder bevorzugen, fallback auf location
      const stInput = document.getElementById('sl-street');
      const zipInput = document.getElementById('sl-zip');
      const cityInput = document.getElementById('sl-city');

      const hasDbAddress = !!((slot.street || '').trim() || (slot.house_number || '').trim() || (slot.zip || '').trim() || (slot.city || '').trim());

      if (hasDbAddress){
        const s = (slot.street || '').trim();
        const hn = (slot.house_number || '').trim();
        if (stInput) stInput.value = `${s}${hn ? ' ' + hn : ''}`.trim();
        if (zipInput) zipInput.value = (slot.zip || '').trim();
        if (cityInput) cityInput.value = (slot.city || '').trim();
      } else {
        const loc = parseLocation(slot.location || '');
        if (stInput) stInput.value = loc.street;
        if (zipInput) zipInput.value = loc.zip;
        if (cityInput) cityInput.value = loc.city;
      }

      const submitBtn = document.getElementById('slot-submit-btn');
      if (submitBtn) submitBtn.textContent = 'Slot aktualisieren';
      const cancelEditBtnInner = document.getElementById('btn-slot-cancel-edit');
      if (cancelEditBtnInner) cancelEditBtnInner.style.display = 'inline-flex';

      showMsg('msg-slot', 'Du bearbeitest einen bestehenden Slot (noch nicht gebucht).', true);

      const form = document.getElementById('form-slot');
      if (form && form.scrollIntoView){
        form.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    }

    function renderTable(items){
      const tbody = $('#tbl-slots tbody');
      if(!items.length){
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Noch keine Slots angelegt.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      const now = new Date();

      for(const s of items){
        const tr = document.createElement('tr');

        const rawStatus = (s.status || '').toString().toUpperCase();
        const isDraft    = rawStatus === 'DRAFT';
        const isPublished= rawStatus === 'PUBLISHED';
        const isCanceled = rawStatus === 'CANCELED';
        const isExpired  = rawStatus === 'EXPIRED';
        const isArchived = s.archived === true;

        const endDate = s.end_at ? parseApiDate(s.end_at) : null;
        const isPast  = !!(endDate && endDate < now);

        const allBookings      = Array.isArray(s.bookings) ? s.bookings : [];
        const activeBookings   = allBookings.filter(b => b.status === 'confirmed');
        const canceledBookings = allBookings.filter(b => b.status === 'canceled');

        const capacity    = s.capacity || 1;
        const bookedCount = activeBookings.length;
        const available   = Math.max(0, capacity - bookedCount);
        const isBooked    = bookedCount > 0;

        const stClass =
          isArchived ? 'st-arch'
          : isPublished ? 'st-pub'
          : isCanceled ? 'st-canceled'
          : 'st-pending';

        const canPublish = isDraft && !isArchived;
        const canEdit = !isCanceled && !isBooked && !isArchived;

        let rowClass = '';
        if (isPast) rowClass += ' slot-past';
        if (isCanceled) rowClass += ' slot-canceled';
        else if (isDraft) rowClass += ' slot-pending';
        else if (isPublished) rowClass += (isBooked ? ' slot-booked' : ' slot-free');
        tr.className = rowClass.trim();

        const hintParts = [];
        if (!isCanceled) {
          if (isBooked) hintParts.push(`Gebucht (${bookedCount}/${capacity})`);
          else if (isPublished && !isPast) hintParts.push(`Frei (${available}/${capacity})`);
        }
        if (isPast) hintParts.push('Abgelaufen');
        const hintText = hintParts.length ? hintParts.join(' ‚Ä¢ ') : '';

        let bookingHint = '';
        if (activeBookings.length > 0){
          if (activeBookings.length === 1){
            const b = activeBookings[0];
            bookingHint = `Gebucht von: ${b.customer_name} (${b.customer_email})`;
          } else {
            const maxVisible = 3;
            const visible = activeBookings.slice(0, maxVisible);
            const listStr = visible.map(b => `${b.customer_name} (${b.customer_email})`).join('; ');
            const hiddenCount = activeBookings.length - visible.length;
            bookingHint = hiddenCount > 0 ? `Gebucht von: ${listStr} + ${hiddenCount} weitere` : `Gebucht von: ${listStr}`;
          }
        }

        let bookingTimeHint = '';
        if (activeBookings.length > 0){
          const ts = pickTimestamp([
            ...activeBookings.map(b => b.booked_at),
            ...activeBookings.map(b => b.created_at),
            ...activeBookings.map(b => b.created),
            s.booked_at,
            s.created_at,
            s.created,
            s.updated_at,
            s.updated
          ]);
          if (ts) bookingTimeHint = `Gebucht am: ${fmtLocal(ts)}`;
        }

        let canceledTimeHint = '';
        if (isCanceled) {
          const ts = pickTimestamp([
            s.canceled_at,
            s.cancelled_at,
            s.updated_at,
            ...canceledBookings.map(b => b.canceled_at),
            ...canceledBookings.map(b => b.cancelled_at),
            ...canceledBookings.map(b => b.updated_at)
          ]);
          if (ts) canceledTimeHint = `Storniert am: ${fmtLocal(ts)}`;
        }

        const hintHtml = [];
        if (hintText)         hintHtml.push(`<span class="slot-hint">${hintText}</span>`);
        if (bookingHint)      hintHtml.push(`<span class="slot-hint">${bookingHint}</span>`);
        if (bookingTimeHint)  hintHtml.push(`<span class="slot-hint">${bookingTimeHint}</span>`);
        if (canceledTimeHint) hintHtml.push(`<span class="slot-hint slot-hint-canceled">${canceledTimeHint}</span>`);

        let cancelHtml = '';
        if (activeBookings.length === 1){
          const b = activeBookings[0];
          const label = `${b.customer_name} (${b.customer_email})`;
          cancelHtml = `
            <button class="btn danger" data-cancel-booking="${b.id}" data-cancel-label="${label}">
              Buchung absagen
            </button>
          `;
        } else if (activeBookings.length > 1){
          const options = activeBookings
            .map(b => `<option value="${b.id}">${b.customer_name} (${b.customer_email})</option>`)
            .join('');
          cancelHtml = `
            <div class="booking-cancel">
              <select class="booking-select">${options}</select>
              <button type="button" class="btn danger booking-cancel-btn">Buchung absagen</button>
            </div>
          `;
        }

        const statusLabelMap = { DRAFT:'Entwurf', PUBLISHED:'Ver√∂ffentlicht', CANCELED:'Storniert', EXPIRED:'Abgelaufen' };
        const statusLabel = statusLabelMap[rawStatus] || (s.status || '');

        // ‚úÖ Anzeige-Ort robust (DB-Felder > location)
        const place = displayAddress(s);

        tr.innerHTML = `
          <td data-label="‚úì"><input type="checkbox" class="row-check" data-id="${s.id}"></td>
          <td data-label="Start">${fmtLocal(s.start_at)}</td>
          <td data-label="Ende">${fmtLocal(s.end_at)}</td>
          <td data-label="Titel">
            ${s.title}
            ${hintHtml.join('')}
          </td>
          <td data-label="Kategorie">${s.category||''}</td>
          <td data-label="Ort">${place || ''}</td>
          <td data-label="Kapazit√§t">${capacity}</td>
          <td data-label="Status"><span class="badge-st ${stClass}">${statusLabel}</span></td>
          <td data-label="Aktionen" class="nowrap">
            ${canPublish && !isArchived ? `<button class="btn action" data-arch="${s.id}" data-status="PUBLISHED">Ver√∂ffentlichen</button>` : ''}
            ${isPublished && !isArchived ? `<button class="btn" data-archive="${s.id}">Archivieren</button>` : ''}
            ${canEdit && !isArchived ? `<button class="btn" data-edit="${s.id}">Bearbeiten</button>` : ''}
            ${!isArchived ? `<button class="btn danger" data-del="${s.id}">L√∂schen</button>` : ''}
            ${isArchived ? `<span class="muted" style="font-size:12px">Archiviert</span>` : ''}
            ${cancelHtml}
          </td>
        `;
        tbody.appendChild(tr);
      }

      $$('#tbl-slots .row-check').forEach(cb => {
        cb.addEventListener('change', ()=>{
          const id = cb.dataset.id;
          if(cb.checked) SELECTED.add(id); else SELECTED.delete(id);
          updateBulkButtons(items);
        });
      });

      $$('#tbl-slots [data-del]').forEach(b =>
        b.addEventListener('click', async ()=>{
          await delSlot(b.dataset.del);
          await loadSlots();
        })
      );

      $$('#tbl-slots [data-arch]').forEach(b =>
        b.addEventListener('click', async ()=>{
          await setStatus(b.dataset.arch, b.dataset.status);
          await loadSlots();
        })
      );

      $$('#tbl-slots [data-archive]').forEach(b =>
        b.addEventListener('click', async ()=>{
          await archiveSlot(b.dataset.archive);
          await loadSlots();
        })
      );

      $$('#tbl-slots [data-edit]').forEach(b => {
        b.addEventListener('click', ()=>{
          const id = b.dataset.edit;
          const slot = items.find(x => x.id === id);
          if (slot) enterEditMode(slot);
        });
      });

      $$('#tbl-slots [data-cancel-booking]').forEach(btn => {
        btn.addEventListener('click', async ()=>{
          const bookingId = btn.dataset.cancelBooking;
          const label = btn.dataset.cancelLabel || '';
          await cancelBooking(bookingId, label);
        });
      });

      $$('#tbl-slots .booking-cancel-btn').forEach(btn => {
        btn.addEventListener('click', async ()=>{
          const wrap = btn.closest('.booking-cancel');
          if (!wrap) return;
          const sel = wrap.querySelector('.booking-select');
          if (!sel || !sel.value) return;
          const bookingId = sel.value;
          const label = sel.options[sel.selectedIndex].textContent;
          await cancelBooking(bookingId, label);
        });
      });

      const chkAll = $('#chk-all');
      if (chkAll) {
        chkAll.onchange = (e) => {
          SELECTED.clear();
          $$('#tbl-slots .row-check').forEach(cb => {
            cb.checked = e.target.checked;
            if(cb.checked) SELECTED.add(cb.dataset.id);
          });
          updateBulkButtons(items);
        };
      }

      updateBulkButtons(items);
    }

    let CURRENT_FILTER = 'active'; // 'active' oder 'archived'

    async function loadSlots(){
      hideSlotLimitAlert(); // ‚úÖ FIX: Alert nicht ‚Äûkleben" lassen
      const tbody = $('#tbl-slots tbody');
      tbody.innerHTML = `<tr><td colspan="9" class="muted">Lade ‚Ä¶</td></tr>`;
      SELECTED.clear();
      const master = $('#chk-all');
      if (master) master.checked = false;

      try{
        const url = CURRENT_FILTER === 'archived' 
          ? `${API}/slots?archived=true`
          : `${API}/slots?archived=false`;
        const r = await fetch(url, {credentials:'include'});
        if(!r.ok){
          tbody.innerHTML = `<tr><td colspan="9" class="muted">Bitte (erneut) anmelden.</td></tr>`;
          return;
        }
        LAST_ITEMS = await r.json();
        renderTable(LAST_ITEMS);
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Fehler beim Laden.</td></tr>`;
      }
    }

    async function archiveSlot(id){
      if(!confirm('Diesen Slot wirklich archivieren? Archivierte Termine k√∂nnen nicht mehr bearbeitet werden.')) return;
      try{
        const r = await fetch(`${API}/slots/${id}/archive`, {method:'POST', credentials:'include'});
        if(!r.ok){
          const data = await r.json().catch(() => ({}));
          showMsg('msg-slots', data.error ? `Konnte Slot nicht archivieren: ${data.error}` : 'Konnte Slot nicht archivieren.');
        } else {
          showMsg('msg-slots', 'Slot wurde archiviert.', true);
          await loadSlots();
        }
      }catch(e){
        showMsg('msg-slots','Netzwerkfehler.');
      }
    }

    const slotSearch = $('#slot-search');
    if (slotSearch) {
      slotSearch.addEventListener('input', ()=>{
        const q = slotSearch.value.trim().toLowerCase();
        if(!q) return renderTable(LAST_ITEMS);
        const filtered = LAST_ITEMS.filter(s =>
          (s.title||'').toLowerCase().includes(q) ||
          (s.category||'').toLowerCase().includes(q) ||
          (displayAddress(s)||'').toLowerCase().includes(q)
        );
        renderTable(filtered);
      });
    }

    async function delSlot(id){
      if(!confirm('Diesen Slot wirklich l√∂schen?')) return;
      try{
        const r = await fetch(`${API}/slots/${id}`, {method:'DELETE', credentials:'include'});
        if(!r.ok) showMsg('msg-slots','Konnte Slot nicht l√∂schen.');
      }catch(e){ showMsg('msg-slots','Netzwerkfehler.'); }
    }

    async function setStatus(id, status){
      try{
        const r = await fetch(`${API}/slots/${id}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({status})
        });
        let data = {};
        try { data = await r.json(); } catch(_) {}

        if(r.ok){
          hideSlotLimitAlert(); // ‚úÖ FIX
          return;
        }

        if (!r.ok){
          if (r.status === 409 && data.error === 'monthly_publish_limit_reached') {
            showSlotLimitAlert();
            showMsg('msg-slots','Slot-Limit f√ºr diesen Monat erreicht. Du kannst aktuell keine weiteren Slots ver√∂ffentlichen.');
          } else {
            showMsg('msg-slots','Konnte Status nicht √§ndern.');
          }
        }
      }catch(e){
        showMsg('msg-slots','Netzwerkfehler.');
      }
    }

    async function bulkSetStatus(ids, status){
      if(!ids.length) return;
      let limitHit = false;

      for (const id of ids){
        try{
          const r = await fetch(`${API}/slots/${id}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify({status})
          });
          let data = {};
          try { data = await r.json(); } catch(_) {}

          if (!r.ok){
            if (r.status === 409 && data.error === 'monthly_publish_limit_reached') {
              limitHit = true;
              break;
            }
          }
        }catch(e){
          showMsg('msg-slots','Netzwerkfehler.');
          break;
        }
      }

      if (limitHit){
        showSlotLimitAlert();
        showMsg('msg-slots','Slot-Limit f√ºr diesen Monat erreicht. Einige Slots konnten nicht mehr ver√∂ffentlicht werden.');
      } else {
        hideSlotLimitAlert(); // ‚úÖ FIX
      }
    }

    async function bulkDelete(ids){
      if(!ids.length) return;
      await Promise.all(ids.map(id =>
        fetch(`${API}/slots/${id}`, {method:'DELETE', credentials:'include'})
      ));
    }

    $('#btn-publish')?.addEventListener('click', async ()=>{
      const ids = [...SELECTED];
      await bulkSetStatus(ids, 'PUBLISHED');
      await loadSlots();
    });
    $('#btn-archive')?.addEventListener('click', async ()=>{
      const ids = [...SELECTED];
      await bulkSetStatus(ids, 'DRAFT');
      await loadSlots();
    });
    $('#btn-delete')?.addEventListener('click', async ()=>{
      const ids = [...SELECTED];
      if(!ids.length) return;
      if(!confirm(`Diese ${ids.length} Slot(s) wirklich l√∂schen?`)) return;
      await bulkDelete(ids);
      await loadSlots();
    });
    $('#btn-refresh')?.addEventListener('click', loadSlots);

    // Filter-Buttons f√ºr Aktive/Archivierte Termine
    const btnShowActive = $('#btn-show-active');
    const btnShowArchived = $('#btn-show-archived');
    
    if (btnShowActive) {
      btnShowActive.addEventListener('click', () => {
        CURRENT_FILTER = 'active';
        btnShowActive.classList.add('primary');
        if (btnShowArchived) btnShowArchived.classList.remove('primary');
        loadSlots();
      });
    }
    
    if (btnShowArchived) {
      btnShowArchived.addEventListener('click', () => {
        CURRENT_FILTER = 'archived';
        btnShowArchived.classList.add('primary');
        if (btnShowActive) btnShowActive.classList.remove('primary');
        loadSlots();
      });
    }

    // Initial: Aktive Termine anzeigen
    if (btnShowActive) btnShowActive.classList.add('primary');

    (async function init(){
      await requireAuth();
      fillCategoryOptions();
      recalcEnd();
      await loadSlots();
    })();
  </script>

  <!-- User-Men√º Logik -->
  <script>
    (function(){
      const API_LOCAL = (typeof window.API === 'string')
        ? window.API
        : (() => {
            const h = location.hostname;
            const proto = location.protocol;
            const isLocal =
              h === 'localhost' ||
              h === '127.0.0.1' ||
              /^192\.168\./.test(h) ||
              /^10\./.test(h) ||
              h.endsWith('.local');

            if (isLocal) return `${proto}//${h}:5000`;
            if (h === 'api.terminmarktplatz.de') return `${proto}//${h}`;
            return 'https://api.terminmarktplatz.de';
          })();

      const btn  = document.getElementById('userMenuBtn');
      const menu = document.getElementById('userMenu');
      if (!btn || !menu) return;

      function openMenu(open){
        menu.hidden = !open;
        btn.setAttribute('aria-expanded', String(open));
      }

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        openMenu(menu.hidden);
      });

      document.addEventListener('click', ()=> openMenu(false));
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') openMenu(false); });

      async function updateAuthUI(){
        let loggedIn = false;
        try{
          const res = await fetch(`${API_LOCAL}/me`, { credentials:'include' });
          loggedIn = res.ok;
        }catch(e){
          loggedIn = false;
        }

        document.querySelectorAll('.auth-in').forEach(el => { 
          // Admin-only Links werden separat von requireAuth() behandelt - hier √ºberspringen
          if (!el.classList.contains('admin-only')) {
            el.style.display = loggedIn ? '' : 'none';
          }
        });
        document.querySelectorAll('.auth-out').forEach(el => { el.style.display = loggedIn ? 'none' : ''; });
      }

      menu.addEventListener('click', async (e)=>{
        const el = e.target.closest('.item');
        if (!el) return;
        const action = el.dataset.action;

        if (action === 'logout'){
          try{ await fetch(`${API_LOCAL}/auth/logout`, { method:'POST', credentials:'include' }); }catch(_){}
          location.href = '/login.html';
        }

        if (action === 'delete'){
          const ok = confirm('Wirklich den gesamten Account mit allen Slots und Buchungen l√∂schen? Dieser Schritt ist endg√ºltig.');
          if (!ok) return;

          try{
            const res = await fetch(`${API_LOCAL}/me`, { method:'DELETE', credentials:'include' });
            if (res.ok){
              location.href = '/login.html?deleted=1';
            }else{
              const data = await res.json().catch(()=> ({}));
              alert(data?.error ? `L√∂schen fehlgeschlagen: ${data.error}` : 'L√∂schen fehlgeschlagen.');
            }
          }catch(err){
            alert('Netzwerkfehler ‚Äì bitte sp√§ter erneut versuchen.');
          }
        }
      });

      updateAuthUI();
    })();
  </script>

  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein">
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte L√∂sungen f√ºr deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">F√ºr Anbieter</a>
        <a class="foot-link" href="suchende.html">F√ºr Suchende</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">¬© <span id="y"></span> Terminmarktplatz ¬∑ Alle Rechte vorbehalten.</div>
    <script>document.getElementById('y').textContent=new Date().getFullYear();</script>
  </footer>

  <!-- Google Analytics - nur nach Consent laden -->
  <script>
    (function(){
      const cookieKey = 'tm_cookie_consent_v8';
      if (localStorage.getItem(cookieKey) === 'accepted') {
        const script1 = document.createElement('script');
        script1.async = true;
        script1.src = 'https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R';
        document.head.appendChild(script1);
        
        const script2 = document.createElement('script');
        script2.innerHTML = `
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YNZ8GW523R');
        `;
        document.head.appendChild(script2);
      }
    })();
  </script>
</body>
</html>
