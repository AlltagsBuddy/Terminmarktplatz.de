<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mein Portal â€“ Profil & Slots | Terminmarktplatz</title>
  <meta name="description" content="Anbieter-Portal: Profil pflegen, freie Zeitfenster/Slots anlegen, verwalten und verÃ¶ffentlichen." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/">

  <!-- OG/Twitter -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Anbieter-Portal | Terminmarktplatz"/>
  <meta property="og:image" content="static/og-cover.png"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R"></script>
  <script>
    window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-YNZ8GW523R');
  </script>

  <!-- Assets -->
  <link rel="icon" href="static/favicon.png"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="static/style.css?v=20251010"/>

  <style>
    .page-portal .panel{border-radius:var(--r-3xl); box-shadow:var(--shadow-2)}
    .grid{display:grid; gap:16px}
    @media(min-width:920px){ .grid-2{grid-template-columns:1fr 1fr} }

    /* ---------- Einheitliche, gut lesbare Buttons ---------- */
    :root{
      --btn-bg:#eef2f7;          /* heller Hintergrund */
      --btn-bg-hover:#e5eaf1;
      --btn-ink:#0b0f1a;         /* dunkle Schrift */
      --btn-border:#cfd7e3;
    }
    .btn, button.btn, a.btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--btn-border);
      background:var(--btn-bg); color:var(--btn-ink) !important; font-weight:800;
      box-shadow:var(--shadow-1); transition:transform .12s, filter .12s, background .12s;
      text-decoration:none; cursor:pointer;
    }
    .btn:hover{ background:var(--btn-bg-hover); transform:translateY(-1px); }
    .btn.primary{ background:var(--btn-bg); }
    .btn.action{ background:var(--btn-bg); }
    .btn.danger{ background:var(--btn-bg); }
    .seg .btn[disabled], .btn[disabled]{ opacity:.55; pointer-events:none; }

    /* Eingaben / Felder */
    .field{display:flex; flex-direction:column; gap:6px; background:rgba(255,255,255,.04);
      border:1px solid var(--border); border-radius:12px; padding:10px;}
    .field input,.field select,.field textarea{
      background:#fff; color:#0f172a; border:1px solid rgba(15,23,42,.28);
      border-radius:12px; padding:10px; box-shadow:inset 0 1px 0 rgba(0,0,0,.03);
    }
    .field input::placeholder,.field textarea::placeholder{ color:#64748b }
    .field input:focus,.field select:focus,.field textarea:focus{
      outline:none; border-color:#60a5fa; box-shadow:0 0 0 3px rgba(59,130,246,.25)
    }
    .req{ color:#ef4444; font-weight:700 }

    .muted{color:var(--ink-dim)}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    /* Tabelle */
    .table{width:100%; border-collapse:collapse; border:1px solid var(--border);
      border-radius:14px; overflow:hidden}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
    .table th{background:#f8fafc; color:#0f172a}
    .table th:first-child,.table td:first-child{ text-align:center; width:34px }

    .badge-st{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .st-pending{background:#fff7ed}
    .st-pub{background:#ecfeff}
    .st-arch{background:#f1f5f9}

    .msg{display:none; padding:10px; border-radius:12px; margin-top:8px}
    .msg.ok{display:block; background:#dcfce7; color:#065f46; border:1px solid #16a34a}
    .msg.err{display:block; background:#fee2e2; color:#7f1d1d; border:1px solid #ef4444}

    .seg{margin:4px 0 0; display:flex; gap:8px; flex-wrap:wrap}
    .seg .btn{padding:6px 10px}

    /* Buttons in der Tabelle â€“ auch hier dunkle Schrift + heller BG */
    .table .btn{ background:var(--btn-bg); color:var(--btn-ink) !important; border:1px solid var(--btn-border); }
    .table .btn:hover{ background:var(--btn-bg-hover); transform:translateY(-1px); }

    /* Sucheingabe oben der Tabelle */
    #slot-search{ padding:10px; border:1px solid var(--btn-border); border-radius:12px; background:#fff; color:#0f172a; }
  </style>
</head>
<body class="page-portal">

  <!-- Header -->
  <header>
    <div class="container nav">
      <a class="brand" href="index.html">
        <div class="brand-logo"><img src="static/terminmarktplatz-logo.png" alt="Logo" width="50" height="50"></div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>
      <nav class="nav-links">
        <a href="anbieter.html">FÃ¼r Anbieter</a>
        <a href="suchende.html">FÃ¼r Suchende</a>
        <a href="preise.html">Preise</a>
      </nav>
      <div class="cta-group">
        <button id="btn-logout" class="btn">Abmelden</button>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero" style="padding:36px 0 18px">
      <div class="container">
        <span class="badge">Anbieter-Portal</span>
        <h1>Willkommen! ðŸ‘‹</h1>
        <p class="lead">Pflege hier dein <strong>Profil</strong> und lege <strong>freie Slots</strong> an.
          Neue Slots starten als <em>â€žpending_reviewâ€œ</em>. Nach deiner BestÃ¤tigung werden sie verÃ¶ffentlicht.</p>
      </div>
    </section>

    <!-- CONTENT -->
    <section>
      <div class="container grid grid-2">

        <!-- Profil -->
        <div class="panel">
          <h2>Profil</h2>
          <p class="muted">Diese Daten sieht der/die Kund:in bei deinen Angeboten.</p>
          <form id="form-profile" class="grid">
            <div class="field">
              <label for="pf-company">Firma / Praxis / Studio <span class="req">*</span></label>
              <input id="pf-company" name="company_name" placeholder="z. B. Salon Mira" required/>
            </div>
            <div class="field">
              <label for="pf-branch">Branche <span class="req">*</span></label>
              <input id="pf-branch" name="branch" list="branch-list" placeholder="z. B. Friseur" required/>
              <datalist id="branch-list">
                <option>Friseur</option><option>Kosmetik</option><option>Physiotherapie</option>
                <option>Nagelstudio</option><option>Zahnarzt</option><option>Handwerk</option>
                <option>KFZ-Service</option><option>Fitness</option><option>Coaching</option>
                <option>Tierarzt</option><option>BehÃ¶rde</option><option>Sonstiges</option>
              </datalist>
            </div>
            <div class="field">
              <label for="pf-street">StraÃŸe & Nr.</label>
              <input id="pf-street" name="street" placeholder="MusterstraÃŸe 1"/>
            </div>
            <div class="field">
              <label for="pf-zip">PLZ <span class="req">*</span></label>
              <input id="pf-zip" name="zip" placeholder="12345" pattern="\d{5}" inputmode="numeric" required/>
            </div>
            <div class="field">
              <label for="pf-city">Ort <span class="req">*</span></label>
              <input id="pf-city" name="city" placeholder="Musterstadt" required/>
            </div>
            <div class="field">
              <label for="pf-phone">Telefon</label>
              <input id="pf-phone" name="phone" placeholder="+49 â€¦" pattern="^\+?[0-9\s\-\/]{6,}$"/>
            </div>
            <div class="field">
              <label for="pf-whatsapp">WhatsApp (optional)</label>
              <input id="pf-whatsapp" name="whatsapp" placeholder="+49 â€¦" pattern="^\+?[0-9\s\-\/]{6,}$"/>
            </div>
            <div class="toolbar">
              <button class="btn primary" type="submit">Profil speichern</button>
              <span class="muted">Tipp: Firma, Branche, PLZ & Ort ausfÃ¼llen.</span>
            </div>
            <div id="msg-profile" class="msg"></div>
          </form>
        </div>

        <!-- Slot anlegen -->
        <div class="panel">
          <h2>Neuen Slot anlegen</h2>
          <form id="form-slot" class="grid">
            <div class="field">
              <label for="sl-title">Titel <span class="req">*</span></label>
              <input id="sl-title" name="title" placeholder="z. B. Damenhaarschnitt" required/>
            </div>

            <div class="field">
              <label for="sl-cat">Kategorie <span class="req">*</span></label>
              <select id="sl-cat" name="category" required>
                <option value="" disabled selected>Bitte wÃ¤hlen â€¦</option>
              </select>
            </div>

            <div class="field">
              <label for="sl-date">Datum <span class="req">*</span></label>
              <input id="sl-date" type="date" required/>
            </div>
            <div class="field">
              <label for="sl-start">Start (Uhrzeit) <span class="req">*</span></label>
              <input id="sl-start" type="time" step="60" required/>
            </div>

            <!-- Dauer: Minuten ODER Stunden -->
            <div class="field">
              <label for="sl-duration">Dauer <span class="req">*</span></label>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <input id="sl-duration" type="number" min="1" step="1" value="30" required style="max-width:120px"/>
                <select id="sl-dur-unit" aria-label="Einheit">
                  <option value="min" selected>Minuten</option>
                  <option value="h">Stunden</option>
                </select>
                <div class="seg">
                  <button type="button" class="btn" data-unit="min" data-val="15">15 min</button>
                  <button type="button" class="btn" data-unit="min" data-val="30">30 min</button>
                  <button type="button" class="btn" data-unit="min" data-val="45">45 min</button>
                  <button type="button" class="btn" data-unit="min" data-val="60">60 min</button>
                  <button type="button" class="btn" data-unit="min" data-val="90">90 min</button>
                  <button type="button" class="btn" data-unit="h" data-val="2">2 h</button>
                  <button type="button" class="btn" data-unit="h" data-val="3">3 h</button>
                </div>
              </div>
            </div>

            <div class="field">
              <label for="sl-end">Ende (berechnet)</label>
              <input id="sl-end" type="time" readonly/>
            </div>

            <!-- WICHTIG: Ort / PLZ ist Pflicht -->
            <div class="field">
              <label for="sl-location">Ort / PLZ <span class="req">*</span></label>
              <input id="sl-location" name="location" placeholder="z. B. 96047 Bamberg oder 96047" required/>
            </div>

            <div class="field">
              <label for="sl-cap">KapazitÃ¤t</label>
              <input id="sl-cap" type="number" min="1" step="1" value="1"/>
            </div>
            <div class="field">
              <label for="sl-price">Preis (Euro, optional)</label>
              <input id="sl-price" type="number" min="0" step="1" placeholder="z. B. 49"/>
            </div>
            <div class="field" style="grid-column:1/-1">
              <label for="sl-notes">Notizen (intern)</label>
              <textarea id="sl-notes" rows="2" placeholder="optional"></textarea>
            </div>

            <div class="toolbar">
              <button class="btn primary" type="submit">Slot anlegen</button>
              <span class="muted">Status: <span class="badge-st st-pending">pending_review</span></span>
            </div>
            <div id="msg-slot" class="msg"></div>
          </form>
        </div>

        <!-- Meine Slots -->
        <div class="panel" style="grid-column:1/-1">
          <div class="toolbar" style="justify-content:space-between; gap:12px; flex-wrap:wrap">
            <h2 style="margin:0">Meine Slots</h2>

            <!-- Suche nach Titel oder Kategorie -->
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <input id="slot-search" placeholder="Titel oder Kategorie suchenâ€¦" style="min-width:220px"/>
              <label class="check">
                <input type="checkbox" id="chk-all"> Alle auswÃ¤hlen
              </label>
              <button class="btn action" id="btn-publish" disabled>VerÃ¶ffentlichen</button>
              <button class="btn" id="btn-archive" disabled>Archivieren</button>
              <button class="btn danger" id="btn-delete" disabled>LÃ¶schen</button>
              <button class="btn" id="btn-refresh">Aktualisieren</button>
            </div>
          </div>

          <div class="muted" style="margin:6px 0 12px">
            Hinweis: Neue Slots werden zunÃ¤chst als <em>â€žpending_reviewâ€œ</em> angelegt. Nach deiner BestÃ¤tigung werden sie verÃ¶ffentlicht.
          </div>

          <div class="table-wrap">
            <table class="table" id="tbl-slots">
              <thead>
                <tr>
                  <th>âœ“</th>
                  <th>Start</th>
                  <th>Ende</th>
                  <th>Titel</th>
                  <th>Kategorie</th>
                  <th class="nowrap">Ort / PLZ</th>
                  <th>Kap.</th>
                  <th>Status</th>
                  <th class="nowrap">Aktionen</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="9" class="muted">Lade â€¦</td></tr>
              </tbody>
            </table>
          </div>
          <div id="msg-slots" class="msg"></div>
        </div>

      </div>
    </section>
  </main>

  <script>
    const API = (()=> {
      const h = location.hostname;
      if (h === 'localhost' || h === '127.0.0.1') return 'http://127.0.0.1:5000';
      return 'https://api.terminmarktplatz.de';
    })();

    const $  = (q, root=document)=>root.querySelector(q);
    const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));

    function showMsg(id, text, ok=false){
      const el = document.getElementById(id);
      el.className = 'msg ' + (ok ? 'ok' : 'err');
      el.textContent = text; el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, ok ? 1800 : 4200);
    }

    function pad(n){ return n.toString().padStart(2,'0'); }
    function toLocalISO(dateLocal){ return new Date(dateLocal).toISOString(); }
    function joinDateTime(dateStr, timeStr){
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      return new Date(y, (m-1), d, hh, mm, 0, 0);
    }
    function fmtLocal(dtStr){
      const d = new Date(dtStr);
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    /* Kategorien */
    const CATEGORIES = [
      "Friseur","Kosmetik","Physiotherapie","Nagelstudio","Zahnarzt",
      "Handwerk","KFZ-Service","Fitness","Coaching","Tierarzt","BehÃ¶rde","Sonstiges"
    ];
    function fillCategoryOptions(){
      const sel = $('#sl-cat'); if(!sel) return;
      sel.innerHTML = `<option value="" disabled selected>Bitte wÃ¤hlen â€¦</option>`
        + CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    /* Auth + Profil laden */
    let ME = null;
    async function requireAuth(){
      const r = await fetch(`${API}/me`, {credentials:'include'});
      if(!r.ok){ location.href = 'login.html?tab=login'; return; }
      ME = await r.json();
      $('#pf-company').value = ME.company_name || '';
      $('#pf-branch').value  = ME.branch || '';
      $('#pf-street').value  = ME.street || '';
      $('#pf-zip').value     = ME.zip || '';
      $('#pf-city').value    = ME.city || '';
      $('#pf-phone').value   = ME.phone || '';
      $('#pf-whatsapp').value= ME.whatsapp || '';
    }

    /* Profil speichern */
    $('#form-profile').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        company_name: $('#pf-company').value.trim(),
        branch:       $('#pf-branch').value.trim(),
        street:       $('#pf-street').value.trim(),
        zip:          $('#pf-zip').value.trim(),
        city:         $('#pf-city').value.trim(),
        phone:        $('#pf-phone').value.trim(),
        whatsapp:     $('#pf-whatsapp').value.trim(),
      };
      try{
        const r = await fetch(`${API}/me`, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          credentials:'include', body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=> ({}));
        if(r.ok){ showMsg('msg-profile','Gespeichert âœ“', true); }
        else{
          const map = { unauthorized:'Bitte erneut anmelden.', invalid_zip:'PLZ muss 5-stellig sein.',
            db_constraint_error:'UngÃ¼ltige/fehlende Felder.', db_error:'Datenbankfehler.' };
          showMsg('msg-profile', map[data.error] || 'Konnte Profil nicht speichern.');
          if(r.status===401) location.href='login.html?tab=login';
        }
      }catch{ showMsg('msg-profile','Netzwerkfehler.'); }
    });

    /* Dauer â†’ Ende berechnen */
    function getDurationMinutes(){
      const val = parseFloat($('#sl-duration').value || '0');
      const unit = $('#sl-dur-unit').value; return (!val||val<=0)?0:(unit==='h'?Math.round(val*60):Math.round(val));
    }
    function recalcEnd(){
      const d=$('#sl-date').value, t=$('#sl-start').value, min=getDurationMinutes();
      if(!d||!t||!min){ $('#sl-end').value=''; return; }
      const start=joinDateTime(d,t); const end=new Date(start.getTime()+min*60000);
      $('#sl-end').value = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
    }
    $('#sl-date').addEventListener('change', recalcEnd);
    $('#sl-start').addEventListener('input', recalcEnd);
    $('#sl-duration').addEventListener('input', recalcEnd);
    $('#sl-dur-unit').addEventListener('change', recalcEnd);
    $$('#form-slot .seg [data-unit]').forEach(b=>b.addEventListener('click',()=>{
      $('#sl-dur-unit').value=b.dataset.unit; $('#sl-duration').value=b.dataset.val; recalcEnd();
    }));

    /* Slot-Liste */
    let SELECTED=new Set(), SLOT_CACHE=[], SLOT_FILTER="";
    function updateBulkButtons(items){
      const byId=Object.fromEntries(items.map(x=>[x.id,x])); const ids=[...SELECTED];
      const any=ids.length>0, anyPending=ids.some(id=>(byId[id]?.status==='pending_review'||byId[id]?.status==='archived'));
      const anyPub=ids.some(id=>byId[id]?.status==='published');
      $('#btn-publish').disabled=!(any&&anyPending);
      $('#btn-archive').disabled=!(any&&anyPub);
      $('#btn-delete').disabled=!any;
    }
    function renderSlots(items){
      const tbody=$('#tbl-slots tbody');
      const q=(SLOT_FILTER||'').trim().toLowerCase();
      const list= q? items.filter(s=>(s.title||'').toLowerCase().includes(q)||(s.category||'').toLowerCase().includes(q)) : items;

      if(!list.length){ tbody.innerHTML=`<tr><td colspan="9" class="muted">${items.length?`Keine Treffer fÃ¼r â€ž${SLOT_FILTER}â€œ.`: 'Noch keine Slots angelegt.'}</td></tr>`; return; }
      tbody.innerHTML='';

      for(const s of list){
        const isPending=s.status==='pending_review', isPublished=s.status==='published', isArchived=s.status==='archived';
        const stClass=isPublished?'st-pub':(isArchived?'st-arch':'st-pending');
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><input type="checkbox" class="row-check" data-id="${s.id}"></td>
          <td>${fmtLocal(s.start_at)}</td>
          <td>${fmtLocal(s.end_at)}</td>
          <td>${s.title}</td>
          <td>${s.category||''}</td>
          <td>${s.location||''}</td>
          <td>${s.capacity||1}</td>
          <td><span class="badge-st ${stClass}">${s.status}</span></td>
          <td class="nowrap">
            ${isPending||isArchived?`<button class="btn action" data-arch="${s.id}" data-status="published">VerÃ¶ffentlichen</button>`:''}
            ${isPublished?`<button class="btn" data-arch="${s.id}" data-status="archived">Archivieren</button>`:''}
            <button class="btn danger" data-del="${s.id}">LÃ¶schen</button>
          </td>`;
        tbody.appendChild(tr);
      }

      $$('#tbl-slots .row-check').forEach(cb=>{
        cb.addEventListener('change',()=>{ const id=cb.dataset.id; if(cb.checked)SELECTED.add(id); else SELECTED.delete(id); updateBulkButtons(items);});
      });
      $$('#tbl-slots [data-del]').forEach(b=>b.addEventListener('click',async()=>{await delSlot(b.dataset.del); await loadSlots();}));
      $$('#tbl-slots [data-arch]').forEach(b=>b.addEventListener('click',async()=>{await setStatus(b.dataset.arch,b.dataset.status); await loadSlots();}));
      $('#chk-all').onchange=(e)=>{ SELECTED.clear(); $$('#tbl-slots .row-check').forEach(cb=>{cb.checked=e.target.checked; if(cb.checked)SELECTED.add(cb.dataset.id);}); updateBulkButtons(items); };
      updateBulkButtons(items);
    }
    async function loadSlots(){
      const tbody=$('#tbl-slots tbody'); tbody.innerHTML=`<tr><td colspan="9" class="muted">Lade â€¦</td></tr>`;
      SELECTED.clear(); $('#chk-all').checked=false;
      try{
        const r=await fetch(`${API}/slots`,{credentials:'include'});
        if(!r.ok){ tbody.innerHTML=`<tr><td colspan="9" class="muted">Bitte (erneut) anmelden.</td></tr>`; return; }
        SLOT_CACHE=await r.json(); renderSlots(SLOT_CACHE);
      }catch{ tbody.innerHTML=`<tr><td colspan="9" class="muted">Fehler beim Laden.</td></tr>`; }
    }
    async function delSlot(id){
      if(!confirm('Diesen Slot wirklich lÃ¶schen?')) return;
      try{ const r=await fetch(`${API}/slots/${id}`,{method:'DELETE',credentials:'include'}); if(!r.ok) showMsg('msg-slots','Konnte Slot nicht lÃ¶schen.'); }
      catch{ showMsg('msg-slots','Netzwerkfehler.'); }
    }
    async function setStatus(id,status){
      try{
        const r=await fetch(`${API}/slots/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({status})});
        if(!r.ok) showMsg('msg-slots','Konnte Status nicht Ã¤ndern.');
      }catch{ showMsg('msg-slots','Netzwerkfehler.'); }
    }
    $('#btn-publish').addEventListener('click', async ()=>{ const ids=[...SELECTED]; await Promise.all(ids.map(id=>fetch(`${API}/slots/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({status:'published'})}))); await loadSlots(); });
    $('#btn-archive').addEventListener('click', async ()=>{ const ids=[...SELECTED]; await Promise.all(ids.map(id=>fetch(`${API}/slots/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({status:'archived'})}))); await loadSlots(); });
    $('#btn-delete').addEventListener('click', async ()=>{ const ids=[...SELECTED]; if(!ids.length) return; if(!confirm(`Diese ${ids.length} Slot(s) wirklich lÃ¶schen?`)) return; await Promise.all(ids.map(id=>fetch(`${API}/slots/${id}`,{method:'DELETE',credentials:'include'}))); await loadSlots(); });
    $('#btn-refresh').addEventListener('click', loadSlots);
    $('#slot-search').addEventListener('input', e=>{ SLOT_FILTER=e.target.value||''; renderSlots(SLOT_CACHE); });

    /* Slot anlegen */
    function validateRequiredLocation(){
      const loc=$('#sl-location').value.trim();
      if(!loc){ $('#sl-location').focus(); showMsg('msg-slot','Bitte â€žOrt / PLZâ€œ ausfÃ¼llen.'); return false; }
      return true;
    }
    $('#form-slot').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!validateRequiredLocation()) return;

      const date=$('#sl-date').value, time=$('#sl-start').value, durMin=getDurationMinutes();
      if(!date||!time||!durMin){ return showMsg('msg-slot','Bitte Datum, Start und Dauer angeben.'); }

      const startLocal=joinDateTime(date,time);
      const endLocal=new Date(startLocal.getTime()+durMin*60000);

      const payload={
        title:$('#sl-title').value.trim()||'Slot',
        category:$('#sl-cat').value.trim()||'Sonstiges',
        start_at:toLocalISO(startLocal),
        end_at:toLocalISO(endLocal),
        location:$('#sl-location').value.trim(), /* Pflicht */
        capacity:parseInt($('#sl-cap').value||'1',10),
        contact_method:'mail', booking_link:null,
        price_cents:$('#sl-price').value?Math.round(parseFloat($('#sl-price').value)*100):null,
        notes:$('#sl-notes').value.trim()||null
      };

      try{
        const r=await fetch(`${API}/slots`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});
        const data=await r.json().catch(()=>({}));
        if(r.ok){
          showMsg('msg-slot','Slot angelegt (wartet auf PrÃ¼fung) âœ“',true);
          e.target.reset(); $('#sl-dur-unit').value='min'; $('#sl-duration').value='30'; recalcEnd(); fillCategoryOptions(); await loadSlots();
        }else{
          const m={missing_fields:'Pflichtfelder fehlen.',bad_datetime:'Datum/Uhrzeit ungÃ¼ltig.',end_before_start:'Ende vor Start.',limit_reached:'Limit erreicht.',start_in_past:'Start liegt in der Vergangenheit.',bad_capacity:'KapazitÃ¤t ungÃ¼ltig.',db_constraint_error:'Kategorie nicht DB-konform.',db_error:'Datenbankfehler.'};
          showMsg('msg-slot', m[data.error] || `Konnte Slot nicht anlegen.${data.detail?' ('+data.detail+')':''}`);
        }
      }catch{ showMsg('msg-slot','Netzwerkfehler.'); }
    });

    /* Logout */
    $('#btn-logout').addEventListener('click', async ()=>{ try{ await fetch(`${API}/auth/logout`,{method:'POST',credentials:'include'});}catch{} location.href='login.html?tab=login'; });

    /* Init */
    (async function init(){ await requireAuth(); fillCategoryOptions(); recalcEnd(); await loadSlots(); })();
  </script>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein">
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte LÃ¶sungen fÃ¼r deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">FÃ¼r Anbieter</a>
        <a class="foot-link" href="suchende.html">FÃ¼r Suchende</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">Â© <span id="y"></span> Terminmarktplatz Â· Alle Rechte vorbehalten.</div>
    <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
  </footer>
</body>
</html>
