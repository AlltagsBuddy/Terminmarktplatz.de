<!-- FILE: portal.html -->
<!doctype html>
<html lang="de">
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YNZ8GW523R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YNZ8GW523R');
</script>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mein Portal â€“ Profil & Slots | Terminmarktplatz</title>
  <meta name="description" content="Anbieter-Portal: Profil pflegen, freie Zeitfenster/Slots anlegen, verwalten und archivieren." />
  <meta name="theme-color" content="#6f53ff" />
  <base href="/">

  <!-- OG/Twitter minimal -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Anbieter-Portal | Terminmarktplatz"/>
  <meta property="og:image" content="static/og-cover.png"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- Assets -->
  <link rel="icon" href="static/favicon.png"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="static/style.css?v=20251010"/>

  <style>
    .page-portal .panel{border-radius:var(--r-3xl); box-shadow:var(--shadow-2)}
    .grid{display:grid; gap:16px}
    @media(min-width: 920px){ .grid-2{grid-template-columns:1fr 1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .field input,.field select,.field textarea{
      border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; color:#0f172a
    }
    .muted{color:var(--ink-dim)}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .table{width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
    .table th{background:#f8fafc; color:#0f172a}
    .badge-st{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .st-pending{background:#fff7ed}
    .st-pub{background:#ecfeff}
    .st-arch{background:#f1f5f9}
    .msg{display:none; padding:10px; border-radius:12px; margin-top:8px}
    .msg.ok{display:block; background:#dcfce7; color:#065f46; border:1px solid #16a34a}
    .msg.err{display:block; background:#fee2e2; color:#7f1d1d; border:1px solid #ef4444}
    .seg{margin:4px 0 0; display:flex; gap:8px; flex-wrap:wrap}
    .seg .btn{padding:6px 10px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body class="page-portal">

  <!-- Header -->
  <header>
    <div class="container nav">
      <a class="brand" href="index.html">
        <div class="brand-logo"><img src="static/terminmarktplatz-logo.png" alt="Logo" width="50" height="50"></div>
        <div class="brand-title">Terminmarktplatz</div>
      </a>
      <nav class="nav-links">
        <a href="anbieter.html">FÃ¼r Anbieter</a>
        <a href="suchende.html">FÃ¼r Suchende</a>
        <a href="preise.html">Preise</a>
      </nav>
      <div class="cta-group">
        <button id="btn-logout" class="btn">Abmelden</button>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero" style="padding:36px 0 18px">
      <div class="container">
        <span class="badge">Anbieter-Portal</span>
        <h1>Willkommen! ðŸ‘‹</h1>
        <p class="lead">Pflege hier dein <strong>Profil</strong> und lege <strong>freie Slots</strong> in beliebiger LÃ¤nge an.
          Neue Slots laufen zunÃ¤chst auf <em>â€žPrÃ¼fungâ€œ</em> und kÃ¶nnen nach Freigabe verÃ¶ffentlicht werden.</p>
      </div>
    </section>

    <!-- CONTENT -->
    <section>
      <div class="container grid grid-2">

        <!-- Profil -->
        <div class="panel">
          <h2>Profil</h2>
          <p class="muted">Diese Daten sieht der/die Kund:in bei deinen Angeboten.</p>
          <form id="form-profile" class="grid">
            <div class="field">
              <label for="pf-company">Firma / Praxis / Studio</label>
              <input id="pf-company" name="company_name" placeholder="z. B. Salon Mira"/>
            </div>
            <div class="field">
              <label for="pf-branch">Branche</label>
              <input id="pf-branch" name="branch" list="branch-list" placeholder="z. B. Friseur"/>
              <datalist id="branch-list">
                <option>Friseur</option><option>Kosmetik</option><option>Physiotherapie</option>
                <option>Nagelstudio</option><option>Zahnarzt</option><option>Handwerk</option>
                <option>KFZ-Service</option><option>Fitness</option><option>Coaching</option>
                <option>Tierarzt</option><option>BehÃ¶rde</option><option>Sonstiges</option>
              </datalist>
            </div>
            <div class="field">
              <label for="pf-street">StraÃŸe & Nr.</label>
              <input id="pf-street" name="street" placeholder="MusterstraÃŸe 1"/>
            </div>
            <div class="field">
              <label for="pf-zip">PLZ</label>
              <input id="pf-zip" name="zip" placeholder="12345" pattern="\d{5}" inputmode="numeric"/>
            </div>
            <div class="field">
              <label for="pf-city">Ort</label>
              <input id="pf-city" name="city" placeholder="Musterstadt"/>
            </div>
            <div class="field">
              <label for="pf-phone">Telefon</label>
              <input id="pf-phone" name="phone" placeholder="+49 â€¦" pattern="^\+?[0-9\s\-\/]{6,}$"/>
            </div>
            <div class="field">
              <label for="pf-whatsapp">WhatsApp (optional)</label>
              <input id="pf-whatsapp" name="whatsapp" placeholder="+49 â€¦" pattern="^\+?[0-9\s\-\/]{6,}$"/>
            </div>
            <div class="toolbar">
              <button class="btn primary" type="submit">Profil speichern</button>
              <span class="muted">Tipp: Firma, Branche, PLZ & Ort ausfÃ¼llen.</span>
            </div>
            <div id="msg-profile" class="msg"></div>
          </form>
        </div>

        <!-- Slot anlegen -->
        <div class="panel">
          <h2>Neuen Slot anlegen</h2>
          <form id="form-slot" class="grid">
            <div class="field">
              <label for="sl-title">Titel</label>
              <input id="sl-title" name="title" placeholder="z. B. Damenhaarschnitt"/>
            </div>
            <div class="field">
              <label for="sl-cat">Kategorie</label>
              <input id="sl-cat" name="category" list="branch-list" placeholder="z. B. Friseur"/>
            </div>

            <div class="field">
              <label for="sl-date">Datum</label>
              <input id="sl-date" type="date"/>
            </div>
            <div class="field">
              <label for="sl-start">Start (Uhrzeit)</label>
              <input id="sl-start" type="time" step="60"/>
            </div>

            <div class="field">
              <label for="sl-duration">Dauer (Minuten)</label>
              <input id="sl-duration" type="number" min="5" step="5" value="30"/>
              <div class="seg">
                <button type="button" class="btn" data-min="15">15</button>
                <button type="button" class="btn" data-min="30">30</button>
                <button type="button" class="btn" data-min="45">45</button>
                <button type="button" class="btn" data-min="60">60</button>
                <button type="button" class="btn" data-min="90">90</button>
              </div>
            </div>
            <div class="field">
              <label for="sl-end">Ende (berechnet)</label>
              <input id="sl-end" type="time" readonly/>
            </div>

            <div class="field">
              <label for="sl-location">Ort / Raum</label>
              <input id="sl-location" name="location" placeholder="z. B. Filiale Zentrum"/>
            </div>
            <div class="field">
              <label for="sl-cap">KapazitÃ¤t</label>
              <input id="sl-cap" type="number" min="1" step="1" value="1"/>
            </div>
            <div class="field">
              <label for="sl-price">Preis (Euro, optional)</label>
              <input id="sl-price" type="number" min="0" step="1" placeholder="z. B. 49"/>
            </div>
            <div class="field" style="grid-column:1/-1">
              <label for="sl-notes">Notizen (intern)</label>
              <textarea id="sl-notes" rows="2" placeholder="optional"></textarea>
            </div>

            <div class="toolbar">
              <button class="btn primary" type="submit">Slot anlegen</button>
              <span class="muted">Status: <span class="badge-st st-pending">pending_review</span></span>
            </div>
            <div id="msg-slot" class="msg"></div>
          </form>
        </div>

        <!-- Slot-Liste -->
        <div class="panel" style="grid-column:1/-1">
          <div class="toolbar" style="justify-content:space-between">
            <h2 style="margin:0">Meine Slots</h2>
            <div>
              <button class="btn" id="btn-refresh">Aktualisieren</button>
            </div>
          </div>

          <div class="muted" style="margin:6px 0 12px">
            Hinweis: Neu angelegte Slots erscheinen hier und werden nach Freigabe verÃ¶ffentlicht.
          </div>

          <div class="table-wrap">
            <table class="table" id="tbl-slots">
              <thead>
                <tr>
                  <th>Start</th>
                  <th>Ende</th>
                  <th>Titel</th>
                  <th>Kategorie</th>
                  <th class="nowrap">Ort</th>
                  <th>Kap.</th>
                  <th>Status</th>
                  <th class="nowrap">Aktionen</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="8" class="muted">Lade â€¦</td></tr>
              </tbody>
            </table>
          </div>
          <div id="msg-slots" class="msg"></div>
        </div>

      </div>
    </section>
  </main>

  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo"><img src="static/terminmarktplatz-logo.png" alt="" /></div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte LÃ¶sungen fÃ¼r deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="wie-es-funktioniert.html">Wie es funktioniert</a>
        <a class="foot-link" href="preise.html">Preise</a>
        <a class="foot-link" href="anbieter.html">FÃ¼r Anbieter</a>
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
      </div>
    </div>
    <div class="container copyright">Â© <span id="y"></span> Terminmarktplatz</div>
  </footer>

  <script>
    // ---------- API-Basis ----------
    const API = (()=> {
      const h = location.hostname;
      if (h === 'localhost' || h === '127.0.0.1') return 'http://127.0.0.1:5000';
      return 'https://api.terminmarktplatz.de';
    })();

    const $ = (q, root=document)=>root.querySelector(q);
    const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));
    const y = new Date().getFullYear(); $('#y').textContent = y;

    function showMsg(id, text, ok=false){
      const el = document.getElementById(id);
      el.className = 'msg ' + (ok ? 'ok' : 'err');
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, ok ? 1800 : 3800);
    }

    function pad(n){ return n.toString().padStart(2,'0'); }
    function toLocalISO(dateLocal /* Date */){
      // Server erwartet ISO mit Zeitzone (UTC). datetime-local + new Date -> lokale Zeit.
      return new Date(dateLocal).toISOString();
    }
    function joinDateTime(dateStr, timeStr){
      // "2025-10-12" + "14:30" -> Date in lokaler Zeitzone
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      return new Date(y, (m-1), d, hh, mm, 0, 0);
    }
    function fmtLocal(dtStr){
      const d = new Date(dtStr);
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ---------- Auth-Gate / Me ----------
    let ME = null;
    async function requireAuth(){
      const r = await fetch(`${API}/me`, {credentials:'include'});
      if(!r.ok){ location.href = 'login.html?tab=login'; return; }
      ME = await r.json();
      // Profil befÃ¼llen:
      $('#pf-company').value = ME.company_name || '';
      $('#pf-branch').value = ME.branch || '';
      $('#pf-street').value = ME.street || '';
      $('#pf-zip').value = ME.zip || '';
      $('#pf-city').value = ME.city || '';
      $('#pf-phone').value = ME.phone || '';
      $('#pf-whatsapp').value = ME.whatsapp || '';
    }

    // ---------- Profil speichern ----------
    $('#form-profile').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        company_name: $('#pf-company').value.trim(),
        branch:       $('#pf-branch').value.trim(),
        street:       $('#pf-street').value.trim(),
        zip:          $('#pf-zip').value.trim(),
        city:         $('#pf-city').value.trim(),
        phone:        $('#pf-phone').value.trim(),
        whatsapp:     $('#pf-whatsapp').value.trim(),
      };
      try{
        const r = await fetch(`${API}/me`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        if(r.ok) showMsg('msg-profile','Gespeichert âœ“', true);
        else showMsg('msg-profile','Konnte Profil nicht speichern.');
      }catch(e){ showMsg('msg-profile','Netzwerkfehler.'); }
    });

    // ---------- Slot-Form: Dauer -> Ende berechnen ----------
    function recalcEnd(){
      const d = $('#sl-date').value, t = $('#sl-start').value, min = parseInt($('#sl-duration').value||'0',10);
      if(!d || !t || !min){ $('#sl-end').value=''; return; }
      const start = joinDateTime(d,t);
      const end = new Date(start.getTime() + min*60000);
      $('#sl-end').value = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
    }
    $('#sl-date').addEventListener('change', recalcEnd);
    $('#sl-start').addEventListener('input', recalcEnd);
    $('#sl-duration').addEventListener('input', recalcEnd);
    $$('#form-slot .seg [data-min]').forEach(b=>b.addEventListener('click', ()=>{
      $('#sl-duration').value = b.dataset.min; recalcEnd();
    }));

    // ---------- Slot anlegen ----------
    $('#form-slot').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const date = $('#sl-date').value, time = $('#sl-start').value, dur = parseInt($('#sl-duration').value||'0', 10);
      if(!date || !time || !dur){ return showMsg('msg-slot','Bitte Datum, Start und Dauer angeben.'); }
      const startLocal = joinDateTime(date,time);
      const endLocal = new Date(startLocal.getTime() + dur*60000);

      const payload = {
        title: $('#sl-title').value.trim() || 'Slot',
        category: $('#sl-cat').value.trim() || 'Sonstiges',
        start_at: toLocalISO(startLocal),
        end_at: toLocalISO(endLocal),
        location: $('#sl-location').value.trim() || null,
        capacity: parseInt($('#sl-cap').value || '1',10),
        contact_method: 'mail',
        booking_link: null,
        price_cents: $('#sl-price').value ? Math.round(parseFloat($('#sl-price').value)*100) : null,
        notes: $('#sl-notes').value.trim() || null
      };

      try{
        const r = await fetch(`${API}/slots`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=> ({}));
        if(r.ok){
          showMsg('msg-slot','Slot angelegt (wartet auf PrÃ¼fung) âœ“', true);
          e.target.reset();
          recalcEnd();
          await loadSlots();
        }else{
          const m = {
            missing_fields:'Pflichtfelder fehlen.',
            bad_datetime:'Datum/Uhrzeit ungÃ¼ltig.',
            end_before_start:'Ende liegt vor dem Start.',
            limit_reached:'Limit erreicht.'
          };
          showMsg('msg-slot', m[data.error] || 'Konnte Slot nicht anlegen.');
        }
      }catch(err){
        showMsg('msg-slot','Netzwerkfehler.');
      }
    });

    // ---------- Slots laden & rendern ----------
    async function loadSlots(){
      const tbody = $('#tbl-slots tbody');
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Lade â€¦</td></tr>`;
      try{
        const r = await fetch(`${API}/slots`, {credentials:'include'});
        if(!r.ok){ tbody.innerHTML = `<tr><td colspan="8" class="muted">Bitte (erneut) anmelden.</td></tr>`; return; }
        const items = await r.json();
        if(!items.length){ tbody.innerHTML = `<tr><td colspan="8" class="muted">Noch keine Slots angelegt.</td></tr>`; return; }

        tbody.innerHTML = '';
        for(const s of items){
          const tr = document.createElement('tr');
          const stClass = s.status==='published' ? 'st-pub' : (s.status==='archived' ? 'st-arch':'st-pending');
          tr.innerHTML = `
            <td>${fmtLocal(s.start_at)}</td>
            <td>${fmtLocal(s.end_at)}</td>
            <td>${s.title}</td>
            <td>${s.category||''}</td>
            <td>${s.location||''}</td>
            <td>${s.capacity||1}</td>
            <td><span class="badge-st ${stClass}">${s.status}</span></td>
            <td class="nowrap">
              <button class="btn" data-arch="${s.id}">Archivieren</button>
              <button class="btn" data-del="${s.id}">LÃ¶schen</button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        // Aktionen
        $$('#tbl-slots [data-del]').forEach(b=>b.addEventListener('click', ()=> delSlot(b.dataset.del)));
        $$('#tbl-slots [data-arch]').forEach(b=>b.addEventListener('click', ()=> setStatus(b.dataset.arch,'archived')));
      }catch(e){
        $('#tbl-slots tbody').innerHTML = `<tr><td colspan="8" class="muted">Fehler beim Laden.</td></tr>`;
      }
    }

    async function delSlot(id){
      if(!confirm('Diesen Slot wirklich lÃ¶schen?')) return;
      try{
        const r = await fetch(`${API}/slots/${id}`, {method:'DELETE', credentials:'include'});
        if(r.ok){ await loadSlots(); }
        else showMsg('msg-slots','Konnte Slot nicht lÃ¶schen.');
      }catch(e){ showMsg('msg-slots','Netzwerkfehler.'); }
    }
    async function setStatus(id, status){
      try{
        const r = await fetch(`${API}/slots/${id}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({status})
        });
        if(r.ok){ await loadSlots(); }
        else showMsg('msg-slots','Konnte Status nicht Ã¤ndern.');
      }catch(e){ showMsg('msg-slots','Netzwerkfehler.'); }
    }

    // ---------- Logout ----------
    $('#btn-logout').addEventListener('click', async ()=>{
      try{ await fetch(`${API}/auth/logout`, {method:'POST', credentials:'include'}); }catch(_){}
      location.href = 'login.html?tab=login';
    });

    // ---------- Init ----------
    (async function init(){
      await requireAuth();
      recalcEnd();
      await loadSlots();
    })();

    // Manuelles Refresh
    $('#btn-refresh').addEventListener('click', loadSlots);
  </script>

     <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <div class="brand-logo" aria-hidden="true">
            <img src="/static/terminmarktplatz-logo.png" alt="Terminmarktplatz Logo klein">
          </div>
          <div class="brand-title">Terminmarktplatz</div>
        </div>
        <p class="muted">Ein AlltagsBuddy-Projekt: smarte LÃ¶sungen fÃ¼r deinen Alltag.</p>
      </div>
      <div class="foot-col">
        <h4>Produkt</h4>
        <a class="foot-link" href="anbieter.html">FÃ¼r Anbieter</a>
        <a class="foot-link" href="suchende.html">FÃ¼r Suchende</a>
      
      </div>
      <div class="foot-col">
        <h4>Rechtliches</h4>
        <a class="foot-link" href="impressum.html">Impressum</a>
        <a class="foot-link" href="datenschutz.html">Datenschutz</a>
        <a class="foot-link" href="agb.html">AGB</a>
        <a class="foot-link" href="widerruf.html">Widerruf</a>
        
      </div>
      <div class="foot-col">
        <h4>Kontakt</h4>
        <a class="foot-link" href="kontakt.html">Kontaktformular</a>
        <a class="foot-link" href="mailto:info@terminmarktplatz.de">info@terminmarktplatz.de</a>
    
      </div>
    </div>
    <div class="container copyright">Â© <span id="y"></span> Terminmarktplatz Â· Alle Rechte vorbehalten.</div>
  </footer>
</body>
</html>
